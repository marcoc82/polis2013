<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Timer</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px; margin: 5px; }
        #timer-display { font-size: 2em; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Test Timer Restoration</h1>
    <div id="timer-display">18:00</div>
    <button onclick="saveGameState()">Save Game State</button>
    <button onclick="restoreGameState()">Restore Game State</button>
    <button onclick="clearLocalStorage()">Clear Storage</button>
    <p>Test the timer restoration functionality without authentication</p>
    
    <script>
        // Simplified version of timer variables
        let totalSeconds = 18 * 60;
        let isRunning = false;
        let timerStartTime = null;
        let pausedDuration = 0;
        let pauseStartTime = null;
        let lastSetSeconds = 18 * 60;
        
        function updateTimerDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function saveGameState() {
            const gameState = {
                timer: {
                    totalSeconds,
                    isRunning,
                    timerStartTime,
                    pausedDuration,
                    pauseStartTime,
                    lastSetSeconds,
                    saveTimestamp: Date.now(),
                    timerState: isRunning ? 'running' : (timerStartTime ? 'paused' : 'stopped')
                },
                savedAt: Date.now()
            };
            
            localStorage.setItem('polis_current_game_state', JSON.stringify(gameState));
            console.log('Game state saved:', gameState);
            alert('Game state saved!');
        }
        
        function restoreGameState() {
            const savedState = localStorage.getItem('polis_current_game_state');
            if (!savedState) {
                alert('No saved state found');
                return;
            }
            
            const gameState = JSON.parse(savedState);
            const timerData = gameState.timer;
            
            if (timerData) {
                totalSeconds = timerData.totalSeconds;
                lastSetSeconds = timerData.lastSetSeconds;
                
                if (timerData.timerState === 'running' && timerData.timerStartTime) {
                    const timeSinceReload = Date.now() - timerData.saveTimestamp;
                    timerStartTime = timerData.timerStartTime;
                    pausedDuration = timerData.pausedDuration || 0;
                    
                    const additionalElapsed = Math.floor(timeSinceReload / 1000);
                    const originalElapsed = Math.floor(((timerData.saveTimestamp - timerStartTime) - pausedDuration) / 1000);
                    const newElapsed = originalElapsed + additionalElapsed;
                    totalSeconds = Math.max(0, lastSetSeconds - newElapsed);
                    
                    console.log(`Timer was running: restored ${additionalElapsed}s during reload, new totalSeconds=${totalSeconds}`);
                } else if (timerData.timerState === 'paused') {
                    console.log('Timer was paused: state restored exactly');
                }
            }
            
            updateTimerDisplay();
            console.log('Game state restored:', gameState);
            alert('Game state restored! Check console for details.');
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('polis_current_game_state');
            alert('Local storage cleared');
        }
        
        // Initialize display
        updateTimerDisplay();
    </script>
</body>
</html>