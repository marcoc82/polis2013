<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Timer Restoration</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #1A202C; 
            color: white;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-green { background: #10b981; color: white; }
        .btn-gray { background: #6b7280; color: white; }
        .timer { font-size: 2em; margin: 20px 0; }
        .modal-overlay { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); 
            display: none; 
            align-items: center; 
            justify-content: center; 
        }
        .modal-overlay.is-active { display: flex; }
        .modal-content { 
            background: #334155; 
            padding: 30px; 
            border-radius: 8px; 
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Test Timer Restoration Logic</h1>
    
    <div class="timer" id="timer-display">18:00</div>
    
    <div>
        <button class="btn-green" onclick="startTimer()">Start Timer</button>
        <button class="btn-gray" onclick="saveState()">Save State</button>
        <button class="btn-gray" onclick="restoreState()">Restore State</button>
        <button class="btn-gray" onclick="clearState()">Clear State</button>
        <button class="btn-gray" onclick="resetTimer()">Reset Timer</button>
    </div>
    
    <div>
        <h3>Timer State:</h3>
        <p>Total Seconds: <span id="total-seconds">1080</span></p>
        <p>Last Set Seconds: <span id="last-set-seconds">1080</span></p>
        <p>Is Running: <span id="is-running">false</span></p>
        <p>Timer Start Time: <span id="timer-start-time">null</span></p>
        <p>Pause Start Time: <span id="pause-start-time">null</span></p>
        <p>Current Period: <span id="current-period">null</span></p>
    </div>
    
    <!-- Period selection modal -->
    <div id="period-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Select Period</h3>
            <p>This modal should NOT appear when resuming a saved timer!</p>
            <button onclick="selectPeriod(1)">1° Tempo</button>
            <button onclick="selectPeriod(2)">2° Tempo</button>
            <button onclick="hidePeriodModal()">Cancel</button>
        </div>
    </div>
    
    <script>
        // Timer variables (simplified version of the actual app)
        let totalSeconds = 18 * 60;
        let lastSetSeconds = 18 * 60;
        let isRunning = false;
        let timerStartTime = null;
        let pauseStartTime = null;
        let pausedDuration = 0;
        let currentPeriod = null;
        let timerInterval = null;
        
        function updateDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('total-seconds').textContent = totalSeconds;
            document.getElementById('last-set-seconds').textContent = lastSetSeconds;
            document.getElementById('is-running').textContent = isRunning;
            document.getElementById('timer-start-time').textContent = timerStartTime ? new Date(timerStartTime).toLocaleTimeString() : 'null';
            document.getElementById('pause-start-time').textContent = pauseStartTime ? new Date(pauseStartTime).toLocaleTimeString() : 'null';
            document.getElementById('current-period').textContent = currentPeriod || 'null';
        }
        
        // Fixed startTimer function with improved logic
        function startTimer() {
            if (isRunning) return;
            
            console.log('startTimer called with state:', {
                timerStartTime,
                pauseStartTime,
                totalSeconds,
                lastSetSeconds
            });
            
            // Check if this is a resume (timer was paused) or restart of existing game session
            if (timerStartTime && (pauseStartTime || totalSeconds < lastSetSeconds)) {
                console.log('Resuming existing timer session');
                
                // This is a resume or restart of existing session
                if (pauseStartTime) {
                    pausedDuration += (Date.now() - pauseStartTime);
                    pauseStartTime = null;
                }
                
                // Resume/restart the timer
                isRunning = true;
                
                // Update display every second
                timerInterval = setInterval(() => {
                    if (timerStartTime) {
                        const totalElapsedMs = (Date.now() - timerStartTime) - pausedDuration;
                        const elapsedSeconds = Math.floor(totalElapsedMs / 1000);
                        totalSeconds = Math.max(0, lastSetSeconds - elapsedSeconds);
                        updateDisplay();
                    }
                }, 1000);
                
                updateDisplay();
                alert('Timer resumed without period selection!');
            } else {
                console.log('Fresh start - showing period selection');
                // This is a fresh start: show period selection modal
                showPeriodSelectionModal();
            }
        }
        
        function showPeriodSelectionModal() {
            document.getElementById('period-selection-modal').classList.add('is-active');
        }
        
        function hidePeriodModal() {
            document.getElementById('period-selection-modal').classList.remove('is-active');
        }
        
        function selectPeriod(period) {
            currentPeriod = period;
            hidePeriodModal();
            
            // Start fresh timer
            timerStartTime = Date.now();
            pausedDuration = 0;
            pauseStartTime = null;
            isRunning = true;
            
            timerInterval = setInterval(() => {
                if (timerStartTime) {
                    const totalElapsedMs = (Date.now() - timerStartTime) - pausedDuration;
                    const elapsedSeconds = Math.floor(totalElapsedMs / 1000);
                    totalSeconds = Math.max(0, lastSetSeconds - elapsedSeconds);
                    updateDisplay();
                }
            }, 1000);
            
            updateDisplay();
            alert(`Started ${period}° tempo!`);
        }
        
        function saveState() {
            const gameState = {
                timer: {
                    totalSeconds,
                    isRunning,
                    timerStartTime,
                    pausedDuration,
                    pauseStartTime,
                    lastSetSeconds,
                    saveTimestamp: Date.now(),
                    timerState: isRunning ? 'running' : (timerStartTime ? 'paused' : 'stopped')
                },
                currentPeriod,
                savedAt: Date.now()
            };
            
            localStorage.setItem('test_timer_state', JSON.stringify(gameState));
            console.log('Saved state:', gameState);
            alert('Timer state saved!');
        }
        
        function restoreState() {
            const savedState = localStorage.getItem('test_timer_state');
            if (!savedState) {
                alert('No saved state found');
                return;
            }
            
            const gameState = JSON.parse(savedState);
            const timerData = gameState.timer;
            
            if (timerData) {
                totalSeconds = timerData.totalSeconds;
                lastSetSeconds = timerData.lastSetSeconds;
                currentPeriod = gameState.currentPeriod;
                
                console.log('Restoring timer state:', timerData.timerState);
                
                if (timerData.timerState === 'running' && timerData.timerStartTime) {
                    // Timer was running: calculate elapsed time during absence
                    const timeSinceReload = Date.now() - timerData.saveTimestamp;
                    timerStartTime = timerData.timerStartTime;
                    pausedDuration = timerData.pausedDuration || 0;
                    pauseStartTime = null; // Important: set to null for running state
                    
                    const additionalElapsed = Math.floor(timeSinceReload / 1000);
                    const originalElapsed = Math.floor(((timerData.saveTimestamp - timerStartTime) - pausedDuration) / 1000);
                    const newElapsed = originalElapsed + additionalElapsed;
                    totalSeconds = Math.max(0, lastSetSeconds - newElapsed);
                    isRunning = false; // Will be set to true when startTimer() is called
                    
                    console.log(`Timer was running: restored ${additionalElapsed}s during reload, new totalSeconds=${totalSeconds}`);
                } else if (timerData.timerState === 'paused') {
                    timerStartTime = timerData.timerStartTime;
                    pausedDuration = timerData.pausedDuration || 0;
                    pauseStartTime = timerData.pauseStartTime;
                    totalSeconds = timerData.totalSeconds;
                    isRunning = false;
                    
                    console.log('Timer was paused: state restored exactly');
                }
            }
            
            updateDisplay();
            alert('State restored! Now test startTimer() - it should NOT show period selection for existing game.');
        }
        
        function clearState() {
            localStorage.removeItem('test_timer_state');
            alert('Saved state cleared');
        }
        
        function resetTimer() {
            clearInterval(timerInterval);
            totalSeconds = 18 * 60;
            lastSetSeconds = 18 * 60;
            isRunning = false;
            timerStartTime = null;
            pauseStartTime = null;
            pausedDuration = 0;
            currentPeriod = null;
            updateDisplay();
        }
        
        // Initialize display
        updateDisplay();
    </script>
</body>
</html>