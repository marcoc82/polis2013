<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StaKick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module" src="./firebase-app-modular.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        /* CSS consolidato da entrambi i file */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: #1A202C; /* Sfondo scuro per un look moderno */
            color: #E2E8F0; /* Testo chiaro */
        }

        /* Schermate overlay */
        #loading-screen, #welcome-screen, #login-screen, #menu-screen, #players-management-screen, #main-app { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
        }
        
        #loading-screen, #welcome-screen, #login-screen, #menu-screen, #players-management-screen { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 999; 
            background: #1A202C; 
        }
        
        #main-app { 
            display: none; 
            z-index: 10;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Contenitore principale con stile aggiornato */
        .container {
            background: #2D3748; /* Contenitore leggermente più chiaro */
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5); /* Ombra più pronunciata per profondità */
            text-align: center;
            width: 90%;
            max-width: 900px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .polis-text {
            color: #4A90E2; /* Colore blu oceano per il titolo */
            margin-bottom: 5px;
            font-size: 9em; /* Aumentato il font-size del titolo */
            text-shadow: 0 0 5px white, 0 0 10px white, 0 0 15px white; /* Ombreggiatura bianca */
            line-height: 1; /* Riduci l'altezza della riga per centrare meglio */
        }
        
        .date-text {
            font-size: 1rem;
            text-align: center;
            color: #cbd5e0;
        }

        .date-display {
            text-align: center;
            font-size: 1rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        /* Stile per la schermata di benvenuto */
        #welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1A202C;
            z-index: 200;
        }
        .welcome-content {
            background-color: #2D3748;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            max-width: 450px;
            width: 90%;
        }

        /* Timer styles */
        .timer-container {
            background-color: #334155;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
        }
        .timer-display-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        #timer-display {
            font-size: 3rem;
            font-weight: 700;
            color: #4A90E2;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        #timer-display:hover {
            color: #60a5fa;
        }
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }

        /* Score display */
        .score-display {
            font-size: 6.5rem;
            font-weight: 700;
            color: #f1f5f9;
            margin: 2rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
        }
        .score-digit {
            transition: transform 0.2s ease-in-out;
        }
        .score-digit:hover {
            transform: scale(1.1);
        }

        /* Animazione per l'effetto di ingrandimento del punteggio */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(2.0); }
            100% { transform: scale(1); }
        }
        .score-digit.is-pulsing {
            animation: pulse 1s ease-in-out;
        }

        /* Teams container */
        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .team {
            background-color: #334155;
            padding: 1.5rem;
            border-radius: 1rem;
        }
        .team-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 1rem;
        }

        /* Button styles consolidati */
        .btn {
            color: white;
            font-weight: 600;
            padding: 0.75rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            border: none;
            font-size: 0.875rem; /* Reduced font size for better mobile fit */
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn-goal {
            background: linear-gradient(to right, #22c55e, #16a34a);
            padding: 0.875rem 1.5rem; /* Reduced padding for mobile */
            font-size: 0.8rem; /* Smaller font for goal buttons */
        }
        .btn-stats-add {
            background: linear-gradient(to right, #f97316, #ea580c);
            padding: 0.875rem 1.5rem; /* Match goal button padding */
            font-size: 0.8rem; /* Match goal button font size */
        }
        
        /* Enhanced styling for Corner, Tiri, and Falli buttons - same size as Goal buttons */
        .btn-corner {
            background: linear-gradient(to right, #fb923c, #f97316) !important;
            color: #fff !important;
            border: 2px solid #fb923c !important;
            font-size: 0.8rem !important;
            font-weight: 700 !important;
            padding: 0.875rem 1.5rem !important; /* Match goal button padding */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
        }
        .btn-corner:hover {
            background: linear-gradient(to right, #fdba74, #fb923c) !important;
            border-color: #fdba74 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 12px rgba(251, 146, 60, 0.4) !important;
        }
        
        .btn-tiri {
            background: linear-gradient(to right, #fb923c, #f97316) !important;
            color: #fff !important;
            border: 2px solid #fb923c !important;
            font-size: 0.8rem !important;
            font-weight: 700 !important;
            padding: 0.875rem 1.5rem !important; /* Match goal button padding */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
        }
        .btn-tiri:hover {
            background: linear-gradient(to right, #fdba74, #fb923c) !important;
            border-color: #fdba74 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 12px rgba(251, 146, 60, 0.4) !important;
        }
        
        .btn-falli {
            background: linear-gradient(to right, #fb923c, #f97316) !important;
            color: #fff !important;
            border: 2px solid #fb923c !important;
            font-size: 0.8rem !important;
            font-weight: 700 !important;
            padding: 0.875rem 1.5rem !important; /* Match goal button padding */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
        }
        .btn-falli:hover {
            background: linear-gradient(to right, #fdba74, #fb923c) !important;
            border-color: #fdba74 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 12px rgba(251, 146, 60, 0.4) !important;
        }
        /* Keep Corner, Tiri in porta and Falli buttons orange - remove red override */
        .btn-remove-goal {
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            height: 2.5rem; /* Reduced size */
            width: 2.5rem; /* Reduced size */
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
        }
        .btn-remove-goal:hover {
            background-color: #dc2626;
        }
        .btn-remove-stats {
            background-color: #ef4444;
            color: white;
            border-radius: 50%; /* Round like goal buttons */
            height: 2.5rem; /* Reduced size */
            width: 2.5rem; /* Reduced size */
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
        }
        .btn-remove-stats:hover {
            background-color: #dc2626;
        }

        /* Timer buttons */
        .btn-start { background-color: #10b981; }
        .btn-start:hover { background-color: #059669; }
        .btn-pause { background-color: #f59e0b; }
        .btn-pause:hover { background-color: #d97706; }
        .btn-reset-timer { background-color: #ef4444; }
        .btn-reset-timer:hover { background-color: #dc2626; }

        /* Large action buttons */
        .btn-reset {
            background-color: #dc2626;
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1rem 2rem;
        }
        .btn-reset:hover {
            background-color: #ef4444;
        }
        .btn-share {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1rem 2rem;
        }
        .btn-share:hover {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
        }
        .btn-save {
            background: linear-gradient(to right, #8b5cf6, #7c3aed);
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1rem 2rem;
        }
        .btn-save:hover {
            background: linear-gradient(to right, #7c3aed, #6d28d9);
        }
        .btn-history {
            background: linear-gradient(to right, #f97316, #ea580c);
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1rem 2rem;
        }
        .btn-history:hover {
            background: linear-gradient(to right, #ea580c, #c55d0a);
        }

        /* Green button for welcome */
        .btn-green {
            background-color: #48BB78;
            color: white;
        }
        .btn-green:hover {
            background-color: #38A169;
        }
        .btn-blue {
            background-color: #4A90E2;
            color: white;
        }
        .btn-blue:hover {
            background-color: #357ABD;
        }
        .btn-gray {
            background-color: #718096;
            color: white;
        }
        .btn-gray:hover {
            background-color: #4A5568;
        }
        .btn-large {
            padding: 16px 32px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 12px;
        }

        /* Stats container */
        .stats-container {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .stats-team {
            background-color: #334155;
            padding: 1rem;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 1.25rem;
            font-weight: 600;
            color: #e2e8f0;
        }

        /* Scorer list */
        .scorer-list {
            text-align: left;
            padding: 0.5rem 0 0 0;
            border-top: 1px solid #475569;
            margin-top: 1rem;
        }
        .scorer-list h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #a0aec0;
        }
        .scorer-list-item {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: #cbd5e1;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.is-active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1e293b;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .modal-overlay.is-active .modal-content {
            transform: scale(1);
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        .modal-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #475569;
            background-color: #334155;
            color: #f1f5f9;
            text-align: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        .modal-input:focus {
            outline: none;
            border-color: #60a5fa;
        }

        /* Player list */
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1.5rem;
        }
        .player-btn {
            background-color: #334155;
            color: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .player-btn:hover {
            background-color: #475569;
        }
        .player-btn:active {
            transform: scale(0.95);
        }

        /* Button grids */
        .button-grid-1 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        .button-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        .button-section {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        /* Coriandoli */
        .confetti {
            position: absolute;
            z-index: 1000;
            animation: fall 5s forwards;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotateZ(360deg);
                opacity: 0;
            }
        }

        /* Animazione timer */
        @keyframes timer-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .timer-running {
            animation: timer-pulse 1s ease-in-out infinite;
        }

        /* History styles */
        .history-list {
            list-style: none;
            padding: 0;
            text-align: left;
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1.5rem;
        }
        .history-item {
            background-color: #334155;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .history-date {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        /* Scorer ranking styles */
        .history-section {
            margin-bottom: 2rem;
        }
        .history-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #f1f5f9;
        }
        .scorers-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .scorers-table th, .scorers-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #475569;
        }
        .scorers-table th {
            color: #94a3b8;
            font-weight: 600;
        }
        .scorers-table tbody tr:last-child td {
            border-bottom: none;
        }
        .scorers-table tr:hover {
            background-color: #334155;
        }
        
        /* History modal specific styles */
        .history-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            flex: 1;
            overflow-y: auto;
            max-height: calc(90vh - 200px);
        }
        /* Special styling for history modal to allow larger width */
        #history-modal .modal-content {
            max-width: 90vw;
            width: 90%;
        }
        .modal-footer {
            flex-shrink: 0;
            padding-top: 1rem;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .teams-container {
                display: flex;
                flex-direction: row;
                gap: 0.75rem; /* Reduced gap */
            }
            .teams-container .team {
                flex: 1;
                min-width: 0;
                padding: 1rem; /* Reduced padding */
            }
            .stats-container {
                display: flex;
                flex-direction: row;
                gap: 0.75rem; /* Reduced gap */
            }
            .stats-container .stats-team {
                flex: 1;
                min-width: 0;
            }
            .score-display {
                font-size: 4rem;
            }
            .container {
                padding: 0.75rem; /* Reduced padding */
            }
            .polis-text {
                font-size: 4em;
            }
            
            /* Improved mobile button layout */
            .btn-goal {
                padding: 0.5rem 0.75rem; /* Even smaller on mobile */
                font-size: 0.7rem;
            }
            .btn-stats-add {
                padding: 0.5rem 0.75rem;
                font-size: 0.7rem;
            }
            .btn-remove-stats {
                height: 2rem;
                font-size: 0.7rem;
            }
            .btn-remove-goal {
                height: 2rem;
                width: 2rem;
                font-size: 0.8rem;
            }
            
            /* Fixed mobile layout for Corner, Tiri, and Falli buttons */
            .btn-corner,
            .btn-tiri,
            .btn-falli {
                padding: 0.5rem 0.6rem !important;
                font-size: 0.65rem !important;
            }
            
            /* Better grid spacing on mobile */
            .grid.grid-cols-3 {
                gap: 0.5rem; /* Reduced gap between goal buttons */
            }
            .button-grid-2 {
                gap: 0.5rem; /* Reduced gap between other buttons */
            }
            .button-section {
                margin-bottom: 1rem; /* Reduced margin */
            }
        }

        /* HR styles */
        hr {
            border-color: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Schermata di Loading -->
    <div id="loading-screen">
        <h2 style="color:#4A90E2;">Connessione al database...</h2>
        <pre id="loading-log" style="margin-top:20px; color: #E2E8F0; font-family: monospace; background: #2D3748; padding: 20px; border-radius: 12px;"></pre>
    </div>

    <!-- Schermata di login -->
    <div id="login-screen" style="display: none;">
        <div class="welcome-content">
            <h1 class="polis-text" style="font-size: 5em;">Polis 2013</h1>
            <hr class="my-6">
            <h2 class="text-2xl font-bold mb-4">Accesso</h2>
            <p class="mb-6">Inserisci il codice fornito dall'organizzatore per accedere all'app:</p>
            <input type="text" id="login-code-input" placeholder="Codice Accesso" class="w-full mb-4 modal-input">
            <div id="login-error" class="text-red-400 mb-4 hidden">Codice non valido</div>
            <button id="login-btn" class="btn-green btn-large w-full">Accedi</button>
        </div>
    </div>

    <!-- Schermata menu scelta -->
    <div id="menu-screen" style="display: none;">
        <div class="welcome-content">
            <h1 class="polis-text" style="font-size: 4em;">Polis 2013</h1>
            <hr class="my-6">
            <h2 id="menu-team-name" class="text-2xl font-bold mb-4">Benvenuto, POLIS!</h2>
            <p class="mb-6">Cosa vuoi fare?</p>
            <div class="button-grid-1 gap-4">
                <button id="start-match-btn" class="btn-green btn-large w-full">Inizia Partita</button>
                <button id="manage-players-btn" class="btn-blue btn-large w-full">Gestione Giocatori</button>
            </div>
        </div>
    </div>

    <!-- Schermata gestione giocatori -->
    <div id="players-management-screen" style="display: none;">
        <div class="welcome-content">
            <h1 class="polis-text" style="font-size: 3em;">Gestione Giocatori</h1>
            <hr class="my-6">
            <h2 id="players-team-name" class="text-xl font-bold mb-4">POLIS</h2>
            
            <div class="mb-4">
                <input type="text" id="new-player-input" placeholder="Aggiungi nuovo giocatore (es: 88 ROSSI MARIO)" class="w-full mb-2 modal-input">
                <button id="add-player-btn" class="btn-green w-full mb-4">Aggiungi Giocatore</button>
            </div>
            
            <div id="players-list" class="player-list mb-4" style="max-height: 50vh;">
                <!-- Lista giocatori verrà popolata dinamicamente -->
            </div>
            
            <div class="button-grid-2 gap-2">
                <button id="save-players-btn" class="btn-green">Salva Modifiche</button>
                <button id="back-to-menu-btn" class="btn-gray">Torna al Menu</button>
            </div>
        </div>
    </div>

    <!-- Schermata di benvenuto -->
    <div id="welcome-screen" style="display: none;">
        <div class="welcome-content">
            <h1 class="polis-text" style="font-size: 5em;">Polis 2013</h1>
            <hr class="my-6">
            <h2 class="text-2xl font-bold mb-4">Benvenuto!</h2>
            <p class="mb-6">Per iniziare, inserisci il nome della squadra avversaria, poi ricordati di far partire il tempo!</p>
            <input type="text" id="welcome-opponent-name" placeholder="Nome Squadra Avversaria" class="w-full mb-4 modal-input">
            <button id="start-game-btn" class="btn-green btn-large w-full">Inizia Partita</button>
        </div>
    </div>
    
    <!-- App principale -->
    <div id="main-app">
        <div class="container">
            <p id="current-date" class="date-display"></p>
            <h1 class="polis-text" style="font-size: 2.5rem;">POLIS 2013</h1>
            
            <!-- Sezione Timer -->
            <div class="timer-container">
                <div class="timer-display-container">
                    <span id="timer-display">18:00</span>
                    <button id="edit-timer-button" class="btn btn-start" style="padding: 0.5rem; font-size: 0.875rem;">Modifica</button>
                </div>
                <div class="timer-controls">
                    <button id="start-timer-button" class="btn btn-start">Avvia</button>
                    <button id="pause-timer-button" class="btn btn-pause">Pausa</button>
                    <button id="reset-timer-button" class="btn btn-reset-timer">Reset</button>
                </div>
            </div>
            
            <!-- Nomi delle squadre sopra il punteggio -->
            <div class="flex justify-between items-end mb-2">
                <h2 id="score-team1-name" class="text-3xl font-bold text-gray-200">POLIS</h2>
                <h2 id="score-team2-name" class="text-3xl font-bold text-gray-200">Squadra 2</h2>
            </div>

            <div class="score-display">
                <span id="score-team1" class="score-digit">0</span>
                <span>-</span>
                <span id="score-team2" class="score-digit">0</span>
            </div>

            <div class="teams-container">
                <!-- Squadra 1 -->
                <div class="team">
                    <h2 id="team1-title" class="team-title">POLIS</h2>
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-goal" data-team="1" data-quarter="1°T" data-type="goal" data-action="add">Gol 1°T</button>
                            <button class="btn btn-remove-goal mt-2" data-team="1" data-type="goal" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-goal" data-team="1" data-quarter="2°T" data-type="goal" data-action="add">Gol 2°T</button>
                            <button class="btn btn-remove-goal mt-2" data-team="1" data-type="goal" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-goal" data-team="1" data-quarter="3°T" data-type="goal" data-action="add">Gol 3°T</button>
                            <button class="btn btn-remove-goal mt-2" data-team="1" data-type="goal" data-action="remove">-</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-corner" data-team="1" data-type="corner" data-action="add">Corner</button>
                            <button class="btn btn-remove-stats mt-2" data-team="1" data-type="corner" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-tiri" data-team="1" data-type="shot" data-action="add">Tiro</button>
                            <button class="btn btn-remove-stats mt-2" data-team="1" data-type="shot" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-falli" data-team="1" data-type="foul" data-action="add">Fallo</button>
                            <button class="btn btn-remove-stats mt-2" data-team="1" data-type="foul" data-action="remove">-</button>
                        </div>
                    </div>
                </div>

                <!-- Squadra 2 -->
                <div class="team">
                    <h2 id="team2-name" class="team-title">Squadra 2</h2>
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-goal" data-team="2" data-quarter="1°T" data-type="goal" data-action="add">Gol 1°T</button>
                            <button class="btn btn-remove-goal mt-2" data-team="2" data-type="goal" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-goal" data-team="2" data-quarter="2°T" data-type="goal" data-action="add">Gol 2°T</button>
                            <button class="btn btn-remove-goal mt-2" data-team="2" data-type="goal" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-goal" data-team="2" data-quarter="3°T" data-type="goal" data-action="add">Gol 3°T</button>
                            <button class="btn btn-remove-goal mt-2" data-team="2" data-type="goal" data-action="remove">-</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-corner" data-team="2" data-type="corner" data-action="add">Corner</button>
                            <button class="btn btn-remove-stats mt-2" data-team="2" data-type="corner" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-tiri" data-team="2" data-type="shot" data-action="add">Tiro</button>
                            <button class="btn btn-remove-stats mt-2" data-team="2" data-type="shot" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-falli" data-team="2" data-type="foul" data-action="add">Fallo</button>
                            <button class="btn btn-remove-stats mt-2" data-team="2" data-type="foul" data-action="remove">-</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione Statistiche -->
            <div class="stats-container">
                <!-- Statistiche Squadra 1 -->
                <div class="stats-team">
                    <h3 id="stats-team1-title" class="team-title">Statistiche POLIS</h3>
                    <div class="stat-item">
                        <span>Gol fatti</span>
                        <span id="goals-team1">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Gol subiti</span>
                        <span id="goals-team2-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Tiri in porta</span>
                        <span id="shots-team1">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Tiri subiti</span>
                        <span id="shots-team2-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Corner</span>
                        <span id="corners-team1">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Corner subiti</span>
                        <span id="corners-team2-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Falli</span>
                        <span id="fouls-team1">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Falli subiti</span>
                        <span id="fouls-team2-taken">0</span>
                    </div>
                    <div id="scorers-list-1" class="scorer-list">
                        <h4>Marcatori:</h4>
                    </div>
                </div>

                <!-- Statistiche Squadra 2 -->
                <div class="stats-team">
                    <h3 class="team-title" id="stats-team2-title">Statistiche Squadra 2</h3>
                    <div class="stat-item">
                        <span>Gol fatti</span>
                        <span id="goals-team2">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Gol subiti</span>
                        <span id="goals-team1-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Tiri in porta</span>
                        <span id="shots-team2">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Tiri subiti</span>
                        <span id="shots-team1-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Corner</span>
                        <span id="corners-team2">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Corner subiti</span>
                        <span id="corners-team1-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Falli</span>
                        <span id="fouls-team2">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Falli subiti</span>
                        <span id="fouls-team1-taken">0</span>
                    </div>
                    <div id="scorers-list-2" class="scorer-list">
                        <h4>Marcatori:</h4>
                    </div>
                </div>
            </div>
            
            <!-- Pulsanti di azione -->
            <div class="flex justify-center items-center mt-8 gap-4 flex-wrap">
                <button id="reset-button" class="btn btn-reset flex items-center justify-center gap-2">RESET</button>
                <button id="save-button" class="btn btn-save flex items-center justify-center">Salva</button>
                <button id="share-button" class="btn btn-share flex items-center justify-center">Condividi</button>
                <button id="show-history-button" class="btn btn-history flex items-center justify-center gap-2">STORICO</button>
            </div>
        </div>
    </div>

    <!-- All modals here -->
    <!-- Player selection modal -->
    <div id="player-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Chi ha segnato?</div>
            <div id="player-list" class="player-list">
                <!-- Player buttons will be added here via JavaScript -->
            </div>
            <button id="cancel-player-selection-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
        </div>
    </div>

    <!-- Remove confirmation modal -->
    <div id="remove-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="remove-modal-header"></div>
            <p class="text-gray-400 mb-6" id="remove-modal-message"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-remove-button" class="btn btn-reset px-8">Sì, Rimuovi</button>
                <button id="cancel-remove-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Reset confirmation modal -->
    <div id="reset-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Sei sicuro di voler resettare?</div>
            <p class="text-gray-400 mb-6">Tutti i dati della partita andranno persi.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-reset-button" class="btn btn-reset px-8">Sì, Reset</button>
                <button id="cancel-reset-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Timer setup modal -->
    <div id="timer-setup-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Imposta il tempo</div>
            <div class="flex justify-center gap-2 mb-4">
                <input type="number" id="timer-minutes-input" class="modal-input w-20" value="18" min="0" max="99">
                <span class="text-xl font-bold">:</span>
                <input type="number" id="timer-seconds-input" class="modal-input w-20" value="0" min="0" max="59">
            </div>
            <p class="text-gray-400 mb-6">Minuti e Secondi</p>
            <button id="set-timer-button" class="btn btn-goal px-8">Imposta</button>
        </div>
    </div>

    <!-- History modal -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content max-w-4xl">
            <div class="modal-header">Storico Partite</div>
            <div class="history-content">
                <!-- Sezione Riepilogo Statistiche Totali -->
                <div class="history-section">
                   <!--<h3 class="history-section-title">Riepilogo Statistiche Totali</h3> -->
                    <div>
                        <span>Partite giocate totali: <span id="total-matches-played">0</span></span>
                    </div>
                </div>

                <!-- Sezione Classifica Marcatori -->
                <div class="history-section">
                    <h3 class="history-section-title">Classifica Marcatori</h3>
                    <table class="scorers-table">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Giocatore</th>
                                <th>Gol</th>
                            </tr>
                        </thead>
                        <tbody id="scorers-table-body">
                            <!-- La tabella verrà popolata da JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Sezione Riepilogo Statistiche -->
                <div class="history-section">
                    <h3 class="history-section-title">Riepilogo Statistiche Totali</h3>
                    <table class="scorers-table">
                        <thead>
                            <tr>
                                <th>Statistica</th>
                                <th>Fatti</th>
                                <th>Subiti</th>
                            </tr>
                        </thead>
                        <tbody id="summary-stats-table-body">
                            <tr>
                                <td>Gol</td>
                                <td id="total-goals-made">0</td>
                                <td id="total-goals-conceded">0</td>
                            </tr>
                            <tr>
                                <td>Tiri</td>
                                <td id="total-shots-made">0</td>
                                <td id="total-shots-conceded">0</td>
                            </tr>
                            <tr>
                                <td>Corner</td>
                                <td id="total-corners-made">0</td>
                                <td id="total-corners-conceded">0</td>
                            </tr>
                            <tr>
                                <td>Falli</td>
                                <td id="total-fouls-made">0</td>
                                <td id="total-fouls-conceded">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Sezione Storico Partite -->
                <div class="history-section">
                    <h3 class="history-section-title">Partite Giocate</h3>
                    <div id="history-list" class="history-list">
                        <!-- History items will be added here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-history-button" class="btn btn-goal mt-4 px-8">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Delete match confirmation modal -->
    <div id="delete-match-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Elimina Partita</div>
            <p class="text-gray-400 mb-6">Sei sicuro di voler eliminare questa partita dallo storico?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-delete-match-button" class="btn btn-reset px-8">Sì, Elimina</button>
                <button id="cancel-delete-match-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let scoreTeam1 = 0;
        let scoreTeam2 = 0;
        let shotsTeam1 = 0;
        let cornersTeam1 = 0;
        let foulsTeam1 = 0;
        let shotsTeam2 = 0;
        let cornersTeam2 = 0;
        let foulsTeam2 = 0;
        let team1Scorers = [];
        let team2Scorers = [];
        let pendingRemovalAction = null;
        let totalSeconds = 18 * 60;
        let timerInterval = null;
        let isRunning = false;
        let lastSetSeconds = 18 * 60;

        // History variables
        let matchHistory = [];
        let historyListener = null;
        let pendingDeleteMatchId = null;

        // Screen wake lock
        let wakeLock = null;

        // Vibration/Haptic feedback function
        function vibrate(pattern = [100]) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Request wake lock to keep screen on
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen wake lock is active');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Screen wake lock was released');
                    });
                }
            } catch (err) {
                console.error('Failed to request screen wake lock:', err);
            }
        }

        // Release wake lock
        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // Current club data
        let currentClub = null;
        let currentPlayers = [];

        // Player list from original (fallback)
        const defaultPlayers = [
            "99 ALPA FEDERICO", "78 BECCARIS SEBASTIANO", "32 BEN MABROUK KEVIN", "23 BERLUSCONI NOAH",
            "1 BERNUCCI ROMEO", "18 BOERO GUGLIELMO", "22 BRIANO COSTANTINO", "28 CABASSI ROBERTO",
            "7 CALLIKU ANDREA", "4 CAZZULO MICHELE", "46 CONGIU ALESSIO", "20 DHAOUI OMAR",
            "5 DI DATO SIMONE", "77 DONALD BRYAN", "6 ESPOSITO EMANUELE", "25 GARDELLA ANDREA",
            "13 GENNARO EDOARDO", "91 GIOIA LEONARDO", "17 KHAY ADAM", "2 LAMKHAYAR AMIN",
            "29 LANNA MARK", "19 MARCHESE MATTEO", "47 MELLO CHRISTIAN", "61 MELLUSO MATTIA",
            "14 MONTEFIORI EDOARDO", "3 ODAGLIA ANDREA", "11 PELLICCI FRANCESCO", "90 PIGA GIOVANNI",
            "45 PINASCO ALESSANDRO", "10 POLLIO CESARE", "9 SCALA FEDERICO", "16 STANCHI FEDERICO",
            "21 TONINI LORENZO"
        ];

        // Current players array (will be updated based on club)
        let players = [...defaultPlayers];

        // DOM elements
        const loadingScreen = document.getElementById('loading-screen');
        const loginScreen = document.getElementById('login-screen');
        const menuScreen = document.getElementById('menu-screen');
        const playersManagementScreen = document.getElementById('players-management-screen');
        const welcomeScreen = document.getElementById('welcome-screen');
        const mainApp = document.getElementById('main-app');
        const startGameBtn = document.getElementById('start-game-btn');
        const welcomeOpponentName = document.getElementById('welcome-opponent-name');

        // Function to be called when Firebase is ready
        window.onFirebaseReady = function() {
            console.log('Firebase is ready, transitioning to login screen');
            loadingScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            
            // Crea società esempio se necessario (solo per testing)
            // window.creaSocietaEsempio();
        };

        // Start game function
        function startGame() {
            const opponentName = welcomeOpponentName.value.trim().toUpperCase() || 'SQUADRA 2';
            
            // Update opponent names in the interface
            document.getElementById('score-team2-name').textContent = opponentName;
            document.getElementById('team2-name').textContent = opponentName;
            document.getElementById('stats-team2-title').textContent = 'Statistiche ' + opponentName;

            // Update team 1 name if we have a club
            if (currentClub) {
                document.getElementById('score-team1-name').textContent = currentClub.nome;
                document.getElementById('team1-title').textContent = currentClub.nome;
                document.getElementById('stats-team1-title').textContent = 'Statistiche ' + currentClub.nome;
            }

            // Hide welcome screen and show main app
            welcomeScreen.style.display = 'none';
            mainApp.style.display = 'block';
            
            // Request wake lock to keep screen on
            requestWakeLock();
            
            // Setup Firebase history listener
            setupFirebaseHistoryListener();
            
            // Initialize the app
            setDate();
            updateScores();
            updateTimerDisplay();
            
            // Add vibration feedback
            vibrate([50]);
        }

        // Login function
        async function handleLogin() {
            const code = document.getElementById('login-code-input').value.trim();
            const errorDiv = document.getElementById('login-error');
            
            if (!code) {
                errorDiv.textContent = 'Inserisci un codice';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                const result = await window.verificaCodice(code);
                
                if (result.success) {
                    currentClub = result.societa;
                    currentPlayers = [...(result.societa.giocatori || defaultPlayers)];
                    players = [...currentPlayers];
                    
                    // Update team names
                    document.getElementById('menu-team-name').textContent = `Benvenuto, ${currentClub.nome}!`;
                    document.getElementById('players-team-name').textContent = currentClub.nome;
                    
                    // Setup Firebase history listener for this team
                    setupFirebaseHistoryListener();
                    
                    // Hide login and show menu
                    loginScreen.style.display = 'none';
                    menuScreen.style.display = 'flex';
                    
                    errorDiv.classList.add('hidden');
                    vibrate([50]);
                } else {
                    errorDiv.textContent = result.message || 'Codice non valido';
                    errorDiv.classList.remove('hidden');
                    vibrate([200]);
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Errore di connessione';
                errorDiv.classList.remove('hidden');
                vibrate([200]);
            }
        }

        // Show match setup (welcome screen)
        function showMatchSetup() {
            menuScreen.style.display = 'none';
            welcomeScreen.style.display = 'flex';
            
            // Update team name in welcome screen if needed
            if (currentClub) {
                // No need to change anything, POLIS is hardcoded in the main interface
            }
        }

        // Show players management
        function showPlayersManagement() {
            menuScreen.style.display = 'none';
            playersManagementScreen.style.display = 'flex';
            
            updatePlayersListUI();
        }

        // Update players list UI
        function updatePlayersListUI() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';
            
            currentPlayers.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center justify-between bg-gray-700 p-3 rounded';
                playerDiv.innerHTML = `
                    <span class="text-white">${player}</span>
                    <button onclick="removePlayer(${index})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                        Rimuovi
                    </button>
                `;
                playersList.appendChild(playerDiv);
            });
        }

        // Add new player
        function addPlayer() {
            const input = document.getElementById('new-player-input');
            const newPlayer = input.value.trim();
            
            if (newPlayer) {
                currentPlayers.push(newPlayer);
                input.value = '';
                updatePlayersListUI();
                vibrate([50]);
            }
        }

        // Remove player
        function removePlayer(index) {
            currentPlayers.splice(index, 1);
            updatePlayersListUI();
            vibrate([100]);
        }

        // Save players changes
        async function savePlayersChanges() {
            if (!currentClub) return;
            
            try {
                const result = await window.aggiornaGiocatoriSocieta(currentClub.id, currentPlayers);
                
                if (result.success) {
                    // Update global players array
                    players = [...currentPlayers];
                    alert('Giocatori salvati con successo!');
                    vibrate([100, 50, 100]);
                } else {
                    alert('Errore nel salvataggio: ' + (result.message || 'Errore sconosciuto'));
                    vibrate([200]);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Errore di connessione durante il salvataggio');
                vibrate([200]);
            }
        }

        // Back to menu
        function backToMenu() {
            playersManagementScreen.style.display = 'none';
            menuScreen.style.display = 'flex';
        }

        // Set current date
        function setDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = today.toLocaleDateString('it-IT', options);
        }

        // Update scores
        function updateScores() {
            document.getElementById('score-team1').textContent = scoreTeam1;
            document.getElementById('score-team2').textContent = scoreTeam2;
            updateStats();
        }

        // Update stats
        function updateStats() {
            document.getElementById('goals-team1').textContent = scoreTeam1;
            document.getElementById('goals-team2-taken').textContent = scoreTeam2;
            document.getElementById('shots-team1').textContent = shotsTeam1;
            document.getElementById('shots-team2-taken').textContent = shotsTeam2;
            document.getElementById('corners-team1').textContent = cornersTeam1;
            document.getElementById('corners-team2-taken').textContent = cornersTeam2;
            document.getElementById('fouls-team1').textContent = foulsTeam1;
            document.getElementById('fouls-team2-taken').textContent = foulsTeam2;
            
            document.getElementById('goals-team2').textContent = scoreTeam2;
            document.getElementById('goals-team1-taken').textContent = scoreTeam1;
            document.getElementById('shots-team2').textContent = shotsTeam2;
            document.getElementById('shots-team1-taken').textContent = shotsTeam1;
            document.getElementById('corners-team2').textContent = cornersTeam2;
            document.getElementById('corners-team1-taken').textContent = cornersTeam1;
            document.getElementById('fouls-team2').textContent = foulsTeam2;
            document.getElementById('fouls-team1-taken').textContent = foulsTeam1;
        }

        // Timer functions
        function updateTimerDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = formattedTime;

            if (totalSeconds <= 0) {
                clearInterval(timerInterval);
                isRunning = false;
                document.getElementById('timer-display').classList.remove('timer-running');
                document.getElementById('timer-display').textContent = "00:00";
                vibrate([5000]); // 5 second vibration when timer reaches zero
            }
        }

        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('timer-display').classList.add('timer-running');
            timerInterval = setInterval(() => {
                totalSeconds--;
                updateTimerDisplay();
            }, 1000);
            vibrate([100]); // Start timer feedback
        }

        function pauseTimer() {
            if (!isRunning) return;
            isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('timer-display').classList.remove('timer-running');
            vibrate([50]); // Pause timer feedback
        }

        function resetTimer() {
            pauseTimer();
            totalSeconds = lastSetSeconds;
            updateTimerDisplay();
            vibrate([50, 50]); // Reset timer feedback
        }

        // Player modal functions
        function showPlayerModal(quarter) {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            players.forEach(player => {
                const playerButton = document.createElement('button');
                playerButton.textContent = player;
                playerButton.classList.add('player-btn');
                playerButton.addEventListener('click', () => {
                    addGoalTeam1(player, quarter);
                    hidePlayerModal();
                });
                playerList.appendChild(playerButton);
            });
            document.getElementById('player-modal').classList.add('is-active');
            vibrate([50]); // Modal open feedback
        }

        function hidePlayerModal() {
            document.getElementById('player-modal').classList.remove('is-active');
            vibrate([30]); // Modal close feedback
        }

        // Goal functions
        function addGoalTeam1(player, quarter) {
            scoreTeam1++;
            
            // Calculate minutes elapsed since timer started
            const elapsedSeconds = (lastSetSeconds - totalSeconds);
            const minute = Math.floor(elapsedSeconds / 60) + 1; // Add 1 so first minute shows as "1" instead of "0"
            
            const newScorer = document.createElement('div');
            newScorer.classList.add('scorer-list-item');
            newScorer.textContent = `${player} - ${minute}' (${quarter})`;
            document.getElementById('scorers-list-1').appendChild(newScorer);
            team1Scorers.push({ player: player, quarter: quarter, minute: minute });

            document.getElementById('score-team1').classList.add('is-pulsing');
            setTimeout(() => {
                document.getElementById('score-team1').classList.remove('is-pulsing');
            }, 1000);
            createConfetti();
            updateScores();
            
            // Special vibration pattern for goals
            vibrate([150, 100, 150, 100, 150]);
        }

        function addGoalTeam2(quarter) {
            scoreTeam2++;
            
            // Calculate minutes elapsed since timer started
            const elapsedSeconds = (lastSetSeconds - totalSeconds);
            const minute = Math.floor(elapsedSeconds / 60) + 1; // Add 1 so first minute shows as "1" instead of "0"
            
            const newScorer = document.createElement('div');
            newScorer.classList.add('scorer-list-item');
            newScorer.textContent = `Goal - ${minute}' (${quarter})`;
            document.getElementById('scorers-list-2').appendChild(newScorer);
            team2Scorers.push({ player: 'Sconosciuto', quarter: quarter, minute: minute });
            updateScores();
            
            // Special vibration pattern for goals
            vibrate([150, 100, 150, 100, 150]);
        }

        // Confetti function
        function createConfetti() {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -20}vh`;
                confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                document.body.appendChild(confetti);

                setTimeout(() => {
                    confetti.remove();
                }, parseFloat(confetti.style.animationDuration) * 1000);
            }
        }

        // Remove confirmation modal functions
        function showRemoveModal(type, team) {
            let text = '';
            if (type === 'goal') {
                text = 'un goal';
            } else if (type === 'corner') {
                text = 'un corner';
            } else if (type === 'shot') {
                text = 'un tiro';
            } else if (type === 'foul') {
                text = 'un fallo';
            }
            document.getElementById('remove-modal-header').textContent = `Sei sicuro di voler rimuovere ${text}?`;
            document.getElementById('remove-modal-message').textContent = `Verrà rimosso l'ultimo ${text} segnato dalla squadra ${team}.`;
            pendingRemovalAction = { type, team };
            document.getElementById('remove-modal').classList.add('is-active');
            vibrate([50]); // Modal open feedback
        }

        function hideRemoveModal() {
            document.getElementById('remove-modal').classList.remove('is-active');
            vibrate([30]); // Modal close feedback
        }

        function confirmRemoval() {
            const { type, team } = pendingRemovalAction;
            if (team === '1') {
                if (type === 'goal' && scoreTeam1 > 0) {
                    scoreTeam1--;
                    team1Scorers.pop();
                    renderScorers(1);
                } else if (type === 'corner' && cornersTeam1 > 0) {
                    cornersTeam1--;
                } else if (type === 'shot' && shotsTeam1 > 0) {
                    shotsTeam1--;
                } else if (type === 'foul' && foulsTeam1 > 0) {
                    foulsTeam1--;
                }
            } else if (team === '2') {
                if (type === 'goal' && scoreTeam2 > 0) {
                    scoreTeam2--;
                    team2Scorers.pop();
                    renderScorers(2);
                } else if (type === 'corner' && cornersTeam2 > 0) {
                    cornersTeam2--;
                } else if (type === 'shot' && shotsTeam2 > 0) {
                    shotsTeam2--;
                } else if (type === 'foul' && foulsTeam2 > 0) {
                    foulsTeam2--;
                }
            }
            updateScores();
            updateStats();
            hideRemoveModal();
            vibrate([100]); // Removal confirmation feedback
        }

        function renderScorers(team) {
            if (team === 1) {
                const list = document.getElementById('scorers-list-1');
                list.innerHTML = '<h4>Marcatori:</h4>';
                team1Scorers.forEach(s => {
                    const newScorer = document.createElement('div');
                    newScorer.classList.add('scorer-list-item');
                    newScorer.textContent = `${s.player} - ${s.minute || 0}' (${s.quarter})`;
                    list.appendChild(newScorer);
                });
            } else if (team === 2) {
                const list = document.getElementById('scorers-list-2');
                list.innerHTML = '<h4>Marcatori:</h4>';
                team2Scorers.forEach(s => {
                    const newScorer = document.createElement('div');
                    newScorer.classList.add('scorer-list-item');
                    newScorer.textContent = `Goal - ${s.minute || 0}' (${s.quarter})`;
                    list.appendChild(newScorer);
                });
            }
        }

        // Reset game function
        function resetGame() {
            scoreTeam1 = 0;
            scoreTeam2 = 0;
            shotsTeam1 = 0;
            cornersTeam1 = 0;
            foulsTeam1 = 0;
            shotsTeam2 = 0;
            cornersTeam2 = 0;
            foulsTeam2 = 0;
            team1Scorers = [];
            team2Scorers = [];

            updateScores();
            updateStats();

            document.getElementById('scorers-list-1').innerHTML = '<h4>Marcatori:</h4>';
            document.getElementById('scorers-list-2').innerHTML = '<h4>Marcatori:</h4>';

            resetTimer();
            hideResetModal();

            // Release wake lock when returning to welcome screen
            releaseWakeLock();
            
            // Stop history listener
            if (historyListener && typeof historyListener === 'function') {
                historyListener();
                historyListener = null;
            }

            // Return to welcome screen
            mainApp.style.display = 'none';
            welcomeScreen.style.display = 'flex';
            welcomeOpponentName.value = '';
            
            vibrate([100, 50, 100]); // Reset feedback
        }

        function showResetModal() {
            document.getElementById('reset-modal').classList.add('is-active');
            vibrate([50]); // Modal open feedback
        }

        function hideResetModal() {
            document.getElementById('reset-modal').classList.remove('is-active');
            vibrate([30]); // Modal close feedback
        }

        // History functions with Firebase integration
        function setupFirebaseHistoryListener() {
            if (typeof window.setupHistoryListener === 'function') {
                historyListener = window.setupHistoryListener((historyList) => {
                    // Store in global variable for modal display
                    matchHistory = historyList;
                }, currentClub?.id);
            }
        }

        async function saveMatch() {
            const team1Name = currentClub ? currentClub.nome : 'POLIS';
            const team2Name = document.getElementById('team2-name').textContent;

            const match = {
                team1: team1Name,
                team2: team2Name,
                score1: scoreTeam1,
                score2: scoreTeam2,
                shots1: shotsTeam1,
                corners1: cornersTeam1,
                fouls1: foulsTeam1,
                shots2: shotsTeam2,
                corners2: cornersTeam2,
                fouls2: foulsTeam2,
                date: new Date().toISOString(),
                scorers1: team1Scorers,
                scorers2: team2Scorers,
                societaId: currentClub?.id
            };

            try {
                // Save to Firebase
                if (typeof window.saveGameToFirebase === 'function') {
                    await window.saveGameToFirebase(match);
                    alert('Partita salvata su Firebase!');
                } else {
                    // Fallback to localStorage
                    const history = loadMatchHistoryLocal();
                    history.push(match);
                    localStorage.setItem('polis_match_history', JSON.stringify(history));
                    alert('Partita salvata nello storico locale!');
                }
                
                // Add vibration feedback
                vibrate([100, 50, 100]);
            } catch (error) {
                console.error('Error saving match:', error);
                // Fallback to localStorage
                const history = loadMatchHistoryLocal();
                history.push(match);
                localStorage.setItem('polis_match_history', JSON.stringify(history));
                alert('Errore Firebase - Partita salvata nello storico locale!');
            }
        }

        function loadMatchHistoryLocal() {
            const historyString = localStorage.getItem('polis_match_history');
            return historyString ? JSON.parse(historyString) : [];
        }

        async function loadMatchHistory() {
            try {
                if (typeof window.loadHistoryFromFirebase === 'function') {
                    return await window.loadHistoryFromFirebase();
                } else {
                    return loadMatchHistoryLocal();
                }
            } catch (error) {
                console.error('Error loading history from Firebase:', error);
                return loadMatchHistoryLocal();
            }
        }

        function showHistoryModal() {
            renderHistory();
            document.getElementById('history-modal').classList.add('is-active');
            vibrate([50]); // Add haptic feedback
        }

        function hideHistoryModal() {
            document.getElementById('history-modal').classList.remove('is-active');
            vibrate([30]); // Add haptic feedback
        }

        function showDeleteMatchModal(matchId) {
            pendingDeleteMatchId = matchId;
            document.getElementById('delete-match-modal').classList.add('is-active');
            vibrate([50]); // Add haptic feedback
        }

        function hideDeleteMatchModal() {
            pendingDeleteMatchId = null;
            document.getElementById('delete-match-modal').classList.remove('is-active');
            vibrate([30]); // Add haptic feedback
        }

        async function confirmDeleteMatch() {
            if (!pendingDeleteMatchId) return;

            try {
                // Try to delete from Firebase first
                if (typeof window.deleteGameFromFirebase === 'function') {
                    await window.deleteGameFromFirebase(pendingDeleteMatchId);
                    vibrate([100, 50, 100]); // Success vibration
                } else {
                    // Fallback to localStorage deletion
                    const history = loadMatchHistoryLocal();
                    const indexToDelete = parseInt(pendingDeleteMatchId);
                    if (indexToDelete >= 0 && indexToDelete < history.length) {
                        history.splice(indexToDelete, 1);
                        localStorage.setItem('polis_match_history', JSON.stringify(history));
                        vibrate([100, 50, 100]); // Success vibration
                    }
                }
                
                hideDeleteMatchModal();
                // Refresh the history display
                await renderHistory();
                
            } catch (error) {
                console.error('Error deleting match:', error);
                alert('Errore durante l\'eliminazione della partita.');
                vibrate([200, 100, 200]); // Error vibration
            }
        }

        async function renderHistory() {
            let history = [];
            
            // Try to use Firebase history first, then fallback to localStorage
            if (matchHistory.length > 0) {
                history = matchHistory;
            } else {
                history = await loadMatchHistory();
            }
            
            history = history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Update total matches played
            const totalMatchesElement = document.getElementById('total-matches-played');
            if (totalMatchesElement) {
                totalMatchesElement.textContent = history.length;
            }
            
            // Calcola le statistiche generali e la classifica marcatori
            const allScorers = {};
            history.forEach(match => {
                if (match.scorers1 && Array.isArray(match.scorers1)) {
                    match.scorers1.forEach(scorer => {
                        if (scorer.player) {
                            if (!allScorers[scorer.player]) {
                                allScorers[scorer.player] = 0;
                            }
                            allScorers[scorer.player]++;
                        }
                    });
                }
            });
            
            // Ordina i marcatori per numero di gol
            const sortedScorers = Object.entries(allScorers).sort(([, a], [, b]) => b - a);

            // Calcola le statistiche totali per il riepilogo
            let totalGoalsMade = 0, totalGoalsConceded = 0;
            let totalShotsMade = 0, totalShotsConceded = 0;
            let totalCornersMade = 0, totalCornersConceded = 0;
            let totalFoulsMade = 0, totalFoulsConceded = 0;

            history.forEach(match => {
                // POLIS è sempre team1, quindi:
                totalGoalsMade += match.score1 || 0;        // gol fatti da POLIS
                totalGoalsConceded += match.score2 || 0;    // gol subiti da POLIS
                totalShotsMade += match.shots1 || 0;        // tiri fatti da POLIS  
                totalShotsConceded += match.shots2 || 0;    // tiri subiti da POLIS
                totalCornersMade += match.corners1 || 0;    // corner fatti da POLIS
                totalCornersConceded += match.corners2 || 0; // corner subiti da POLIS
                totalFoulsMade += match.fouls1 || 0;        // falli fatti da POLIS
                totalFoulsConceded += match.fouls2 || 0;    // falli subiti da POLIS
            });

            // Aggiorna le statistiche del riepilogo
            document.getElementById('total-goals-made').textContent = totalGoalsMade;
            document.getElementById('total-goals-conceded').textContent = totalGoalsConceded;
            document.getElementById('total-shots-made').textContent = totalShotsMade;
            document.getElementById('total-shots-conceded').textContent = totalShotsConceded;
            document.getElementById('total-corners-made').textContent = totalCornersMade;
            document.getElementById('total-corners-conceded').textContent = totalCornersConceded;
            document.getElementById('total-fouls-made').textContent = totalFoulsMade;
            document.getElementById('total-fouls-conceded').textContent = totalFoulsConceded;

            // Renderizza la classifica marcatori
            const scorersTableBody = document.getElementById('scorers-table-body');
            scorersTableBody.innerHTML = '';
            if (sortedScorers.length > 0) {
                sortedScorers.forEach(([player, goals], index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player}</td>
                        <td>${goals}</td>
                    `;
                    scorersTableBody.appendChild(row);
                });
            } else {
                scorersTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">Nessun marcatore.</td></tr>';
            }

            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="text-center text-gray-400">Nessuna partita salvata.</div>';
            } else {
                history.forEach((match, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.classList.add('history-item');
                    const formattedDate = new Date(match.date).toLocaleDateString('it-IT', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const team1ScorersText = match.scorers1 && match.scorers1.length > 0 ? 
                        `<br><span>Marcatori POLIS: ${match.scorers1.map(s => `${s.player} - ${s.minute || 0}' (${s.quarter})`).join(', ')}</span>` : '';
                    const team2ScorersText = match.scorers2 && match.scorers2.length > 0 ? 
                        `<br><span>Marcatori ${match.team2}: ${match.scorers2.map(s => `Goal - ${s.minute || 0}' (${s.quarter})`).join(', ')}</span>` : '';

                    historyItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="history-date">${formattedDate}</div>
                                <div class="font-bold text-xl">${match.team1} ${match.score1} - ${match.score2} ${match.team2}</div>
                                <div class="mt-2 text-sm text-gray-300">
                                    <div>Tiri: ${match.shots1 || 0} - ${match.shots2 || 0}</div>
                                    <div>Corner: ${match.corners1 || 0} - ${match.corners2 || 0}</div>
                                    <div>Falli: ${match.fouls1 || 0} - ${match.fouls2 || 0}</div>
                                    ${team1ScorersText}
                                    ${team2ScorersText}
                                </div>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button class="btn btn-share px-3 py-2 text-sm share-match-btn" data-match-index="${index}">
                                    Condividi
                                </button>
                                <button class="btn btn-reset px-3 py-2 text-sm delete-match-btn" data-match-id="${match.id || index}">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-match-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const matchId = e.target.dataset.matchId;
                        showDeleteMatchModal(matchId);
                    });
                });
                
                // Add event listeners to share buttons
                document.querySelectorAll('.share-match-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const matchIndex = parseInt(e.target.dataset.matchIndex);
                        const matchData = history[matchIndex];
                        await shareSingleMatch(matchData);
                    });
                });
            }
        }

        // Reusable function to generate and share match image
        async function shareSingleMatch(matchData = null) {
            vibrate([50]); // Button feedback
            
            let team1Name, team2Name, score1, score2, shots1, shots2, corners1, corners2, fouls1, fouls2, scorers1, scorers2;
            
            if (matchData) {
                // Use provided match data (for history sharing)
                team1Name = matchData.team1;
                team2Name = matchData.team2;
                score1 = matchData.score1;
                score2 = matchData.score2;
                shots1 = matchData.shots1 || 0;
                shots2 = matchData.shots2 || 0;
                corners1 = matchData.corners1 || 0;
                corners2 = matchData.corners2 || 0;
                fouls1 = matchData.fouls1 || 0;
                fouls2 = matchData.fouls2 || 0;
                scorers1 = matchData.scorers1 || [];
                scorers2 = matchData.scorers2 || [];
            } else {
                // Use current game data (for main share button)
                team1Name = 'POLIS';
                team2Name = document.getElementById('team2-name').textContent;
                score1 = scoreTeam1;
                score2 = scoreTeam2;
                shots1 = shotsTeam1;
                shots2 = shotsTeam2;
                corners1 = cornersTeam1;
                corners2 = cornersTeam2;
                fouls1 = foulsTeam1;
                fouls2 = foulsTeam2;
                scorers1 = team1Scorers;
                scorers2 = team2Scorers;
            }
            
            try {
                // Create a canvas element to generate a summary image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate dynamic height based on number of scorers
                const baseHeight = 460; // Base height up to "Falli" line
                const scorersMargin = 40; // Space between sections
                const lineHeight = 25; // Height per scorer line
                const headerHeight = 30; // Height for scorer headers
                
                let totalScorers = 0;
                let scorerSections = 0;
                
                if (scorers1.length > 0) {
                    totalScorers += scorers1.length;
                    scorerSections++;
                }
                if (scorers2.length > 0) {
                    totalScorers += scorers2.length;
                    scorerSections++;
                }
                
                const dynamicHeight = baseHeight + 
                    (scorerSections * headerHeight) + 
                    (totalScorers * lineHeight) + 
                    (scorerSections * scorersMargin) + 
                    60; // Bottom padding
                
                // Set canvas size with dynamic height
                canvas.width = 800;
                canvas.height = Math.max(600, dynamicHeight); // Minimum 600px
                
                // Set background
                ctx.fillStyle = '#1A202C';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Set text styles
                ctx.fillStyle = '#f1f5f9';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                
                // Title
                ctx.fillText('POLIS 2013', canvas.width / 2, 80);
                
                // Date
                ctx.font = '20px Arial';
                let currentDate;
                if (matchData && matchData.date) {
                    currentDate = new Date(matchData.date).toLocaleDateString('it-IT', { 
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                    });
                } else {
                    currentDate = new Date().toLocaleDateString('it-IT', { 
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                    });
                }
                ctx.fillText(currentDate, canvas.width / 2, 120);
                
                // Team names
                ctx.font = 'bold 36px Arial';
                ctx.fillText(team1Name, 200, 200);
                ctx.fillText(team2Name, 600, 200);
                
                // Score
                ctx.font = 'bold 80px Arial';
                ctx.fillText(`${score1} - ${score2}`, canvas.width / 2, 280);
                
                // Statistics
                ctx.font = '24px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('Statistiche:', 50, 350);
                ctx.fillText(`Tiri: ${shots1} - ${shots2}`, 50, 380);
                ctx.fillText(`Corner: ${corners1} - ${corners2}`, 50, 410);
                ctx.fillText(`Falli: ${fouls1} - ${fouls2}`, 50, 440);
                
                // Markers
                if (scorers1.length > 0) {
                    ctx.fillText(`Marcatori ${team1Name}:`, 50, 480);
                    scorers1.forEach((scorer, index) => {
                        const text = typeof scorer === 'string' ? scorer : `${scorer.player} - ${scorer.minute || 0}' (${scorer.quarter})`;
                        ctx.fillText(text, 70, 510 + (index * 25));
                    });
                }
                
                if (scorers2.length > 0) {
                    const startY = scorers1.length > 0 ? 510 + (scorers1.length * 25) + 30 : 480;
                    ctx.fillText(`Marcatori ${team2Name}:`, 50, startY);
                    scorers2.forEach((scorer, index) => {
                        const text = typeof scorer === 'string' ? scorer : `Goal - ${scorer.minute || 0}' (${scorer.quarter})`;
                        ctx.fillText(text, 70, startY + 30 + (index * 25));
                    });
                }
                
                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    try {
                        // Try to use native share API if available
                        if (navigator.share && navigator.canShare) {
                            const file = new File([blob], 'polis-partita.png', { type: 'image/png' });
                            const shareData = {
                                title: 'Risultato Partita - Polis 2013',
                                files: [file]
                            };
                            
                            if (navigator.canShare(shareData)) {
                                await navigator.share(shareData);
                                return;
                            }
                        }
                        
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'polis-partita.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('Immagine della partita scaricata!');
                    } catch (error) {
                        console.log('Share failed:', error);
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'polis-partita.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('Immagine della partita scaricata!');
                    }
                }, 'image/png');
            } catch (error) {
                console.error('Error creating image:', error);
                alert('Errore nella creazione dell\'immagine.');
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            // Login and navigation
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('login-code-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            // Menu buttons
            document.getElementById('start-match-btn').addEventListener('click', showMatchSetup);
            document.getElementById('manage-players-btn').addEventListener('click', showPlayersManagement);
            
            // Players management
            document.getElementById('add-player-btn').addEventListener('click', addPlayer);
            document.getElementById('new-player-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addPlayer();
                }
            });
            document.getElementById('save-players-btn').addEventListener('click', savePlayersChanges);
            document.getElementById('back-to-menu-btn').addEventListener('click', backToMenu);
            
            // Start game button
            startGameBtn.addEventListener('click', startGame);

            // Timer controls
            document.getElementById('start-timer-button').addEventListener('click', startTimer);
            document.getElementById('pause-timer-button').addEventListener('click', pauseTimer);
            document.getElementById('reset-timer-button').addEventListener('click', resetTimer);

            // Timer setup modal
            document.getElementById('timer-display').addEventListener('click', () => {
                pauseTimer();
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                document.getElementById('timer-minutes-input').value = minutes;
                document.getElementById('timer-seconds-input').value = seconds;
                document.getElementById('timer-setup-modal').classList.add('is-active');
                vibrate([50]); // Timer modal open feedback
            });

            // Edit timer button
            document.getElementById('edit-timer-button').addEventListener('click', () => {
                pauseTimer();
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                document.getElementById('timer-minutes-input').value = minutes;
                document.getElementById('timer-seconds-input').value = seconds;
                document.getElementById('timer-setup-modal').classList.add('is-active');
                vibrate([50]); // Timer modal open feedback
            });

            document.getElementById('set-timer-button').addEventListener('click', () => {
                const minutes = parseInt(document.getElementById('timer-minutes-input').value);
                const seconds = parseInt(document.getElementById('timer-seconds-input').value);
                if (!isNaN(minutes) && !isNaN(seconds)) {
                    totalSeconds = (minutes * 60) + seconds;
                    lastSetSeconds = totalSeconds;
                    updateTimerDisplay();
                    document.getElementById('timer-setup-modal').classList.remove('is-active');
                    vibrate([100]); // Timer set confirmation
                }
            });

            // Action buttons (goals, corners, shots)
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const team = button.dataset.team;
                    const type = button.dataset.type;
                    const action = button.dataset.action;
                    const quarter = button.dataset.quarter;

                    // Add vibration feedback for all button clicks
                    if (type === 'goal') {
                        vibrate([80]); // Goal button feedback
                    } else {
                        vibrate([50]); // Standard button feedback
                    }

                    if (action === 'add') {
                        if (type === 'goal') {
                            if (team === '1') {
                                showPlayerModal(quarter);
                            } else if (team === '2') {
                                addGoalTeam2(quarter);
                            }
                        } else if (type === 'corner') {
                            if (team === '1') {
                                cornersTeam1++;
                            } else if (team === '2') {
                                cornersTeam2++;
                            }
                            updateStats();
                        } else if (type === 'shot') {
                            if (team === '1') {
                                shotsTeam1++;
                            } else if (team === '2') {
                                shotsTeam2++;
                            }
                            updateStats();
                        } else if (type === 'foul') {
                            if (team === '1') {
                                foulsTeam1++;
                            } else if (team === '2') {
                                foulsTeam2++;
                            }
                            updateStats();
                        }
                    } else if (action === 'remove') {
                        showRemoveModal(type, team);
                    }
                });
            });

            // Modal event listeners
            document.getElementById('cancel-player-selection-button').addEventListener('click', hidePlayerModal);
            document.getElementById('confirm-remove-button').addEventListener('click', confirmRemoval);
            document.getElementById('cancel-remove-button').addEventListener('click', hideRemoveModal);
            document.getElementById('reset-button').addEventListener('click', showResetModal);
            document.getElementById('confirm-reset-button').addEventListener('click', resetGame);
            document.getElementById('cancel-reset-button').addEventListener('click', hideResetModal);

            // History event listeners
            document.getElementById('show-history-button').addEventListener('click', showHistoryModal);
            document.getElementById('close-history-button').addEventListener('click', hideHistoryModal);

            // Delete match event listeners
            document.getElementById('confirm-delete-match-button').addEventListener('click', confirmDeleteMatch);
            document.getElementById('cancel-delete-match-button').addEventListener('click', hideDeleteMatchModal);

            // Save and share functionality - separate buttons
            document.getElementById('save-button').addEventListener('click', async () => {
                vibrate([50]); // Button feedback
                await saveMatch();
                alert('Partita salvata!');
            });

            document.getElementById('share-button').addEventListener('click', async () => {
                await saveMatch();
                await shareSingleMatch(); // Use the new reusable function
            });
        });

        // Initialize Firebase connection check
        setTimeout(() => {
            // Simulate Firebase connection (will be replaced by actual Firebase logic)
            if (typeof window.onFirebaseReady === 'function') {
                window.onFirebaseReady();
            }
        }, 2000);
    </script>
</body>
</html>
