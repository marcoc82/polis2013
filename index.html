<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StaKick</title>
    <!-- PWA Manifest -->
    <!-- Best practice: use relative paths (without leading slash) for GitHub Pages compatibility -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <link rel="stylesheet" href="./dist/tailwind.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./logo-stakick.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./logo-stakick.png">
    <!-- Firebase SDK -->
    <script type="module" src="./firebase-app-modular.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        /* Anti-pull-to-refresh CSS - Previene il refresh accidentale causato dal gesto di pull-to-refresh */
        html, body {
            overscroll-behavior-y: contain; /* Previene il pull-to-refresh su Chrome/Android e Edge */
            -webkit-overflow-scrolling: touch; /* Migliora lo scrolling su iOS */
            height: 100%; /* Necessario per il contenimento del overscroll */
        }

        /* Ulteriori precauzioni per iOS/Safari - limita il comportamento di overscroll */
        body {
            /* position: fixed removed to prevent scroll position reset on swipe/reload */
            /* overscroll-behavior-y: contain is sufficient for modern browsers */
            width: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* CSS consolidato da entrambi i file */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: #1A202C; /* Sfondo scuro per un look moderno */
            color: #E2E8F0; /* Testo chiaro */
        }

        /* Classe per sfondo scuro durante il login (dark mode) */
        body.login-background {
            background-color: #1A202C;
            color: #E2E8F0;
        }

        /* Schermate overlay */
        #loading-screen, #welcome-screen, #login-screen, #menu-screen, #players-management-screen, #main-app { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
        }
        
        #loading-screen, #welcome-screen, #login-screen, #menu-screen { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 999; 
            background: #1A202C; 
        }

        /* Sfondo scuro per la schermata di login (dark mode) */
        body.login-background #login-screen {
            background: #1A202C !important;
        }

        /* Sfondo scuro per il contenuto della schermata di login */
        body.login-background #login-screen .welcome-content {
            background: #1A202C !important;
        }

        /* Stili per testo nella schermata di login con sfondo scuro */
        body.login-background #login-screen .welcome-content h2,
        body.login-background #login-screen .welcome-content p {
            color: #E2E8F0;
        }

        /* Stili per input nella schermata di login con sfondo scuro */
        body.login-background #login-screen .modal-input {
            background-color: #2D3748;
            border-color: #4A5568;
            color: #E2E8F0;
        }
        
        /* Stili per la versione dell'app nella schermata di login */
        .app-version {
            color: #94a3b8; /* Colore grigio per buona visibilità su sfondo scuro */
        }
        
        /* Stili per la versione dell'app nella schermata di login dark mode */
        body.login-background .app-version {
            color: #94a3b8; /* Stesso colore grigio per coerenza con il dark mode */
        }
        
        #players-management-screen { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            z-index: 999; 
            background: #1A202C; 
            overflow-y: auto;
            padding: 20px 0;
        }

        /* Ensure sidebar elements are hidden when players management screen is active */
        #players-management-screen[style*="flex"] ~ .sidebar,
        #players-management-screen[style*="flex"] ~ nav,
        #players-management-screen[style*="flex"] ~ .nav,
        #players-management-screen[style*="flex"] ~ .navigation {
            display: none !important;
        }
        
        #main-app { 
            display: none; 
            z-index: 10;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Contenitore principale con stile aggiornato */
        .container {
            background: #2D3748; /* Contenitore leggermente più chiaro */
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5); /* Ombra più pronunciata per profondità */
            text-align: center;
            width: 90%;
            max-width: 900px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .polis-text {
            color: #4A90E2; /* Colore blu oceano per il titolo */
            margin-bottom: 5px;
            font-size: 9em; /* Aumentato il font-size del titolo */
            text-shadow: 0 0 5px white, 0 0 10px white, 0 0 15px white; /* Ombreggiatura bianca */
            line-height: 1; /* Riduci l'altezza della riga per centrare meglio */
        }
        
        .date-text {
            font-size: 1rem;
            text-align: center;
            color: #cbd5e0;
        }

        .date-display {
            text-align: center;
            font-size: 1rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        /* Stile per la schermata di benvenuto */
        #welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1A202C;
            z-index: 200;
        }
        .welcome-content {
            background-color: #2D3748;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            max-width: 450px;
            width: 90%;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        /* Timer styles */
        .timer-container {
            background-color: #334155;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
        }
        .timer-display-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        #timer-display {
            font-size: 3rem;
            font-weight: 700;
            color: #4A90E2;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        #timer-display:hover {
            color: #60a5fa;
        }
        .current-period-indicator {
            font-size: 1.25rem;
            font-weight: 600;
            color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid #10b981;
            margin-left: 1rem;
        }
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }

        /* Score display */
        .score-display {
            font-size: 6.5rem;
            font-weight: 700;
            color: #f1f5f9;
            margin: 2rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
        }
        .score-digit {
            transition: transform 0.2s ease-in-out;
        }
        .score-digit:hover {
            transform: scale(1.1);
        }

        /* Animazione per l'effetto di ingrandimento del punteggio */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(2.0); }
            100% { transform: scale(1); }
        }
        .score-digit.is-pulsing {
            animation: pulse 1s ease-in-out;
        }

        /* Login screen fade-in animations */
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .login-logo {
            opacity: 0;
            animation: fadeInUp 0.8s ease-out forwards;
        }
        
        .login-form {
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.3s forwards;
        }
        
        .login-access-section {
            opacity: 0;
            animation: slideInFromRight 0.6s ease-out 1.1s forwards;
        }
        
        .login-button-section {
            opacity: 0;
            animation: slideInFromLeft 0.6s ease-out 1.4s forwards;
        }

        /* Teams container */
        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .team {
            background-color: #334155;
            padding: 1.5rem;
            border-radius: 1rem;
        }
        .team-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 1rem;
            /* Responsive team name fixes */
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
            text-align: center;
            /* Dynamic font sizing */
            font-size: clamp(1rem, 3.5vw, 1.875rem);
            line-height: 1.2;
        }

        /* Responsive team names above score display */
        .text-3xl {
            /* Fixes for responsive team names above score */
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
            max-width: 45%; /* Prevent overlapping with other team name */
            text-align: center;
            /* Dynamic font sizing */
            font-size: clamp(1rem, 4vw, 1.875rem) !important;
            line-height: 1.2 !important;
            white-space: nowrap;
        }

        /* Specific styling for Team 2 name to handle long names better */
        #score-team2-name {
            font-size: clamp(1rem, 3vw, 1.4rem) !important;
            white-space: nowrap;
            text-align: left !important;
            margin-left: -10px;
        }

        /* Button styles consolidati */
        .btn {
            color: white;
            font-weight: 600;
            padding: 0.75rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            border: none;
            font-size: 0.875rem; /* Reduced font size for better mobile fit */
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn-goal {
            background: linear-gradient(to right, #22c55e, #16a34a);
            padding: 0.875rem 1.5rem; /* Reduced padding for mobile */
            font-size: 0.8rem; /* Smaller font for goal buttons */
        }
        .btn-stats-add {
            background: linear-gradient(to right, #f97316, #ea580c);
            padding: 0.875rem 1.5rem; /* Match goal button padding */
            font-size: 0.8rem; /* Match goal button font size */
        }
        
        .btn-yellow-card, .btn-red-card {
            background: transparent;
            border: none;
            padding: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
        }
        .btn-yellow-card:hover, .btn-red-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        .btn-yellow-card img, .btn-red-card img {
            width: 40px;
            height: 40px;
            margin: 0;
        }
        
        /* Enhanced styling for Corner, Tiri, and Falli buttons - same size as Goal buttons */
        .btn-corner {
            background: linear-gradient(to right, #fb923c, #f97316) !important;
            color: #fff !important;
            border: 2px solid #fb923c !important;
            font-size: 0.8rem !important;
            font-weight: 700 !important;
            padding: 0.875rem 1.5rem !important; /* Match goal button padding */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
        }
        .btn-corner:hover {
            background: linear-gradient(to right, #fdba74, #fb923c) !important;
            border-color: #fdba74 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 12px rgba(251, 146, 60, 0.4) !important;
        }
        
        .btn-tiri {
            background: linear-gradient(to right, #fb923c, #f97316) !important;
            color: #fff !important;
            border: 2px solid #fb923c !important;
            font-size: 0.8rem !important;
            font-weight: 700 !important;
            padding: 0.875rem 1.5rem !important; /* Match goal button padding */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
        }
        .btn-tiri:hover {
            background: linear-gradient(to right, #fdba74, #fb923c) !important;
            border-color: #fdba74 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 12px rgba(251, 146, 60, 0.4) !important;
        }
        
        .btn-falli {
            background: linear-gradient(to right, #fb923c, #f97316) !important;
            color: #fff !important;
            border: 2px solid #fb923c !important;
            font-size: 0.8rem !important;
            font-weight: 700 !important;
            padding: 0.875rem 1.5rem !important; /* Match goal button padding */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
        }
        .btn-falli:hover {
            background: linear-gradient(to right, #fdba74, #fb923c) !important;
            border-color: #fdba74 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 12px rgba(251, 146, 60, 0.4) !important;
        }
        /* Keep Corner, Tiri in porta and Falli buttons orange - remove red override */
        .btn-remove-goal {
            background-color: #6B7280;
            color: white;
            border-radius: 50%;
            height: 2.5rem; /* Reduced size */
            width: 2.5rem; /* Reduced size */
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
        }
        .btn-remove-goal:hover {
            background-color: #4B5563;
        }
        .btn-remove-stats {
            background-color: #6B7280;
            color: white;
            border-radius: 50%; /* Round like goal buttons */
            height: 2.5rem; /* Reduced size */
            width: 2.5rem; /* Reduced size */
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
        }
        .btn-remove-stats:hover {
            background-color: #4B5563;
        }

        /* Timer buttons */
        .btn-start { background-color: #10b981; }
        .btn-start:hover { background-color: #059669; }
        .btn-pause { background-color: #f59e0b; }
        .btn-pause:hover { background-color: #d97706; }
        .btn-reset-timer { background-color: #ef4444; }
        .btn-reset-timer:hover { background-color: #dc2626; }

        /* Large action buttons */
        .btn-reset {
            background-color: #dc2626;
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1rem 2rem;
        }
        .btn-reset:hover {
            background-color: #ef4444;
        }
        .btn-share {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1rem 2rem;
        }
        .btn-share:hover {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
        }
        .btn-save {
            background: linear-gradient(to right, #8b5cf6, #7c3aed);
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1rem 2rem;
        }
        .btn-save:hover {
            background: linear-gradient(to right, #7c3aed, #6d28d9);
        }
        .btn-save:disabled {
            background: linear-gradient(to right, #6b7280, #4b5563) !important;
            cursor: not-allowed !important;
            opacity: 0.7 !important;
            transform: none !important;
            box-shadow: none !important;
        }
        .btn-save:disabled:hover {
            background: linear-gradient(to right, #6b7280, #4b5563) !important;
            transform: none !important;
            box-shadow: none !important;
        }
        .btn-history {
            background: linear-gradient(to right, #f97316, #ea580c);
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1rem 2rem;
        }
        .btn-history:hover {
            background: linear-gradient(to right, #ea580c, #c55d0a);
        }

        /* Green button for welcome */
        .btn-green {
            background-color: #48BB78;
            color: white;
        }
        .btn-green:hover {
            background-color: #38A169;
        }
        .btn-blue {
            background-color: #4A90E2;
            color: white;
        }
        .btn-blue:hover {
            background-color: #357ABD;
        }
        .btn-gray {
            background-color: #718096;
            color: white;
        }
        .btn-gray:hover {
            background-color: #4A5568;
        }
        .btn-large {
            padding: 16px 32px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 12px;
        }
        
        /* Red button for back to login */
        .btn-back-login {
            background-color: #E53E3E;
            color: white;
        }
        .btn-back-login:hover {
            background-color: #C53030;
        }
        
        /* Gray button for history view */
        .btn-history-view {
            background-color: #718096;
            color: white;
        }
        .btn-history-view:hover {
            background-color: #4A5568;
        }

        /* Stats container */
        .stats-container {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .stats-team {
            background-color: #334155;
            padding: 1rem;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 1.25rem;
            font-weight: 600;
            color: #e2e8f0;
        }

        /* Scorer list */
        .scorer-list {
            text-align: left;
            padding: 0.5rem 0 0 0;
            border-top: 1px solid #475569;
            margin-top: 1rem;
        }
        .scorer-list h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #a0aec0;
        }
        .scorer-list-item {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: #cbd5e1;
        }
        
        .cards-list {
            text-align: left;
            padding: 0.5rem 0 0 0;
            border-top: 1px solid #475569;
            margin-top: 1rem;
        }
        .cards-list h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #a0aec0;
        }
        .cards-list-item {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: #cbd5e1;
            display: flex;
            align-items: center;
        }
        .cards-list-item img {
            width: 16px;
            height: 16px;
            margin-right: 6px;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.is-active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1e293b;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .modal-overlay.is-active .modal-content {
            transform: scale(1);
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        .modal-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #475569;
            background-color: #334155;
            color: #f1f5f9;
            text-align: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        .modal-input:focus {
            outline: none;
            border-color: #60a5fa;
        }

        /* Player list */
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .player-btn {
            background-color: #334155;
            color: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .player-btn:hover {
            background-color: #475569;
        }
        .player-btn:active {
            transform: scale(0.95);
        }

        /* Button grids */
        .button-grid-1 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        .button-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        .button-section {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        /* Coriandoli */
        .confetti {
            position: absolute;
            z-index: 1000;
            animation: fall 5s forwards;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotateZ(360deg);
                opacity: 0;
            }
        }

        /* Animazione timer */
        @keyframes timer-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .timer-running {
            animation: timer-pulse 1s ease-in-out infinite;
        }

        /* History styles */
        .history-list {
            list-style: none;
            padding: 0;
            text-align: left;
            margin-bottom: 1.5rem;
        }
        .history-item {
            background-color: #334155;
            padding: 0;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            overflow: hidden;
        }
        .history-item-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        .history-item-header:hover {
            background-color: #3f4c5e;
        }
        .history-item-summary {
            flex: 1;
            text-align: center;
        }
        .history-caret {
            font-size: 1.2rem;
            transition: transform 0.3s;
            user-select: none;
        }
        .history-caret.expanded {
            transform: rotate(90deg);
        }
        .history-item-details {
            display: none;
            padding: 1rem;
            border-top: 1px solid #475569;
            background-color: #2d3748;
        }
        .history-item-details.expanded {
            display: block;
        }
        .history-date {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            text-align: center; /* Centra la data delle partite */
        }
        .history-match-title {
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            line-height: 1.3;
            text-align: center; /* Centra il titolo delle partite nello storico */
        }

        /* Scorer ranking styles */
        .history-section {
            margin-bottom: 2rem;
        }
        .history-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #f1f5f9;
        }
        .scorers-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        
        /* Stili per centrare il contenuto dello storico partite (vinte/perse/pareggiate) */
        .scorers-table th, .scorers-table td {
            text-align: center; /* Centra il contenuto delle celle per migliorare l'allineamento */
        }
        
        /* Centra le statistiche delle partite nella sezione storico */
        .history-section {
            text-align: center; /* Centra il contenuto della sezione storico */
        }
        
        .scorers-table th, .scorers-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #475569;
        }
        .scorers-table th {
            color: #94a3b8;
            font-weight: 600;
        }
        .scorers-table tbody tr:last-child td {
            border-bottom: none;
        }
        .scorers-table tr:hover {
            background-color: #334155;
        }
        
        /* History modal specific styles */
        .history-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            flex: 1;
        }
        /* Special styling for history modal to allow larger width */
        #history-modal .modal-content {
            max-width: 90vw;
            width: 90%;
        }
        .modal-footer {
            flex-shrink: 0;
            padding-top: 1rem;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .teams-container {
                display: flex;
                flex-direction: row;
                gap: 0.75rem; /* Reduced gap */
            }
            .teams-container .team {
                flex: 1;
                min-width: 0;
                padding: 1rem; /* Reduced padding */
            }
            .stats-container {
                display: flex;
                flex-direction: row;
                gap: 0.75rem; /* Reduced gap */
            }
            .stats-container .stats-team {
                flex: 1;
                min-width: 0;
            }
            .score-display {
                font-size: 4rem;
            }
            .container {
                padding: 0.75rem; /* Reduced padding */
            }
            .polis-text {
                font-size: 4em;
            }
            
            /* Improved mobile button layout */
            .btn-goal {
                padding: 0.5rem 0.75rem; /* Even smaller on mobile */
                font-size: 0.7rem;
            }
            .btn-stats-add {
                padding: 0.5rem 0.75rem;
                font-size: 0.7rem;
            }
            .btn-remove-stats,
            .btn-remove-goal {
                height: 1.5rem !important;
                width: 1.5rem !important;
                font-size: 0.65rem !important;
                padding: 0 !important;
            }
            
            /* Fixed mobile layout for Corner, Tiri, and Falli buttons */
            .btn-corner,
            .btn-tiri,
            .btn-falli {
                padding: 0.5rem 0.6rem !important;
                font-size: 0.65rem !important;
            }
            
            /* Better grid spacing on mobile */
            .grid.grid-cols-3 {
                gap: 0.5rem; /* Reduced gap between goal buttons */
            }
            .button-grid-2 {
                gap: 0.5rem; /* Reduced gap between other buttons */
            }
            .button-section {
                margin-bottom: 1rem; /* Reduced margin */
            }
            
            /* Mobile specific fixes for team names */
            .text-3xl {
                font-size: clamp(0.8rem, 5vw, 1.5rem) !important;
                max-width: 42% !important; /* Slightly smaller on mobile */
            }
            
            /* Mobile specific styling for Team 2 name */
            #score-team2-name {
                font-size: clamp(0.8rem, 3vw, 1.2rem) !important;
                margin-left: -15px; /* Slightly more offset on mobile */
            }
            
            .team-title {
                font-size: clamp(0.9rem, 4vw, 1.5rem) !important;
            }
            
            /* Ensure table remains centered on mobile */
            .period-stats-table {
                font-size: 0.7rem;
                margin: 0.5rem auto;
            }
            
            .period-stats-table th,
            .period-stats-table td {
                padding: 0.3rem 0.2rem;
            }
            
            /* Improved history layout for mobile */
            .history-match-title {
                font-size: 1.1rem !important; /* Slightly smaller on mobile */
                line-height: 1.2;
            }
            .history-item {
                padding: 0.75rem; /* Reduced padding on mobile */
            }
        }

        /* HR styles */
        hr {
            border-color: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }
        .mb-2 {
            margin-bottom: 0.5rem;
        }

        /* Hide sidebar elements when players management screen is active */
        #players-management-screen ~ * .sidebar,
        #players-management-screen ~ * nav,
        #players-management-screen ~ * .nav,
        #players-management-screen ~ * .navigation,
        #players-management-screen ~ * .menu-sidebar,
        #players-management-screen ~ * .side-panel {
            display: none !important;
        }

        /* Alternative approach: when players management screen is visible, hide any sidebar-like elements */
        body:has(#players-management-screen[style*="flex"]) .sidebar,
        body:has(#players-management-screen[style*="flex"]) nav,
        body:has(#players-management-screen[style*="flex"]) .nav,
        body:has(#players-management-screen[style*="flex"]) .navigation,
        body:has(#players-management-screen[style*="flex"]) .menu-sidebar,
        body:has(#players-management-screen[style*="flex"]) .side-panel {
            display: none !important;
        }

        /* Period statistics styles */
        .period-stats {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #2d3748;
            border-radius: 0.5rem;
            font-size: 0.85rem;
        }
        .period-breakdown h5 {
            color: #4a90e2;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .period-breakdown div {
            margin-bottom: 0.25rem;
            color: #e2e8f0;
            line-height: 1.4;
        }
        
        /* Period statistics table */
        .period-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.5rem auto; /* Center the table */
            font-size: 0.8rem;
            /* Ensure table is centered within its container */
            margin-left: auto;
            margin-right: auto;
        }
        .period-stats-table th,
        .period-stats-table td {
            padding: 0.4rem 0.3rem;
            text-align: center;
            border: 1px solid #4a5568;
        }
        .period-stats-table th {
            background-color: #4a90e2;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
        }
        .period-stats-table td {
            background-color: #374151;
            color: #e2e8f0;
        }
        .period-stats-table .totals-row {
            background-color: #4a5568 !important;
        }
        .period-stats-table .totals-row td {
            background-color: #4a5568 !important;
            border-top: 2px solid #4a90e2;
        }
        
        /* Container for period stats to ensure centering */
        .period-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #2d3748;
            border-radius: 0.5rem;
            font-size: 0.85rem;
        }
        
        /* Period statistics table for individual match history */
        .period-stats-table-history {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            font-size: 0.7rem;
        }
        .period-stats-table-history th,
        .period-stats-table-history td {
            padding: 0.3rem 0.2rem;
            text-align: center;
            border: 1px solid #4a5568;
        }
        .period-stats-table-history th {
            background-color: #4a90e2;
            color: white;
            font-weight: 600;
            font-size: 0.65rem;
        }
        .period-stats-table-history td {
            background-color: #374151;
            color: #e2e8f0;
        }
        .period-stats-table-history .totals-row {
            background-color: #4a5568 !important;
        }
        .period-stats-table-history .totals-row td {
            background-color: #4a5568 !important;
            border-top: 2px solid #4a90e2;
        }
        
        /* Match period stats container */
        .match-period-stats {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background-color: #2d3748;
            border-radius: 0.5rem;
            font-size: 0.8rem;
        }
        
        /* Visual confirmation popup for button presses */
        .action-confirmation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(72, 187, 120, 0.95);
            color: white;
            font-size: 3rem;
            font-weight: bold;
            padding: 2rem 3rem;
            border-radius: 1rem;
            z-index: 10000;
            pointer-events: none;
            animation: confirmationPop 1s ease-out forwards;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes confirmationPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            70% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
        }
    </style>
</head>
<body class="login-background">
    <!-- Schermata di Loading -->
    <div id="loading-screen" style="display: none;">
        <h2 style="color:#4A90E2;">Connessione al database...</h2>
        <pre id="loading-log" style="margin-top:20px; color: #E2E8F0; font-family: monospace; background: #2D3748; padding: 20px; border-radius: 12px;"></pre>
    </div>

    <!-- Schermata di login -->
    <div id="login-screen" style="display: flex;">
        <div class="welcome-content">
            <!-- Logo container with fade-in animation -->
            <div class="login-logo">
                <img src="logo-stakick.png" alt="Logo StaKick" style="max-width: 260px; height: auto; margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;">
            </div>
            
            <!-- Login form container with delayed fade-in animation -->
            <div class="login-form">
                <div class="login-access-section">
                    <h2 class="text-2xl font-bold mb-4">Accesso</h2>
                    <p class="mb-6">Inserisci il codice fornito dall'organizzatore per accedere all'app:</p>
                    <input type="text" id="login-code-input" placeholder="Codice Accesso" class="w-full mb-4 modal-input">
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="remember-code-checkbox" class="mr-2 w-4 h-4 cursor-pointer">
                        <label for="remember-code-checkbox" class="text-sm cursor-pointer select-none">Ricorda il codice</label>
                    </div>
                    <div id="login-error" class="text-red-400 mb-4 hidden">Codice non valido</div>
                </div>
                <div class="login-button-section">
                    <button id="login-btn" class="btn-green btn-large w-full">Accedi</button>
                    <!-- Versione dell'app aggiunta sotto il pulsante Accedi -->
                    <div class="app-version mt-4 text-center text-sm text-gray-500">
                        Versione: v3.3
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schermata menu scelta -->
    <div id="menu-screen" style="display: none;">
        <div class="welcome-content">
            <h1 class="polis-text" style="font-size: 4em;">StaKick</h1>
            <hr class="my-6">
            <h2 id="menu-team-name" class="text-2xl font-bold mb-4">Benvenuto, POLIS!</h2>
            <p class="mb-6">Cosa vuoi fare?</p>
            <div class="button-grid-1 gap-4">
                <button id="start-match-btn" class="btn-green btn-large w-full">Inizia Partita</button>
                <button id="manage-players-btn" class="btn-blue btn-large w-full">Gestione Squadra</button>
                <button id="view-history-btn" class="btn-history-view btn-large w-full">Vedi Storico</button>
                <button id="back-to-login-btn" class="btn-back-login btn-large w-full">Torna alla Login</button>
            </div>
            <div class="app-version mt-4 text-center text-sm text-gray-500">
                Versione: v3.3
            </div>
        </div>
    </div>

    <!-- Schermata gestione giocatori -->
    <div id="players-management-screen" style="display: none;">
        <div class="welcome-content">
            <h1 class="font-normal text-white text-3xl">Gestione Squadra</h1>
            <hr class="my-6">
            <h2 id="players-team-name" class="text-xl font-bold mb-4">POLIS</h2>
            
            <!-- Selettore numero di tempi -->
            <div class="mb-4 p-4 bg-gray-700 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-white">Numero di Tempi di Gioco</h3>
                <div class="flex gap-4 justify-center">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" id="periods-2" name="numPeriods" value="2" checked class="mr-2">
                        <span class="text-white">2 Tempi</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" id="periods-3" name="numPeriods" value="3" class="mr-2">
                        <span class="text-white">3 Tempi</span>
                    </label>
                </div>
            </div>

            <!-- Selettore durata tempo -->
            <div class="mb-4 p-4 bg-gray-700 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-white">Durata del Tempo (minuti)</h3>
                <select id="period-duration" class="w-full modal-input">
                    <option value="10">10 minuti</option>
                    <option value="12">12 minuti</option>
                    <option value="15">15 minuti</option>
                    <option value="18" selected>18 minuti</option>
                    <option value="20">20 minuti</option>
                    <option value="25">25 minuti</option>
                    <option value="30">30 minuti</option>
                    <option value="35">35 minuti</option>
                    <option value="40">40 minuti</option>
                    <option value="45">45 minuti</option>
                </select>
            </div>

            <div class="mb-4">
                <input type="text" id="new-player-input" placeholder="Aggiungi nuovo giocatore (es: 88 ROSSI MARIO)" class="w-full mb-2 modal-input">
                <button id="add-player-btn" class="btn-blue btn-large rounded-2xl w-full mb-4">Aggiungi Giocatore</button>
            </div>
            
            <div id="players-list" class="player-list mb-4">
                <!-- Lista giocatori verrà popolata dinamicamente -->
            </div>
            
            <div class="button-grid-1 gap-2">
                <button id="save-players-btn" class="btn-green btn-large rounded-2xl w-full mb-2">Salva Modifiche</button>
                <button id="back-to-menu-from-players-btn" class="btn-gray btn-large rounded-2xl w-full">Torna Indietro</button>
            </div>
        </div>
    </div>

    <!-- Schermata di benvenuto -->
    <div id="welcome-screen" style="display: none;">
        <div class="welcome-content">
            <h1 class="polis-text" style="font-size: 5em;">StaKick</h1>
            <hr class="my-6">
            <p class="mb-6">Configura i dettagli della partita prima di iniziare</p>
            <input type="text" id="welcome-opponent-name" placeholder="Nome Squadra Avversaria" class="w-full mb-4 modal-input">
            
            <!-- Home/Away selection -->
            <div class="mb-4 p-4 bg-gray-700 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-white">Tipo di Partita</h3>
                <div class="flex gap-4 justify-center">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" id="match-type-home" name="matchType" value="home" checked class="mr-2">
                        <span class="text-white">Casa</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" id="match-type-away" name="matchType" value="away" class="mr-2">
                        <span class="text-white">Trasferta</span>
                    </label>
                </div>
            </div>
            
            <!-- Lineup button (optional) -->
            <button id="insert-lineup-btn" class="btn-blue btn-large w-full mb-4">Inserisci Formazione (Opzionale)</button>
            <div id="lineup-status" class="text-center text-sm mb-4 hidden">
                <span class="text-green-400">✓ Formazione inserita (<span id="lineup-count">0</span> giocatori)</span>
            </div>
            
            <div id="welcome-error" class="text-red-400 mb-4 hidden text-center">Inserisci il nome della squadra avversaria</div>
            
            <div class="button-grid-2 gap-2">
                <button id="back-to-menu-btn" class="btn-gray btn-large w-full">Indietro</button>
                <button id="start-game-btn" class="btn-green btn-large w-full">Inizia Partita</button>
            </div>
        </div>
    </div>
    
    <!-- App principale -->
    <div id="main-app">
        <div class="container">
            <p id="current-date" class="date-display"></p>
            <h1 class="polis-text" style="font-size: 2.5rem;">StaKick</h1>
            
            <!-- Sezione Timer -->
            <div class="timer-container">
                <div class="timer-display-container">
                    <span id="timer-display">18:00</span>
                    <span id="current-period-display" class="current-period-indicator" style="display: none;"></span>
                    <button id="edit-timer-button" class="btn btn-start" style="padding: 0.5rem; font-size: 0.875rem;">Modifica</button>
                </div>
                <div id="recovery-display" style="font-size: 1.5rem; color: #fbbf24; text-align: center; margin-top: 0.5rem; display: none;">+ 0:00</div>
                <div class="timer-controls">
                    <button id="start-timer-button" class="btn btn-start">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg>
                    </button>
                    <button id="pause-timer-button" class="btn btn-pause">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;"><path d="M13,19V6H17V19H13M6,19V6H10V19H6M7,7V18H9V7H7M14,7V18H16V7H14Z"></path></svg>
                    </button>
                    <button id="reset-timer-button" class="btn btn-reset-timer">Reset</button>
                </div>
            </div>
            
            <!-- Nomi delle squadre sopra il punteggio -->
            <div class="flex justify-between items-end mb-2">
                <h2 id="score-team1-name" class="text-3xl font-bold text-gray-200">POLIS</h2>
                <h2 id="score-team2-name" class="text-3xl font-bold text-gray-200">Squadra 2</h2>
            </div>

            <div class="score-display">
                <span id="score-team1" class="score-digit">0</span>
                <span>-</span>
                <span id="score-team2" class="score-digit">0</span>
            </div>

            <div class="teams-container">
                <!-- Squadra 1 -->
                <div class="team">
                    <h2 id="team1-title" class="team-title">POLIS</h2>
                    <!-- First row: Gol and Tiro side by side -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-goal" data-team="1" data-type="goal" data-action="add">Gol</button>
                            <button class="btn btn-remove-goal mt-2" data-team="1" data-type="goal" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-tiri" data-team="1" data-type="shot" data-action="add">Tiro</button>
                            <button class="btn btn-remove-stats mt-2" data-team="1" data-type="shot" data-action="remove">-</button>
                        </div>
                    </div>
                    <!-- Second row: Corner and Fallo side by side -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-corner" data-team="1" data-type="corner" data-action="add">Corner</button>
                            <button class="btn btn-remove-stats mt-2" data-team="1" data-type="corner" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-falli" data-team="1" data-type="foul" data-action="add">Fallo</button>
                            <button class="btn btn-remove-stats mt-2" data-team="1" data-type="foul" data-action="remove">-</button>
                        </div>
                    </div>
                    <!-- Third row: Yellow and Red cards side by side -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-yellow-card" data-team="1" data-type="yellow-card" data-action="add">
                                <img src="icons8-cartellino-giallo-calcio-96.png" alt="Cartellino Giallo">
                            </button>
                            <button class="btn btn-remove-stats mt-2" data-team="1" data-type="yellow-card" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-red-card" data-team="1" data-type="red-card" data-action="add">
                                <img src="icons8-cartellino-rosso-calcio-96 (1).png" alt="Cartellino Rosso">
                            </button>
                            <button class="btn btn-remove-stats mt-2" data-team="1" data-type="red-card" data-action="remove">-</button>
                        </div>
                    </div>
                </div>

                <!-- Squadra 2 -->
                <div class="team">
                    <h2 id="team2-name" class="team-title">Squadra 2</h2>
                    <!-- First row: Gol and Tiro side by side -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-goal" data-team="2" data-type="goal" data-action="add">Gol</button>
                            <button class="btn btn-remove-goal mt-2" data-team="2" data-type="goal" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-tiri" data-team="2" data-type="shot" data-action="add">Tiro</button>
                            <button class="btn btn-remove-stats mt-2" data-team="2" data-type="shot" data-action="remove">-</button>
                        </div>
                    </div>
                    <!-- Second row: Corner and Fallo side by side -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-corner" data-team="2" data-type="corner" data-action="add">Corner</button>
                            <button class="btn btn-remove-stats mt-2" data-team="2" data-type="corner" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-stats-add btn-falli" data-team="2" data-type="foul" data-action="add">Fallo</button>
                            <button class="btn btn-remove-stats mt-2" data-team="2" data-type="foul" data-action="remove">-</button>
                        </div>
                    </div>
                    <!-- Third row: Yellow and Red cards side by side -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="flex flex-col items-center">
                            <button class="btn btn-yellow-card" data-team="2" data-type="yellow-card" data-action="add">
                                <img src="icons8-cartellino-giallo-calcio-96.png" alt="Cartellino Giallo">
                            </button>
                            <button class="btn btn-remove-stats mt-2" data-team="2" data-type="yellow-card" data-action="remove">-</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="btn btn-red-card" data-team="2" data-type="red-card" data-action="add">
                                <img src="icons8-cartellino-rosso-calcio-96 (1).png" alt="Cartellino Rosso">
                            </button>
                            <button class="btn btn-remove-stats mt-2" data-team="2" data-type="red-card" data-action="remove">-</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sezione Statistiche -->
            <div class="stats-container">
                <!-- Statistiche Squadra 1 -->
                <div class="stats-team">
                    <h3 class="team-title">Statistiche</h3>
                    <h4 id="stats-team1-title" class="team-name" style="margin-top: 0.5rem; margin-bottom: 1rem; font-size: 1.25rem; color: #94a3b8;">POLIS</h4>
                    <div class="stat-item">
                        <span>Gol fatti</span>
                        <span id="goals-team1">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Gol subiti</span>
                        <span id="goals-team2-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Tiri in porta</span>
                        <span id="shots-team1">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Tiri subiti</span>
                        <span id="shots-team2-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Corner</span>
                        <span id="corners-team1">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Corner subiti</span>
                        <span id="corners-team2-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Falli</span>
                        <span id="fouls-team1">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Falli subiti</span>
                        <span id="fouls-team2-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Cartellini gialli</span>
                        <span id="yellow-cards-team1">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Cartellini rossi</span>
                        <span id="red-cards-team1">0</span>
                    </div>
		    <div id="shooters-list-1" class="scorer-list">
    			<h4>Tiri:</h4>
		    </div>
                    <div id="scorers-list-1" class="scorer-list">
                        <h4>Marcatori:</h4>
                    </div>
                    <div id="cards-list-1" class="cards-list">
                        <h4>Cartellini:</h4>
                    </div>
                    <div id="period-stats-team1" class="period-stats">
                        <!-- Period breakdown will be inserted here -->
                    </div>
                </div>

                <!-- Statistiche Squadra 2 -->
                <div class="stats-team">
                    <h3 class="team-title">Statistiche</h3>
                    <h4 class="team-name" id="stats-team2-title" style="margin-top: 0.5rem; margin-bottom: 1rem; font-size: 1.25rem; color: #94a3b8;">Squadra 2</h4>
                    <div class="stat-item">
                        <span>Gol fatti</span>
                        <span id="goals-team2">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Gol subiti</span>
                        <span id="goals-team1-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Tiri in porta</span>
                        <span id="shots-team2">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Tiri subiti</span>
                        <span id="shots-team1-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Corner</span>
                        <span id="corners-team2">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Corner subiti</span>
                        <span id="corners-team1-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Falli</span>
                        <span id="fouls-team2">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Falli subiti</span>
                        <span id="fouls-team1-taken">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Cartellini gialli</span>
                        <span id="yellow-cards-team2">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Cartellini rossi</span>
                        <span id="red-cards-team2">0</span>
                    </div>
                    <div id="scorers-list-2" class="scorer-list">
                        <h4>Marcatori:</h4>
                    </div>
                    <div id="cards-list-2" class="cards-list">
                        <h4>Cartellini:</h4>
                    </div>
                    <div id="period-stats-team2" class="period-stats">
                        <!-- Period breakdown will be inserted here -->
                    </div>
                </div>
            </div>
            
            <!-- Sezione Note -->
            <div class="notes-container mt-6">
                <h3 class="text-lg font-semibold mb-3 text-center text-white">Note Partita</h3>
                <textarea 
                    id="match-notes" 
                    placeholder="Inserisci qui le note della partita..." 
                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white resize-none focus:outline-none focus:border-blue-400"
                    rows="3"
                ></textarea>
            </div>
            
            <!-- Pulsanti di azione -->
            <div class="flex justify-center items-center mt-8 gap-4 flex-wrap">
                <button id="reset-button" class="btn btn-reset flex items-center justify-center gap-2">RESET</button>
                <button id="save-button" class="btn btn-save flex items-center justify-center">Salva</button>
                <button id="share-button" class="btn btn-share flex items-center justify-center">Condividi</button>
                <button id="show-history-button" class="btn btn-history flex items-center justify-center gap-2">STORICO</button>
            </div>
            
            <!-- Messaggio di cooldown per il salvataggio -->
            <div id="save-cooldown-message" class="text-center mt-4 text-yellow-400 font-semibold" style="display: none;">
                Salvataggio effettuato, puoi salvare una nuova partita tra <span id="cooldown-timer">60</span> secondi
            </div>
        </div>
    </div>

    <!-- All modals here -->
    <!-- Player selection modal -->
    <div id="player-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Chi ha segnato?</div>
            <div id="player-list" class="player-list">
                <!-- Player buttons will be added here via JavaScript -->
            </div>
            <button id="cancel-player-selection-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
        </div>
    </div>

    <!-- Remove confirmation modal -->
    <div id="remove-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="remove-modal-header"></div>
            <p class="text-gray-400 mb-6" id="remove-modal-message"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-remove-button" class="btn btn-reset px-8">Sì, Rimuovi</button>
                <button id="cancel-remove-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Reset confirmation modal -->
    <div id="reset-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Sei sicuro di voler resettare?</div>
            <p class="text-gray-400 mb-6">Tutti i dati della partita andranno persi.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-reset-button" class="btn btn-reset px-8">Sì, Reset</button>
                <button id="cancel-reset-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Timer setup modal -->
    <div id="timer-setup-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Imposta il tempo</div>
            <div class="flex justify-center gap-2 mb-4">
                <input type="number" id="timer-minutes-input" class="modal-input w-20" value="18" min="0" max="99">
                <span class="text-xl font-bold">:</span>
                <input type="number" id="timer-seconds-input" class="modal-input w-20" value="0" min="0" max="59">
            </div>
            <p class="text-gray-400 mb-6">Minuti e Secondi</p>
            <button id="set-timer-button" class="btn btn-goal px-8">Imposta</button>
        </div>
    </div>

    <!-- Period selection modal -->
    <div id="period-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Seleziona il Tempo</div>
            <p class="text-gray-400 mb-6">Quale tempo stai iniziando?</p>
            <div class="flex flex-col gap-3 mb-6">
                <button id="select-period-1" class="btn btn-goal w-full">1° Tempo</button>
                <button id="select-period-2" class="btn btn-goal w-full">2° Tempo</button>
                <button id="select-period-3" class="btn btn-goal w-full" style="display: none;">3° Tempo</button>
            </div>
            <button id="cancel-period-selection" class="btn bg-gray-500 hover:bg-gray-600 w-full">Annulla</button>
        </div>
    </div>

    <!-- History modal -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content max-w-4xl">
            <div class="modal-header">Storico Partite</div>
            <div class="history-content">
                <!-- Sezione Riepilogo Statistiche Totali -->
                <div class="history-section">
                   <!--<h3 class="history-section-title">Riepilogo Statistiche Totali</h3> -->
                    <div>
                        <span>Partite giocate totali: <span id="total-matches-played">0</span></span>
                    </div>
                    
                    <!-- Tabella Risultati Partite -->
                    <table class="scorers-table" style="margin-top: 1rem;">
                        <thead>
                            <tr>
                                <th>Vinte</th>
                                <th>Perse</th>
                                <th>Pareggiate</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="total-matches-won">0</td>
                                <td id="total-matches-lost">0</td>
                                <td id="total-matches-drawn">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Sezione Classifica Marcatori -->
                <div class="history-section">
                    <h3 class="history-section-title">🏆Classifica Marcatori🏆</h3>
                    <table class="scorers-table">
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Giocatore</th>
                                <th>Gol</th>
                            </tr>
                        </thead>
                        <tbody id="scorers-table-body">
                            <!-- La tabella verrà popolata da JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Sezione Riepilogo Statistiche -->
                <div class="history-section">
                    <h3 class="history-section-title">Riepilogo Statistiche Totali</h3>
                    <table class="scorers-table">
                        <thead>
                            <tr>
                                <th>Statistica</th>
                                <th>Fatti</th>
                                <th>Subiti</th>
                            </tr>
                        </thead>
                        <tbody id="summary-stats-table-body">
                            <tr>
                                <td>Gol</td>
                                <td id="total-goals-made">0</td>
                                <td id="total-goals-conceded">0</td>
                            </tr>
                            <tr>
                                <td>Tiri</td>
                                <td id="total-shots-made">0</td>
                                <td id="total-shots-conceded">0</td>
                            </tr>
                            <tr>
                                <td>Corner</td>
                                <td id="total-corners-made">0</td>
                                <td id="total-corners-conceded">0</td>
                            </tr>
                            <tr>
                                <td>Falli</td>
                                <td id="total-fouls-made">0</td>
                                <td id="total-fouls-conceded">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Sezione Storico Partite -->
                <div class="history-section">
                    <h3 class="history-section-title">Partite Giocate</h3>
                    <div class="mb-4">
                        <label for="month-filter" class="block text-sm font-medium mb-2">Filtra per mese:</label>
                        <select id="month-filter" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 text-white">
                            <option value="all">Tutti i mesi</option>
                        </select>
                    </div>
                    <div id="history-list" class="history-list">
                        <!-- History items will be added here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-history-button" class="btn btn-back-login mt-4 px-8">Indietro</button>
            </div>
        </div>
    </div>

    <!-- Delete match confirmation modal -->
    <div id="delete-match-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Elimina Partita</div>
            <p class="text-gray-400 mb-6">Sei sicuro di voler eliminare questa partita dallo storico?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-delete-match-button" class="btn btn-reset px-8">Sì, Elimina</button>
                <button id="cancel-delete-match-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Password input modal for match deletion -->
    <div id="password-delete-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Conferma Password</div>
            <p class="text-gray-400 mb-4">Inserisci la password della società per confermare l'eliminazione:</p>
            <input type="password" id="delete-password-input" placeholder="Password società" class="w-full mb-4 modal-input">
            <div id="password-error" class="text-red-400 mb-4 hidden">Password non corretta</div>
            <div class="flex justify-center gap-4">
                <button id="confirm-password-delete-button" class="btn btn-reset px-8">Conferma</button>
                <button id="cancel-password-delete-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Lineup selection modal -->
    <div id="lineup-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Seleziona Formazione</div>
            <p class="text-gray-400 mb-4 text-center">Seleziona i giocatori che partecipano alla partita</p>
            <div id="lineup-player-list" class="player-list" style="max-height: 400px; overflow-y: auto;">
                <!-- Player checkboxes will be added here via JavaScript -->
            </div>
            <div class="flex justify-center gap-4 mt-4">
                <button id="confirm-lineup-button" class="btn btn-goal px-8">Conferma</button>
                <button id="cancel-lineup-button" class="btn bg-gray-500 hover:bg-gray-600 px-8">Annulla</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let scoreTeam1 = 0;
        let scoreTeam2 = 0;
        let shotsTeam1 = 0;
        let cornersTeam1 = 0;
        let foulsTeam1 = 0;
        let yellowCardsTeam1 = 0;
        let redCardsTeam1 = 0;
        let shotsTeam2 = 0;
        let cornersTeam2 = 0;
        let foulsTeam2 = 0;
        let yellowCardsTeam2 = 0;
        let redCardsTeam2 = 0;
        let matchNotes = '';
        let team1Shooters = {}; // Oggetto per contare i tiri per giocatore

        // Period-based statistics storage
        let eventsByPeriod = {
            team1: {
                shots: { '1': 0, '2': 0, '3': 0 },
                corners: { '1': 0, '2': 0, '3': 0 },
                fouls: { '1': 0, '2': 0, '3': 0 },
                yellowCards: { '1': 0, '2': 0, '3': 0 },
                redCards: { '1': 0, '2': 0, '3': 0 }
            },
            team2: {
                shots: { '1': 0, '2': 0, '3': 0 },
                corners: { '1': 0, '2': 0, '3': 0 },
                fouls: { '1': 0, '2': 0, '3': 0 },
                yellowCards: { '1': 0, '2': 0, '3': 0 },
                redCards: { '1': 0, '2': 0, '3': 0 }
            }
        };
        let team1Scorers = [];
        let team2Scorers = [];
        let team1Cards = []; // Array for team1 yellow and red cards with player details
        let team2Cards = []; // Array for team2 yellow and red cards with player details
        let matchLineup = []; // Array for selected players in lineup
        let pendingRemovalAction = null;
        let totalSeconds = 18 * 60;
        let timerInterval = null;
        let isRunning = false;
        let lastSetSeconds = 18 * 60;
        let currentPeriod = null; // Track current period (1, 2, or 3)
        let recoverySeconds = 0; // Secondi di recupero
        let isInRecovery = false; // Indica se siamo nel tempo di recupero
        
        // New timer system variables based on real time
        let timerStartTime = null; // When the timer was started (Date.now())
        let pausedDuration = 0; // Total time spent paused (in milliseconds)
        let pauseStartTime = null; // When the timer was paused (Date.now())

        // Audio preloading per fischio.mp3
        let fischioAudio;

        // History variables
        let matchHistory = [];
        let historyListener = null;
        let pendingDeleteMatchId = null;
        let isFirstHistoryOpen = true; // Track if this is the first time opening history

        // Screen wake lock variables
        let wakeLock = null;
        let wakeLockSupported = false;
        let wakeLockFallbackShown = false;

        // Save cooldown variables
        let saveButtonCooldownActive = false;
        let saveCooldownTimer = null;
        let saveCooldownSeconds = 0;

        // Vibration/Haptic feedback function
        function vibrate(pattern = [100]) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Visual confirmation popup for button actions
        function showActionConfirmation(text = '+') {
            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'action-confirmation';
            popup.textContent = text;
            
            // Add to body
            document.body.appendChild(popup);
            
            // Remove after animation completes (1 second)
            setTimeout(() => {
                popup.remove();
            }, 1000);
        }

        /**
         * Navigation History Management System
         * Manages browser history to allow back button navigation between app screens
         */
        let navigationHistoryEnabled = true;
        let currentScreen = 'login'; // Track current screen state
        
        // Initialize history state on page load
        function initializeNavigationHistory() {
            // Set initial state
            history.replaceState({ screen: 'login' }, '', '');
            currentScreen = 'login';
            
            // Listen for popstate events (back button)
            window.addEventListener('popstate', handlePopState);
        }
        
        // Handle browser back button
        function handlePopState(event) {
            if (!navigationHistoryEnabled) return;
            
            const state = event.state;
            if (!state || !state.screen) {
                // If no state, default to login
                navigateToScreen('login', false);
                return;
            }
            
            // Navigate to the screen without pushing a new history entry
            navigateToScreen(state.screen, false);
        }
        
        // Navigate to a specific screen
        function navigateToScreen(screenName, pushState = true) {
            console.log(`Navigating to screen: ${screenName}, pushState: ${pushState}`);
            
            // Push history state if requested
            if (pushState && navigationHistoryEnabled) {
                history.pushState({ screen: screenName }, '', '');
            }
            
            currentScreen = screenName;
            
            // Route to appropriate screen handler
            switch(screenName) {
                case 'login':
                    showLoginScreen();
                    break;
                case 'menu':
                    showMenuScreen();
                    break;
                case 'welcome':
                    showWelcomeScreenNav();
                    break;
                case 'players':
                    showPlayersManagementNav();
                    break;
                case 'history':
                    showHistoryModalNav();
                    break;
                case 'game':
                    showGameScreen();
                    break;
                default:
                    console.warn(`Unknown screen: ${screenName}`);
            }
        }
        
        // Screen display functions for navigation
        function showLoginScreen() {
            menuScreen.style.display = 'none';
            welcomeScreen.style.display = 'none';
            playersManagementScreen.style.display = 'none';
            mainApp.style.display = 'none';
            loginScreen.style.display = 'flex';
            document.body.classList.add('login-background');
            
            // Hide history modal if open
            const historyModal = document.getElementById('history-modal');
            if (historyModal) {
                historyModal.classList.remove('is-active');
            }
            
            // Clear current club data
            currentClub = null;
            currentPlayers = [...defaultPlayers];
            players = [...defaultPlayers];
            
            // Clear login form
            document.getElementById('login-code-input').value = '';
            document.getElementById('login-error').classList.add('hidden');
        }
        
        function showMenuScreen() {
            loginScreen.style.display = 'none';
            welcomeScreen.style.display = 'none';
            playersManagementScreen.style.display = 'none';
            mainApp.style.display = 'none';
            menuScreen.style.display = 'flex';
            document.body.classList.remove('login-background');
            
            // Hide history modal if open
            const historyModal = document.getElementById('history-modal');
            if (historyModal) {
                historyModal.classList.remove('is-active');
            }
        }
        
        function showWelcomeScreenNav() {
            loginScreen.style.display = 'none';
            menuScreen.style.display = 'none';
            playersManagementScreen.style.display = 'none';
            mainApp.style.display = 'none';
            welcomeScreen.style.display = 'flex';
            
            // Hide history modal if open
            const historyModal = document.getElementById('history-modal');
            if (historyModal) {
                historyModal.classList.remove('is-active');
            }
        }
        
        function showPlayersManagementNav() {
            loginScreen.style.display = 'none';
            menuScreen.style.display = 'none';
            welcomeScreen.style.display = 'none';
            mainApp.style.display = 'none';
            playersManagementScreen.style.display = 'flex';
            
            // Hide history modal if open
            const historyModal = document.getElementById('history-modal');
            if (historyModal) {
                historyModal.classList.remove('is-active');
            }
            
            // Update UI
            updatePlayersListUI();
        }
        
        function showHistoryModalNav() {
            // History modal is shown over menu, so go back to menu
            navigateToScreen('menu', false);
            // Then show history modal
            renderHistory(!isFirstHistoryOpen);
            if (isFirstHistoryOpen) {
                isFirstHistoryOpen = false;
            }
            document.getElementById('history-modal').classList.add('is-active');
        }
        
        function showGameScreen() {
            loginScreen.style.display = 'none';
            menuScreen.style.display = 'none';
            welcomeScreen.style.display = 'none';
            playersManagementScreen.style.display = 'none';
            mainApp.style.display = 'block';
            
            // Hide history modal if open
            const historyModal = document.getElementById('history-modal');
            if (historyModal) {
                historyModal.classList.remove('is-active');
            }
        }

        /**
         * Salvataggio automatico dello stato della partita in localStorage
         * Salva tutti i dati correnti della partita per permettere il ripristino in caso di reload accidentale
         * Include stato completo del timer e timestamp dei marcatori per ripristino accurato
         */
        function saveCurrentGameState() {
            // Calcola il tempo di gioco corrente per i marcatori
            const currentGameTime = getCurrentGameTimeForScoring();
            
            const gameState = {
                // Punteggi e statistiche base
                scoreTeam1,
                scoreTeam2,
		team1Shooters,
                shotsTeam1,
                cornersTeam1,
                foulsTeam1,
                yellowCardsTeam1,
                redCardsTeam1,
                shotsTeam2,
                cornersTeam2,
                foulsTeam2,
                yellowCardsTeam2,
                redCardsTeam2,
                
                // Marcatori con timestamp di inserimento
                team1Scorers,
                team2Scorers,
                
                // Cartellini con dettagli giocatori
                team1Cards,
                team2Cards,
                
                // Note partita
                matchNotes: document.getElementById('match-notes')?.value.trim() || '',
                
                // Statistiche per periodo
                eventsByPeriod,
                
                // Timer - stato completo per ripristino accurato
                timer: {
                    totalSeconds,
                    isRunning,
                    currentPeriod,
                    timerStartTime,
                    pausedDuration,
                    pauseStartTime,
                    lastSetSeconds,
                    recoverySeconds,
                    isInRecovery,
                    // Timestamp di salvataggio per calcoli di recupero accurati
                    saveTimestamp: Date.now(),
                    // Stato del timer al momento del salvataggio
                    timerState: isRunning ? 'running' : (timerStartTime ? 'paused' : 'stopped')
                },
                
                // Backward compatibility - mantieni le vecchie proprietà
                totalSeconds,
                isRunning,
                currentPeriod,
                timerStartTime,
                pausedDuration,
                pauseStartTime,
                lastSetSeconds,
                
                // Impostazioni squadre
                teamNumPeriods,
                currentClub,
                currentPlayers,
                
                // Match lineup
                matchLineup,
                
                // Nomi squadre se disponibili
                team2Name: document.getElementById('team2-name')?.textContent || '',
                
                // Timestamp del salvataggio
                savedAt: Date.now(),
                
                // Versione per compatibilità futura
                version: '1.7'
            };
            
            try {
                localStorage.setItem('polis_current_game_state', JSON.stringify(gameState));
                console.log('🔄 Stato partita salvato automaticamente');
            } catch (error) {
                console.error('❌ Errore nel salvataggio dello stato:', error);
            }
        }

        /**
         * Calcola il tempo di gioco corrente per l'inserimento dei marcatori
         * Restituisce il tempo in minuti e secondi trascorsi dall'inizio del timer
         */
        function getCurrentGameTimeForScoring() {
            if (!timerStartTime) {
                return { minutes: 0, seconds: 0, totalSeconds: 0 };
            }
            
            let elapsedMs;
            if (isRunning) {
                // Timer in corso: calcola tempo trascorso dal presente
                elapsedMs = (Date.now() - timerStartTime) - pausedDuration;
            } else if (pauseStartTime) {
                // Timer in pausa: usa il tempo al momento della pausa
                elapsedMs = (pauseStartTime - timerStartTime) - pausedDuration;
            } else {
                // Timer fermato o resetato
                return { minutes: 0, seconds: 0, totalSeconds: 0 };
            }
            
            const elapsedSeconds = Math.max(0, Math.floor(elapsedMs / 1000));
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            
            return { 
                minutes, 
                seconds, 
                totalSeconds: elapsedSeconds,
                formattedTime: `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
            };
        }

        /**
         * Ripristino dello stato della partita da localStorage
         * Carica e ripristina tutti i dati della partita precedentemente salvati
         * Include ripristino accurato del timer e marcatori con timestamp
         */
        function restoreGameState() {
            try {
                const savedState = localStorage.getItem('polis_current_game_state');
                if (!savedState) {
                    console.log('📭 Nessuno stato salvato trovato');
                    return false;
                }
                
                const gameState = JSON.parse(savedState);
                
                // Verifica se lo stato è recente (entro 24 ore)
                const timeDiff = Date.now() - gameState.savedAt;
                const maxAge = 24 * 60 * 60 * 1000; // 24 ore in millisecondi
                
                if (timeDiff > maxAge) {
                    console.log('⏰ Stato salvato troppo vecchio, rimosso');
                    localStorage.removeItem('polis_current_game_state');
                    return false;
                }
                
                // Ripristina le variabili globali
                scoreTeam1 = gameState.scoreTeam1 || 0;
                scoreTeam2 = gameState.scoreTeam2 || 0;
                shotsTeam1 = gameState.shotsTeam1 || 0;
                cornersTeam1 = gameState.cornersTeam1 || 0;
                foulsTeam1 = gameState.foulsTeam1 || 0;
                yellowCardsTeam1 = gameState.yellowCardsTeam1 || 0;
                redCardsTeam1 = gameState.redCardsTeam1 || 0;
                shotsTeam2 = gameState.shotsTeam2 || 0;
                cornersTeam2 = gameState.cornersTeam2 || 0;
                foulsTeam2 = gameState.foulsTeam2 || 0;
                yellowCardsTeam2 = gameState.yellowCardsTeam2 || 0;
                redCardsTeam2 = gameState.redCardsTeam2 || 0;
                
                team1Scorers = gameState.team1Scorers || [];
                team2Scorers = gameState.team2Scorers || [];
		team1Shooters = gameState.team1Shooters || {};
		// Aggiorna subito la lista visiva se ci sono dati
		setTimeout(updateShootersList, 100);
                team1Cards = gameState.team1Cards || [];
                team2Cards = gameState.team2Cards || [];
                matchLineup = gameState.matchLineup || [];
                eventsByPeriod = gameState.eventsByPeriod || { 
                    team1: { 
                        shots: {'1': 0, '2': 0, '3': 0}, 
                        corners: {'1': 0, '2': 0, '3': 0}, 
                        fouls: {'1': 0, '2': 0, '3': 0},
                        yellowCards: {'1': 0, '2': 0, '3': 0},
                        redCards: {'1': 0, '2': 0, '3': 0}
                    }, 
                    team2: { 
                        shots: {'1': 0, '2': 0, '3': 0}, 
                        corners: {'1': 0, '2': 0, '3': 0}, 
                        fouls: {'1': 0, '2': 0, '3': 0},
                        yellowCards: {'1': 0, '2': 0, '3': 0},
                        redCards: {'1': 0, '2': 0, '3': 0}
                    } 
                };
                
                // Ripristina le note della partita
                matchNotes = gameState.matchNotes || '';
                const notesElement = document.getElementById('match-notes');
                if (notesElement) {
                    notesElement.value = matchNotes;
                }
                
                // Ripristino timer migliorato - gestisce stato completo del timer
                if (gameState.timer) {
                    // Versione con stato timer migliorato (priorità al nuovo formato)
                    const timerData = gameState.timer;
                    totalSeconds = timerData.totalSeconds || (18 * 60);
                    currentPeriod = timerData.currentPeriod;
                    lastSetSeconds = timerData.lastSetSeconds || (18 * 60);
                    recoverySeconds = timerData.recoverySeconds || 0;
                    isInRecovery = timerData.isInRecovery || false;
                    
                    console.log(`🔄 Ripristino timer: totalSeconds=${totalSeconds}, lastSetSeconds=${lastSetSeconds}, timerState=${timerData.timerState}, isInRecovery=${isInRecovery}, recoverySeconds=${recoverySeconds}`);
                    
                    // Ripristina stato timer con calcoli temporali accurati
                    if (timerData.timerState === 'running' && timerData.timerStartTime) {
                        // Il timer era in corso: calcola il tempo trascorso durante l'assenza
                        const timeSinceReload = Date.now() - timerData.saveTimestamp;
                        timerStartTime = timerData.timerStartTime;
                        pausedDuration = timerData.pausedDuration || 0;
                        pauseStartTime = null;
                        
                        // Aggiorna totalSeconds considerando il tempo trascorso durante il reload
                        const additionalElapsed = Math.floor(timeSinceReload / 1000);
                        const originalElapsed = Math.floor(((timerData.saveTimestamp - timerStartTime) - pausedDuration) / 1000);
                        const newElapsed = originalElapsed + additionalElapsed;
                        totalSeconds = Math.max(0, lastSetSeconds - newElapsed);
                        
                        // Se eravamo in recovery time, aggiorna recoverySeconds
                        if (isInRecovery || newElapsed > lastSetSeconds) {
                            isInRecovery = true;
                            recoverySeconds = newElapsed - lastSetSeconds;
                        }
                        
                        // Non riavviare automaticamente il timer per sicurezza
                        isRunning = false;
                        
                        console.log(`⏱️ Timer era in corso: recuperati ${additionalElapsed}s durante il reload, nuovo totalSeconds=${totalSeconds}, recoverySeconds=${recoverySeconds}`);
                    } else if (timerData.timerState === 'paused' && timerData.timerStartTime) {
                        // Il timer era in pausa: ripristina lo stato esatto
                        timerStartTime = timerData.timerStartTime;
                        pausedDuration = timerData.pausedDuration || 0;
                        pauseStartTime = timerData.pauseStartTime;
                        totalSeconds = timerData.totalSeconds;
                        isRunning = false;
                        
                        console.log('⏸️ Timer era in pausa: stato ripristinato esattamente');
                    } else {
                        // Timer non era attivo
                        timerStartTime = null;
                        pausedDuration = 0;
                        pauseStartTime = null;
                        isRunning = false;
                        
                        console.log('⏹️ Timer non era attivo');
                    }
                } else {
                    // Backward compatibility con versione precedente (o stato timer mancante)
                    totalSeconds = gameState.totalSeconds || (18 * 60);
                    isRunning = false; // Non riprendere automaticamente il timer
                    currentPeriod = gameState.currentPeriod;
                    lastSetSeconds = gameState.lastSetSeconds || (18 * 60);
                    timerStartTime = gameState.timerStartTime || null;
                    pausedDuration = gameState.pausedDuration || 0;
                    pauseStartTime = gameState.pauseStartTime || null;
                    
                    console.log(`🔙 Backward compatibility: totalSeconds=${totalSeconds}, lastSetSeconds=${lastSetSeconds}`);
                }
                
                // Ripristina le impostazioni
                teamNumPeriods = gameState.teamNumPeriods || 2;
                currentClub = gameState.currentClub;
                currentPlayers = gameState.currentPlayers || [];
                
                // Ripristina il nome della squadra 2 se presente
                if (gameState.team2Name) {
                    // Aggiorna tutti gli elementi UI che mostrano il nome della squadra 2
                    const team2NameElement = document.getElementById('team2-name');
                    const scoreTeam2NameElement = document.getElementById('score-team2-name');
                    const statsTeam2TitleElement = document.getElementById('stats-team2-title');
                    
                    if (team2NameElement) {
                        team2NameElement.textContent = gameState.team2Name;
                    }
                    if (scoreTeam2NameElement) {
                        scoreTeam2NameElement.textContent = gameState.team2Name;
                    }
                    if (statsTeam2TitleElement) {
                        statsTeam2TitleElement.textContent = gameState.team2Name;
                    }
                }
                
                console.log('✅ Stato partita ripristinato con successo');
                
                // Crea oggetto con informazioni di ripristino per la notifica
                const restorationInfo = {
                    hasTimer: gameState.timer && (gameState.timer.timerState !== 'stopped'),
                    hasScorers: (team1Scorers.length > 0 || team2Scorers.length > 0),
                    timerState: gameState.timer ? gameState.timer.timerState : 'unknown',
                    scorersCount: team1Scorers.length + team2Scorers.length
                };
                
                return restorationInfo;
                
            } catch (error) {
                console.error('❌ Errore nel ripristino dello stato:', error);
                localStorage.removeItem('polis_current_game_state');
                return false;
            }
        }

        /**
         * Cancella lo stato salvato della partita corrente
         * Da chiamare quando si inizia una nuova partita o si resetta
         */
        function clearCurrentGameState() {
            localStorage.removeItem('polis_current_game_state');
            console.log('🗑️ Stato partita corrente cancellato');
        }

        /**
         * Ripristina direttamente la partita salvata bypassando login e menu
         * Porta l'utente direttamente nella partita con tutti i dati ripristinati
         */
        function restoreAndGoToSavedGame() {
            try {
                // Controlla se c'è uno stato salvato
                const savedState = localStorage.getItem('polis_current_game_state');
                if (!savedState) {
                    console.log('❌ Nessuno stato salvato disponibile');
                    return false;
                }

                const gameState = JSON.parse(savedState);
                
                // Verifica se lo stato è recente (entro 24 ore)
                const timeDiff = Date.now() - gameState.savedAt;
                const maxAge = 24 * 60 * 60 * 1000; // 24 ore in millisecondi
                
                if (timeDiff > maxAge) {
                    console.log('⏰ Stato salvato troppo vecchio');
                    localStorage.removeItem('polis_current_game_state');
                    return false;
                }

                // Ripristina lo stato completamente (già fatto dalla funzione restoreGameState)
                const restorationInfo = restoreGameState();
                if (!restorationInfo) {
                    return false;
                }

                // Ripristina i giocatori se disponibili
                if (gameState.currentPlayers && gameState.currentPlayers.length > 0) {
                    players = [...gameState.currentPlayers];
                }

                // Nascondi tutti gli altri schermi e vai direttamente alla partita
                loadingScreen.style.display = 'none';
                loginScreen.style.display = 'none';
                menuScreen.style.display = 'none';
                welcomeScreen.style.display = 'none';
                playersManagementScreen.style.display = 'none';
                document.body.classList.remove('login-background');
                
                // Mostra l'app principale
                mainApp.style.display = 'block';
                
                // Nascondi il tasto dello storico quando si rientra in una partita in corso
                const historyButton = document.getElementById('show-history-button');
                if (historyButton) {
                    historyButton.style.display = 'none';
                }
                
                // Aggiorna tutti i display con i dati ripristinati
                updateAllDisplays();
                
                // Aggiorna il display del timer
                updateTimerDisplay();
                
                // Per il timer: se era in corso (running), riattivalo automaticamente dopo un breve delay
                // per assicurarci che tutti i display siano aggiornati
                setTimeout(() => {
                    if (gameState.timer && gameState.timer.timerState === 'running') {
                        console.log('⏱️ Riavvio automatico del timer dalla posizione corretta');
                        
                        // Trova e clicca il pulsante di avvio per riattivare il timer
                        const startButton = document.getElementById('start-timer-button');
                        if (startButton) {
                            // Simula click sul pulsante start per riattivare il timer
                            startButton.click();
                            console.log('✅ Timer riavviato tramite click automatico sul pulsante');
                        } else {
                            console.log('⚠️ Pulsante start timer non trovato');
                        }
                    } else if (gameState.timer && gameState.timer.timerState === 'paused') {
                        console.log('⏸️ Timer rimane in pausa come da stato salvato');
                    }
                }, 100);
                
                console.log('🎮 Partita salvata ripristinata e avviata direttamente');
                return true;
                
            } catch (error) {
                console.error('❌ Errore nel ripristino diretto della partita:', error);
                return false;
            }
        }

        /**
         * Mostra un messaggio di notifica per informare l'utente del ripristino
         * Include informazioni specifiche su timer e marcatori ripristinati
         * Quando mostrato nella schermata di login, il messaggio è cliccabile per entrare direttamente nella partita
         */
        function showGameStateRestoredMessage(restorationInfo = null) {
            const notification = document.createElement('div');
            
            // Verifica se siamo nella schermata di login
            const isOnLoginScreen = loginScreen.style.display !== 'none' && loginScreen.style.display !== '';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                font-weight: 600;
                font-size: 14px;
                max-width: 90%;
                text-align: center;
                opacity: 0;
                transition: opacity 0.3s ease;
                ${isOnLoginScreen ? 'cursor: pointer; user-select: none;' : ''}
            `;
            
            // Genera messaggio personalizzato basato su dove siamo
            let message = isOnLoginScreen 
                ? '🎮 Partita salvata trovata - Clicca per continuare!'
                : 'Partita ripristinata automaticamente dopo il reload';
            const details = [];
            
            if (restorationInfo && typeof restorationInfo === 'object') {
                if (restorationInfo.hasTimer) {
                    const timerStateText = restorationInfo.timerState === 'running' ? 'in corso' : 
                                         restorationInfo.timerState === 'paused' ? 'in pausa' : 'attivo';
                    details.push(`⏱️ Timer ${timerStateText}`);
                }
                
                if (restorationInfo.hasScorers) {
                    details.push(`⚽ ${restorationInfo.scorersCount} marcatori`);
                }
            }
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; justify-content: center; flex-direction: column;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">${isOnLoginScreen ? '🎮' : '🔄'}</span>
                        <span>${message}</span>
                    </div>
                    ${details.length > 0 ? `<div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">${details.join(' • ')}</div>` : ''}
                    ${isOnLoginScreen ? '<div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">Tocca qui per entrare nella partita</div>' : ''}
                </div>
            `;
            
            // Se siamo nella schermata di login, aggiungi il click handler
            if (isOnLoginScreen) {
                notification.addEventListener('click', () => {
                    console.log('🎯 Click su notifica partita salvata - ripristino diretto');
                    
                    // Nascondi la notifica immediatamente
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                    
                    // Ripristina e vai alla partita salvata
                    const success = restoreAndGoToSavedGame();
                    if (success) {
                        // Vibrazione di feedback per successo
                        vibrate([100, 50, 100]);
                    } else {
                        // Se fallisce, mostra un errore
                        alert('Errore nel ripristino della partita salvata');
                        vibrate([200, 100, 200]);
                    }
                });
                
                // Aggiungi effetto hover
                notification.addEventListener('mouseenter', () => {
                    notification.style.transform = 'translateX(-50%) scale(1.05)';
                    notification.style.background = 'linear-gradient(135deg, #059669, #047857)';
                });
                
                notification.addEventListener('mouseleave', () => {
                    notification.style.transform = 'translateX(-50%) scale(1)';
                    notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                });
            }
            
            document.body.appendChild(notification);
            
            // Animazione di entrata
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 100);
            
            // Rimozione automatica dopo 8 secondi se siamo nel login (più tempo per cliccare)
            // o 5 secondi se siamo nella partita
            const autoRemoveDelay = isOnLoginScreen ? 8000 : 5000;
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, autoRemoveDelay);
        }

        /**
         * Detects if Screen Wake Lock API is supported by the current browser
         * @returns {boolean} True if wake lock is supported
         */
        function isWakeLockSupported() {
            return 'wakeLock' in navigator && 'request' in navigator.wakeLock;
        }

        /**
         * Shows a fallback message for browsers that don't support Screen Wake Lock API
         * This is particularly useful for Safari on iOS and older browsers
         */
        function showWakeLockFallbackMessage() {
            if (wakeLockFallbackShown) return; // Show only once per session
            
            wakeLockFallbackShown = true;
            
            // Detect if we're on iOS Safari specifically
            const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && 
                               /Safari/.test(navigator.userAgent) && 
                               !/Chrome|CriOS|FxiOS/.test(navigator.userAgent);
            
            let message = '';
            let title = 'Mantieni lo schermo attivo';
            
            if (isIOSSafari) {
                message = `Per evitare che lo schermo si spenga durante la partita:
                
1. Vai in Impostazioni > Schermo e luminosità
2. Imposta "Blocco automatico" su "Mai"
3. Ricordati di riattivarlo dopo la partita

Oppure tocca periodicamente lo schermo per mantenerlo attivo.`;
            } else {
                message = `Il tuo browser non supporta il mantenimento automatico dello schermo attivo.
                
Per evitare che lo schermo si spenga:
• Tocca periodicamente lo schermo
• Modifica le impostazioni di risparmio energetico del dispositivo
• Considera l'uso di Chrome o Edge per una migliore esperienza`;
            }
            
            // Create and show a modal with the fallback instructions
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full text-white">
                    <h3 class="text-lg font-bold mb-4 text-yellow-400">${title}</h3>
                    <p class="text-sm leading-relaxed mb-6 whitespace-pre-line">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Ho capito
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-remove after 10 seconds if user doesn't interact
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    modal.remove();
                }
            }, 10000);
        }

        /**
         * Requests a screen wake lock to prevent the device from going to sleep
         * Includes comprehensive error handling and automatic retry logic
         */
        async function requestWakeLock() {
            // Check if we already have an active wake lock
            if (wakeLock && !wakeLock.released) {
                console.log('Screen wake lock already active');
                return;
            }
            
            try {
                // Check if Screen Wake Lock API is supported
                if (!isWakeLockSupported()) {
                    console.warn('Screen Wake Lock API not supported by this browser');
                    wakeLockSupported = false;
                    showWakeLockFallbackMessage();
                    return;
                }
                
                wakeLockSupported = true;
                
                // Request the wake lock
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('✅ Screen wake lock is active');
                
                // Add event listener for when the wake lock is released
                wakeLock.addEventListener('release', () => {
                    console.log('⚠️ Screen wake lock was released');
                    wakeLock = null;
                });
                
            } catch (err) {
                console.error('❌ Failed to request screen wake lock:', err);
                wakeLock = null;
                
                // Handle specific error cases
                if (err.name === 'NotAllowedError') {
                    console.warn('Screen wake lock permission denied by user or browser policy');
                } else if (err.name === 'AbortError') {
                    console.warn('Screen wake lock request was aborted');
                } else {
                    console.warn('Screen wake lock failed due to:', err.message);
                }
                
                // Show fallback message if wake lock fails
                if (!wakeLockFallbackShown) {
                    showWakeLockFallbackMessage();
                }
            }
        }

        /**
         * Releases the current screen wake lock if active
         */
        function releaseWakeLock() {
            if (wakeLock && !wakeLock.released) {
                try {
                    wakeLock.release();
                    console.log('🔓 Screen wake lock released manually');
                } catch (err) {
                    console.error('Error releasing wake lock:', err);
                }
            }
            wakeLock = null;
        }

        /**
         * Handles page visibility changes to maintain wake lock when page returns to foreground
         * This is crucial because wake locks are automatically released when the page is hidden
         */
        function handleVisibilityChange() {
            if (!document.hidden) {
                // Page became visible again
                console.log('📱 Page became visible - reactivating wake lock');
                
                // Re-request wake lock if it was previously supported
                if (wakeLockSupported || isWakeLockSupported()) {
                    requestWakeLock();
                }
                
                // Also update timer if it's running (existing functionality)
                if (typeof isRunning !== 'undefined' && isRunning) {
                    updateTimerDisplay();
                }
            } else {
                // Page became hidden
                console.log('🙈 Page became hidden - wake lock will be auto-released');
            }
        }

        /**
         * Initializes wake lock support detection and logs browser capabilities
         * This helps with debugging and provides early feedback about support
         */
        function initializeWakeLock() {
            wakeLockSupported = isWakeLockSupported();
            
            if (wakeLockSupported) {
                console.log('✅ Screen Wake Lock API is supported by this browser');
            } else {
                console.log('❌ Screen Wake Lock API is not supported by this browser');
                
                // Log browser info for debugging
                const browserInfo = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    isIOSSafari: /iPad|iPhone|iPod/.test(navigator.userAgent) && 
                                /Safari/.test(navigator.userAgent) && 
                                !/Chrome|CriOS|FxiOS/.test(navigator.userAgent)
                };
                console.log('🔍 Browser info:', browserInfo);
            }
        }

        // Current club data
        let currentClub = null;
        let teamNumPeriods = 2; // Default to 2 periods
        let currentPlayers = [];

        // Player list from original (fallback)
        const defaultPlayers = [
            "99 ALPA FEDERICO", "78 BECCARIS SEBASTIANO", "32 BEN MABROUK KEVIN", "23 BERLUSCONI NOAH",
            "1 BERNUCCI ROMEO", "18 BOERO GUGLIELMO", "22 BRIANO COSTANTINO", "28 CABASSI ROBERTO",
            "7 CALLIKU ANDREA", "4 CAZZULO MICHELE", "46 CONGIU ALESSIO", "20 DHAOUI OMAR",
            "5 DI DATO SIMONE", "77 DONALD BRYAN", "6 ESPOSITO EMANUELE", "25 GARDELLA ANDREA",
            "13 GENNARO EDOARDO", "91 GIOIA LEONARDO", "17 KHAY ADAM", "2 LAMKHAYAR AMIN",
            "29 LANNA MARK", "19 MARCHESE MATTEO", "47 MELLO CHRISTIAN", "61 MELLUSO MATTIA",
            "14 MONTEFIORI EDOARDO", "3 ODAGLIA ANDREA", "11 PELLICCI FRANCESCO", "90 PIGA GIOVANNI",
            "45 PINASCO ALESSANDRO", "10 POLLIO CESARE", "9 SCALA FEDERICO", "16 STANCHI FEDERICO",
            "21 TONINI LORENZO"
        ];

        // Current players array (will be updated based on club)
        let players = [...defaultPlayers];

        // DOM elements
        const loadingScreen = document.getElementById('loading-screen');
        const loginScreen = document.getElementById('login-screen');
        const menuScreen = document.getElementById('menu-screen');
        const playersManagementScreen = document.getElementById('players-management-screen');
        const welcomeScreen = document.getElementById('welcome-screen');
        const mainApp = document.getElementById('main-app');
        const startGameBtn = document.getElementById('start-game-btn');
        const welcomeOpponentName = document.getElementById('welcome-opponent-name');

        // Flag to track if login animations have been played
        let loginAnimationsPlayed = false;

        // Function to restart login animations (only on first load)
        function restartLoginAnimations() {
            // Only play animations if they haven't been played yet
            if (loginAnimationsPlayed) {
                return;
            }

            const loginLogo = document.querySelector('.login-logo');
            const loginForm = document.querySelector('.login-form');
            const loginAccessSection = document.querySelector('.login-access-section');
            const loginButtonSection = document.querySelector('.login-button-section');
            
            if (loginLogo && loginForm && loginAccessSection && loginButtonSection) {
                // Remove animation classes
                loginLogo.style.animation = 'none';
                loginForm.style.animation = 'none';
                loginAccessSection.style.animation = 'none';
                loginButtonSection.style.animation = 'none';
                
                loginForm.style.opacity = '0';
                loginAccessSection.style.opacity = '0';
                loginButtonSection.style.opacity = '0';
                
                // Force reflow
                loginLogo.offsetHeight;
                loginForm.offsetHeight;
                loginAccessSection.offsetHeight;
                loginButtonSection.offsetHeight;
                
                // Re-apply animations
                loginLogo.style.animation = 'fadeInUp 0.8s ease-out forwards';
                loginForm.style.animation = 'fadeInUp 0.8s ease-out 0.3s forwards';
                loginAccessSection.style.animation = 'slideInFromRight 0.6s ease-out 1.1s forwards';
                loginButtonSection.style.animation = 'slideInFromLeft 0.6s ease-out 1.4s forwards';
                
                // Mark animations as played
                loginAnimationsPlayed = true;
            }
        }

        // Function to be called when Firebase is ready
        window.onFirebaseReady = function() {
            console.log('Firebase is ready, showing login screen directly');
            // Skip loading screen and go directly to login
            loadingScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            document.body.classList.add('login-background');
            
            // Start login animations
            setTimeout(restartLoginAnimations, 50);
            
            // Crea società esempio se necessario (solo per testing)
            // window.creaSocietaEsempio();
        };

        // Start game function
        function startGame() {
            const opponentName = welcomeOpponentName.value.trim().toUpperCase();
            const errorDiv = document.getElementById('welcome-error');
            
            // Validate opponent name
            if (!opponentName || opponentName === '') {
                errorDiv.classList.remove('hidden');
                vibrate([200]);
                return;
            }
            
            // Hide error if validation passes
            errorDiv.classList.add('hidden');
            
            // Get match type (home/away)
            const matchType = document.querySelector('input[name="matchType"]:checked')?.value || 'home';
            
            // Store match type for later use (can be saved with game data)
            window.currentMatchType = matchType;
            
            // Update opponent names in the interface
            const scoreTeam2NameElement = document.getElementById('score-team2-name');
            if (scoreTeam2NameElement) scoreTeam2NameElement.textContent = opponentName;
            
            const team2NameElement = document.getElementById('team2-name');
            if (team2NameElement) team2NameElement.textContent = opponentName;
            
            const statsTeam2TitleElement = document.getElementById('stats-team2-title');
            if (statsTeam2TitleElement) statsTeam2TitleElement.textContent = opponentName;

            // Update team 1 name if we have a club
            if (currentClub) {
                const scoreTeam1NameElement = document.getElementById('score-team1-name');
                if (scoreTeam1NameElement) scoreTeam1NameElement.textContent = currentClub.nome;
                
                const team1TitleElement = document.getElementById('team1-title');
                if (team1TitleElement) team1TitleElement.textContent = currentClub.nome;
                
                const statsTeam1TitleElement = document.getElementById('stats-team1-title');
                if (statsTeam1TitleElement) statsTeam1TitleElement.textContent = currentClub.nome;
                
                // Load and apply saved period duration if available
                if (currentClub.periodDuration) {
                    totalSeconds = currentClub.periodDuration * 60;
                    lastSetSeconds = totalSeconds;
                    updateTimerDisplay();
                }
            }

            // Navigate to game screen with history management
            navigateToScreen('game', true);
            
            // Mostra il tasto dello storico quando si inizia una nuova partita
            const historyButton = document.getElementById('show-history-button');
            if (historyButton) {
                historyButton.style.display = 'flex';
            }
            
            // Request wake lock to keep screen on during the match
            // This prevents the device from going to sleep while managing the game
            // For unsupported browsers, a fallback message will guide the user
            requestWakeLock();
            
            // Setup Firebase history listener
            setupFirebaseHistoryListener();
            
            // Initialize the app
            setDate();
            updateScores();
            updateTimerDisplay();
            updateGoalButtonsDisplay(); // Apply team's period setting
            
            // Add vibration feedback
            vibrate([50]);
        }

        // Login function
        async function handleLogin() {
            const codeRaw = document.getElementById('login-code-input').value;
            const errorDiv = document.getElementById('login-error');
            const rememberCheckbox = document.getElementById('remember-code-checkbox');
            
            // Log del codice inserito per debug
            console.log("🚀 Tentativo login con codice:", {
                codeRaw: codeRaw,
                lunghezza: codeRaw.length,
                hasSpaces: codeRaw !== codeRaw.trim()
            });
            
            if (!codeRaw || codeRaw.trim() === '') {
                errorDiv.textContent = 'Inserisci un codice';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Passa il codice ESATTO senza modifiche (no trim)
                const result = await window.verificaCodice(codeRaw);
                
                if (result.success) {
                    console.log("✅ Login riuscito per società:", result.societa.nome);
                    
                    // Save or remove the code from localStorage based on checkbox
                    if (rememberCheckbox && rememberCheckbox.checked) {
                        localStorage.setItem('polis_remembered_code', codeRaw);
                        console.log('💾 Codice salvato in localStorage');
                    } else {
                        localStorage.removeItem('polis_remembered_code');
                        console.log('🗑️ Codice rimosso da localStorage');
                    }
                    
                    currentClub = result.societa;
                    currentPlayers = [...(result.societa.giocatori || defaultPlayers)];
                    players = [...currentPlayers];
                    teamNumPeriods = result.societa.numPeriods || 2; // Load team's period setting, default to 2
                    
                    // Save login state to localStorage for persistence across reloads/swipes
                    const loginState = {
                        club: result.societa,
                        players: currentPlayers,
                        numPeriods: teamNumPeriods,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('polis_login_state', JSON.stringify(loginState));
                    console.log('💾 Stato login salvato in localStorage');
                    
                    // Update team names
                    const menuTeamNameElement = document.getElementById('menu-team-name');
                    if (menuTeamNameElement) menuTeamNameElement.textContent = `Benvenuto, ${currentClub.nome}!`;
                    
                    const playersTeamNameElement = document.getElementById('players-team-name');
                    if (playersTeamNameElement) playersTeamNameElement.textContent = currentClub.nome;
                    
                    // Setup Firebase history listener for this team
                    setupFirebaseHistoryListener();
                    
                    // Navigate to menu screen with history management
                    navigateToScreen('menu', true);
                    
                    // Clear input and hide error
                    document.getElementById('login-code-input').value = '';
                    errorDiv.classList.add('hidden');
                    vibrate([50]);
                } else {
                    console.log("❌ Login fallito:", result.message);
                    errorDiv.textContent = result.message || 'Codice non valido';
                    errorDiv.classList.remove('hidden');
                    vibrate([200]);
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Errore di connessione. Riprova più tardi.';
                errorDiv.classList.remove('hidden');
                vibrate([200]);
            }
        }

        // Show match setup (welcome screen)
        function showMatchSetup() {
            navigateToScreen('welcome', true);
            
            // Update team name in welcome screen if needed
            if (currentClub) {
                // No need to change anything, POLIS is hardcoded in the main interface
            }
        }

        // Show players management
        function showPlayersManagement() {
            navigateToScreen('players', true);
            
            // Set the radio button based on current team's period setting
            document.getElementById('periods-2').checked = (teamNumPeriods === 2);
            document.getElementById('periods-3').checked = (teamNumPeriods === 3);
            
            // Set the period duration if available
            if (currentClub && currentClub.periodDuration) {
                document.getElementById('period-duration').value = currentClub.periodDuration.toString();
            }
            
            updatePlayersListUI();
        }

        // Update players list UI
        function updatePlayersListUI() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';
            
            currentPlayers.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center justify-between bg-gray-700 p-3 rounded';
                playerDiv.innerHTML = `
                    <span class="text-white">${player}</span>
                    <button onclick="removePlayer(${index})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                        Rimuovi
                    </button>
                `;
                playersList.appendChild(playerDiv);
            });
        }

        // Add new player
        function addPlayer() {
            const input = document.getElementById('new-player-input');
            const newPlayer = input.value.trim();
            
            if (newPlayer) {
                currentPlayers.push(newPlayer);
                input.value = '';
                updatePlayersListUI();
                vibrate([50]);
            }
        }

        // Remove player
        function removePlayer(index) {
            currentPlayers.splice(index, 1);
            updatePlayersListUI();
            vibrate([100]);
        }

        // Save players changes
        async function savePlayersChanges() {
            if (!currentClub) return;
            
            // Get selected number of periods
            const selectedPeriods = document.querySelector('input[name="numPeriods"]:checked')?.value || '2';
            const numPeriodsValue = parseInt(selectedPeriods);
            
            // Get selected period duration
            const periodDuration = parseInt(document.getElementById('period-duration').value) || 18;
            
            try {
                const result = await window.aggiornaGiocatoriSocieta(currentClub.id, currentPlayers, numPeriodsValue, periodDuration);
                
                if (result.success) {
                    // Update global variables
                    players = [...currentPlayers];
                    teamNumPeriods = numPeriodsValue;
                    
                    // Update currentClub with new period duration
                    currentClub.periodDuration = periodDuration;
                    
                    // Update goal buttons display
                    updateGoalButtonsDisplay();
                    
                    alert('Giocatori e configurazione salvati con successo!');
                    vibrate([100, 50, 100]);
                } else {
                    alert('Errore nel salvataggio: ' + (result.message || 'Errore sconosciuto'));
                    vibrate([200]);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Errore di connessione durante il salvataggio');
                vibrate([200]);
            }
        }

        // Update goal buttons display based on team's period setting
        function updateGoalButtonsDisplay() {
            const team1ThirdPeriod = document.getElementById('team1-3rd-period');
            const team2ThirdPeriod = document.getElementById('team2-3rd-period');
            
            if (teamNumPeriods === 2) {
                // Hide 3rd period buttons for 2-period games
                if (team1ThirdPeriod) team1ThirdPeriod.style.display = 'none';
                if (team2ThirdPeriod) team2ThirdPeriod.style.display = 'none';
            } else {
                // Show 3rd period buttons for 3-period games
                if (team1ThirdPeriod) team1ThirdPeriod.style.display = 'flex';
                if (team2ThirdPeriod) team2ThirdPeriod.style.display = 'flex';
            }
        }

        // Back to menu from players management
        function backToMenuFromPlayers() {
            // Use browser back instead of direct navigation
            // This maintains proper history stack
            window.history.back();
        }
        
        // Back to menu from welcome screen
        function backToMenu() {
            // Use browser back instead of direct navigation
            window.history.back();
            // Clear the opponent name input
            welcomeOpponentName.value = '';
        }

        // Back to login
        function backToLogin() {
            // Clear login state from localStorage when user explicitly logs out
            localStorage.removeItem('polis_login_state');
            console.log('🗑️ Stato login rimosso da localStorage');
            
            // Use browser back to return to login (or navigate directly if needed)
            // Since login might not be in history after successful login, navigate directly
            navigateToScreen('login', true);
            
            // Add vibration feedback
            vibrate([50]);
        }

        // Set current date
        function setDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) {
                currentDateElement.textContent = today.toLocaleDateString('it-IT', options);
            }
        }

        // Update scores
        function updateScores() {
            const scoreTeam1Element = document.getElementById('score-team1');
            if (scoreTeam1Element) scoreTeam1Element.textContent = scoreTeam1;
            
            const scoreTeam2Element = document.getElementById('score-team2');
            if (scoreTeam2Element) scoreTeam2Element.textContent = scoreTeam2;
            
            updateStats();
        }

        // Calculate total stats from period data
        function calculateTotals() {
            shotsTeam1 = eventsByPeriod.team1.shots['1'] + eventsByPeriod.team1.shots['2'] + eventsByPeriod.team1.shots['3'];
            cornersTeam1 = eventsByPeriod.team1.corners['1'] + eventsByPeriod.team1.corners['2'] + eventsByPeriod.team1.corners['3'];
            foulsTeam1 = eventsByPeriod.team1.fouls['1'] + eventsByPeriod.team1.fouls['2'] + eventsByPeriod.team1.fouls['3'];
            yellowCardsTeam1 = eventsByPeriod.team1.yellowCards['1'] + eventsByPeriod.team1.yellowCards['2'] + eventsByPeriod.team1.yellowCards['3'];
            redCardsTeam1 = eventsByPeriod.team1.redCards['1'] + eventsByPeriod.team1.redCards['2'] + eventsByPeriod.team1.redCards['3'];
            shotsTeam2 = eventsByPeriod.team2.shots['1'] + eventsByPeriod.team2.shots['2'] + eventsByPeriod.team2.shots['3'];
            cornersTeam2 = eventsByPeriod.team2.corners['1'] + eventsByPeriod.team2.corners['2'] + eventsByPeriod.team2.corners['3'];
            foulsTeam2 = eventsByPeriod.team2.fouls['1'] + eventsByPeriod.team2.fouls['2'] + eventsByPeriod.team2.fouls['3'];
            yellowCardsTeam2 = eventsByPeriod.team2.yellowCards['1'] + eventsByPeriod.team2.yellowCards['2'] + eventsByPeriod.team2.yellowCards['3'];
            redCardsTeam2 = eventsByPeriod.team2.redCards['1'] + eventsByPeriod.team2.redCards['2'] + eventsByPeriod.team2.redCards['3'];
        }

        // Update stats display with period breakdown
        function updateStats() {
            calculateTotals();
            
            // Update basic stats with null checks
            const goalsTeam1Element = document.getElementById('goals-team1');
            if (goalsTeam1Element) goalsTeam1Element.textContent = scoreTeam1;
            
            const goalsTeam2TakenElement = document.getElementById('goals-team2-taken');
            if (goalsTeam2TakenElement) goalsTeam2TakenElement.textContent = scoreTeam2;
            
            const shotsTeam1Element = document.getElementById('shots-team1');
            if (shotsTeam1Element) shotsTeam1Element.textContent = shotsTeam1;
            
            const shotsTeam2TakenElement = document.getElementById('shots-team2-taken');
            if (shotsTeam2TakenElement) shotsTeam2TakenElement.textContent = shotsTeam2;
            
            const cornersTeam1Element = document.getElementById('corners-team1');
            if (cornersTeam1Element) cornersTeam1Element.textContent = cornersTeam1;
            
            const cornersTeam2TakenElement = document.getElementById('corners-team2-taken');
            if (cornersTeam2TakenElement) cornersTeam2TakenElement.textContent = cornersTeam2;
            
            const foulsTeam1Element = document.getElementById('fouls-team1');
            if (foulsTeam1Element) foulsTeam1Element.textContent = foulsTeam1;
            
            const foulsTeam2TakenElement = document.getElementById('fouls-team2-taken');
            if (foulsTeam2TakenElement) foulsTeam2TakenElement.textContent = foulsTeam2;
            
            const yellowCardsTeam1Element = document.getElementById('yellow-cards-team1');
            if (yellowCardsTeam1Element) yellowCardsTeam1Element.textContent = yellowCardsTeam1;
            
            const redCardsTeam1Element = document.getElementById('red-cards-team1');
            if (redCardsTeam1Element) redCardsTeam1Element.textContent = redCardsTeam1;
            
            const goalsTeam2Element = document.getElementById('goals-team2');
            if (goalsTeam2Element) goalsTeam2Element.textContent = scoreTeam2;
            
            const goalsTeam1TakenElement = document.getElementById('goals-team1-taken');
            if (goalsTeam1TakenElement) goalsTeam1TakenElement.textContent = scoreTeam1;
            
            const shotsTeam2Element = document.getElementById('shots-team2');
            if (shotsTeam2Element) shotsTeam2Element.textContent = shotsTeam2;
            
            const shotsTeam1TakenElement = document.getElementById('shots-team1-taken');
            if (shotsTeam1TakenElement) shotsTeam1TakenElement.textContent = shotsTeam1;
            
            const cornersTeam2Element = document.getElementById('corners-team2');
            if (cornersTeam2Element) cornersTeam2Element.textContent = cornersTeam2;
            
            const cornersTeam1TakenElement = document.getElementById('corners-team1-taken');
            if (cornersTeam1TakenElement) cornersTeam1TakenElement.textContent = cornersTeam1;
            
            const foulsTeam2Element = document.getElementById('fouls-team2');
            if (foulsTeam2Element) foulsTeam2Element.textContent = foulsTeam2;
            
            const foulsTeam1TakenElement = document.getElementById('fouls-team1-taken');
            if (foulsTeam1TakenElement) foulsTeam1TakenElement.textContent = foulsTeam1;
            
            const yellowCardsTeam2Element = document.getElementById('yellow-cards-team2');
            if (yellowCardsTeam2Element) yellowCardsTeam2Element.textContent = yellowCardsTeam2;
            
            const redCardsTeam2Element = document.getElementById('red-cards-team2');
            if (redCardsTeam2Element) redCardsTeam2Element.textContent = redCardsTeam2;
            
            // Note: Removed references to non-existent elements like 'yellow-cards-team2-taken', etc.
            // These elements don't exist in the HTML and were causing the null pointer errors
            
            // Update period breakdown display
            updatePeriodStats();
        }

        // Update period statistics display
        function updatePeriodStats() {
            // Generate HTML for period statistics table
            function generatePeriodStatsTable(teamData, teamStats) {
                const showThirdPeriod = teamNumPeriods === 3;
                
                return `
                    <div class="period-breakdown">
                        <h5>Statistiche per tempo:</h5>
                        <table class="period-stats-table">
                            <thead>
                                <tr>
                                    <th>Tempo</th>
                                    <th>Tiri</th>
                                    <th>Corner</th>
                                    <th>Falli</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1° tempo</td>
                                    <td>${teamData.shots['1']}</td>
                                    <td>${teamData.corners['1']}</td>
                                    <td>${teamData.fouls['1']}</td>
                                </tr>
                                <tr>
                                    <td>2° tempo</td>
                                    <td>${teamData.shots['2']}</td>
                                    <td>${teamData.corners['2']}</td>
                                    <td>${teamData.fouls['2']}</td>
                                </tr>
                                ${showThirdPeriod ? `
                                <tr>
                                    <td>3° tempo</td>
                                    <td>${teamData.shots['3']}</td>
                                    <td>${teamData.corners['3']}</td>
                                    <td>${teamData.fouls['3']}</td>
                                </tr>
                                ` : ''}
                                <tr class="totals-row">
                                    <td><strong>Totale</strong></td>
                                    <td><strong>${teamStats.shots}</strong></td>
                                    <td><strong>${teamStats.corners}</strong></td>
                                    <td><strong>${teamStats.fouls}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Team 1 period stats
            const team1StatsDiv = document.getElementById('period-stats-team1');
            if (team1StatsDiv) {
                team1StatsDiv.innerHTML = generatePeriodStatsTable(
                    eventsByPeriod.team1, 
                    { shots: shotsTeam1, corners: cornersTeam1, fouls: foulsTeam1 }
                );
            }
            
            // Team 2 period stats
            const team2StatsDiv = document.getElementById('period-stats-team2');
            if (team2StatsDiv) {
                team2StatsDiv.innerHTML = generatePeriodStatsTable(
                    eventsByPeriod.team2, 
                    { shots: shotsTeam2, corners: cornersTeam2, fouls: foulsTeam2 }
                );
            }
        }

        // Timer functions
        function updateTimerDisplay() {
            // Calculate remaining time based on real elapsed time
            let displaySeconds;
            
            if (isRunning && timerStartTime) {
                // Timer is running: calculate elapsed time from start, accounting for pauses
                const currentTime = Date.now();
                const totalElapsedMs = (currentTime - timerStartTime) - pausedDuration;
                const elapsedSeconds = Math.floor(totalElapsedMs / 1000);
                displaySeconds = Math.max(0, lastSetSeconds - elapsedSeconds);
                
                // Check if we're in recovery time
                if (displaySeconds <= 0 && !isInRecovery) {
                    isInRecovery = true;
                    recoverySeconds = 0;
                    
                    // Play sound and vibrate when entering recovery
                    vibrate([5000]); 
                    playTimerSound(); 
                }
                
                // If in recovery, calculate recovery seconds
                if (isInRecovery) {
                    recoverySeconds = elapsedSeconds - lastSetSeconds;
                }
            } else if (!isRunning && timerStartTime) {
                // Timer is paused: use the time at pause moment
                displaySeconds = totalSeconds;
            } else {
                // Timer not started yet or has been reset
                displaySeconds = totalSeconds;
            }
            
            // Display logic
            if (isInRecovery) {
                // In recovery time: show 00:00 + recovery time
                document.getElementById('timer-display').textContent = "00:00";
                
                // Show recovery time
                const recoveryMinutes = Math.floor(recoverySeconds / 60);
                const recoverySecondsDisplay = recoverySeconds % 60;
                const recoveryFormattedTime = `${recoveryMinutes}:${recoverySecondsDisplay.toString().padStart(2, '0')}`;
                const recoveryDisplay = document.getElementById('recovery-display');
                if (recoveryDisplay) {
                    recoveryDisplay.textContent = `+ ${recoveryFormattedTime}`;
                    recoveryDisplay.style.display = 'inline';
                }
            } else {
                // Normal time: show countdown
                const minutes = Math.floor(displaySeconds / 60);
                const seconds = displaySeconds % 60;
                const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timer-display').textContent = formattedTime;
                
                // Hide recovery display
                const recoveryDisplay = document.getElementById('recovery-display');
                if (recoveryDisplay) {
                    recoveryDisplay.style.display = 'none';
                }
            }
        }

        /**
         * Aggiorna lo stato del pulsante modifica timer
         * Disabilita il pulsante quando il timer è in corso
         */
        function updateEditTimerButtonState() {
            const editButton = document.getElementById('edit-timer-button');
            if (editButton) {
                if (isRunning) {
                    editButton.disabled = true;
                    editButton.style.opacity = '0.5';
                    editButton.style.cursor = 'not-allowed';
                } else {
                    editButton.disabled = false;
                    editButton.style.opacity = '1';
                    editButton.style.cursor = 'pointer';
                }
            }
        }

        /**
         * Aggiorna tutti i display dell'interfaccia utente
         * Utilizzata principalmente per il ripristino dello stato dopo il reload
         */
        function updateAllDisplays() {
            try {
                // Aggiorna punteggi
                updateScores();
                
                // Aggiorna statistiche
                updateStats();
                
                // Aggiorna display del timer
                updateTimerDisplay();
                
                // Aggiorna lo stato del pulsante modifica
                updateEditTimerButtonState();
                
                // Aggiorna la visualizzazione dei marcatori
                updateScorersDisplay();
                
                // Aggiorna la visualizzazione dei cartellini
                updateCardsList();
                
                // Aggiorna i pulsanti dei goal in base al numero di periodi
                updateGoalButtonsDisplay();
                
                console.log('🔄 Tutti i display aggiornati dopo ripristino stato');
            } catch (error) {
                console.error('❌ Errore nell\'aggiornamento dei display:', error);
            }
        }

        /**
         * Aggiorna la visualizzazione dei marcatori
         * Gestisce sia il formato legacy che quello nuovo con timestamp
         */
        function updateScorersDisplay() {
            try {
                // Aggiorna marcatori squadra 1
                const scorersList1 = document.getElementById('scorers-list-1');
                if (scorersList1) {
                    scorersList1.innerHTML = '<h4>Marcatori:</h4>';
                    team1Scorers.forEach(scorer => {
                        const scorerDiv = document.createElement('div');
                        scorerDiv.classList.add('scorer-list-item');
                        
                        // Backward compatibility: gestisce sia 'quarter' che 'period'
                        const period = scorer.quarter || scorer.period || '?';
                        const minute = scorer.minute || 0;
                        
                        scorerDiv.textContent = `${scorer.player} - ${minute}' (${period}°)`;
                        scorersList1.appendChild(scorerDiv);
                    });
                }
                
                // Aggiorna marcatori squadra 2
                const scorersList2 = document.getElementById('scorers-list-2');
                if (scorersList2) {
                    scorersList2.innerHTML = '<h4>Marcatori:</h4>';
                    team2Scorers.forEach(scorer => {
                        const scorerDiv = document.createElement('div');
                        scorerDiv.classList.add('scorer-list-item');
                        
                        // Backward compatibility: gestisce sia 'quarter' che 'period'
                        const period = scorer.quarter || scorer.period || '?';
                        const minute = scorer.minute || 0;
                        
                        scorerDiv.textContent = `${scorer.player} - ${minute}' (${period}°)`;
                        scorersList2.appendChild(scorerDiv);
                    });
                }
            } catch (error) {
                console.error('❌ Errore nell\'aggiornamento marcatori:', error);
            }
        }

function updateShootersList() {
    const list = document.getElementById('shooters-list-1');
    if (!list) return;

    list.innerHTML = '<h4>Tiri:</h4>';
    
    // Ordina i giocatori per numero di tiri (dal più alto al più basso)
    const sortedShooters = Object.entries(team1Shooters).sort((a, b) => b[1] - a[1]);

    sortedShooters.forEach(([player, count]) => {
        const div = document.createElement('div');
        div.classList.add('scorer-list-item');
        // Mostra: Nome Giocatore: 3
        div.textContent = `${player}: ${count}`;
        list.appendChild(div);
    });
}

        function startTimer() {
            if (isRunning) return;
            
            // Check if this is a resume (timer was paused) or restart of existing game session
            if (timerStartTime && (pauseStartTime || totalSeconds < lastSetSeconds)) {
                // This is a resume or restart of existing session: add pause duration to the total paused time
                if (pauseStartTime) {
                    pausedDuration += (Date.now() - pauseStartTime);
                    pauseStartTime = null;
                }
                
                // Resume/restart the timer
                isRunning = true;
                document.getElementById('timer-display').classList.add('timer-running');
                
                // Aggiorna lo stato del pulsante modifica
                updateEditTimerButtonState();
                
                // Update display every second
                timerInterval = setInterval(() => {
                    updateTimerDisplay();
                }, 1000);
                
                // Initial display update
                updateTimerDisplay();
                vibrate([100]); // Resume timer feedback
            } else {
                // This is a fresh start: show period selection modal
                showPeriodSelectionModal();
            }
        }

        function showPeriodSelectionModal() {
            const modal = document.getElementById('period-selection-modal');
            const period3Button = document.getElementById('select-period-3');
            
            // Show/hide 3rd period button based on team configuration
            if (teamNumPeriods === 3) {
                period3Button.style.display = 'block';
            } else {
                period3Button.style.display = 'none';
            }
            
            modal.classList.add('is-active');
            vibrate([50]); // Modal open feedback
        }

        function hidePeriodSelectionModal() {
            document.getElementById('period-selection-modal').classList.remove('is-active');
        }

        function selectPeriodAndStartTimer(period) {
            currentPeriod = period;
            hidePeriodSelectionModal();
            
            // Update period display
            const periodDisplay = document.getElementById('current-period-display');
            periodDisplay.textContent = `${period}° tempo`;
            periodDisplay.style.display = 'inline-block';
            
            // Start the new timer system based on real time
            isRunning = true;
            timerStartTime = Date.now(); // Record the exact start time
            pausedDuration = 0; // Reset any previous pause duration
            pauseStartTime = null; // Clear pause start time
            
            document.getElementById('timer-display').classList.add('timer-running');
            
            // Aggiorna lo stato del pulsante modifica
            updateEditTimerButtonState();
            
            // Update display every second (or when page becomes active again)
            timerInterval = setInterval(() => {
                updateTimerDisplay();
            }, 1000);
            
            // Initial display update
            updateTimerDisplay();
            vibrate([100]); // Start timer feedback
            
            // Salva automaticamente lo stato quando il timer inizia
            saveCurrentGameState();
        }

        function pauseTimer() {
            if (!isRunning) return;
            
            // Record pause start time and calculate current totalSeconds for display
            pauseStartTime = Date.now();
            
            if (timerStartTime) {
                // Calculate how much time has elapsed and update totalSeconds for accurate display
                const totalElapsedMs = (pauseStartTime - timerStartTime) - pausedDuration;
                const elapsedSeconds = Math.floor(totalElapsedMs / 1000);
                totalSeconds = Math.max(0, lastSetSeconds - elapsedSeconds);
            }
            
            isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('timer-display').classList.remove('timer-running');
            
            // Aggiorna lo stato del pulsante modifica
            updateEditTimerButtonState();
            vibrate([50]); // Pause timer feedback
            
            // Salva automaticamente lo stato quando il timer viene messo in pausa
            saveCurrentGameState();
        }

        function resetTimer() {
            pauseTimer();
            
            // Reset all timer variables to initial state
            totalSeconds = lastSetSeconds;
            timerStartTime = null; // Clear start time
            pausedDuration = 0; // Reset pause duration
            pauseStartTime = null; // Clear pause start time
            currentPeriod = null;
            recoverySeconds = 0; // Reset recovery time
            isInRecovery = false; // Reset recovery state
            
            // Hide period display
            const periodDisplay = document.getElementById('current-period-display');
            periodDisplay.style.display = 'none';
            
            updateTimerDisplay();
            
            // Aggiorna lo stato del pulsante modifica
            updateEditTimerButtonState();
            
            vibrate([50, 50]); // Reset timer feedback
        }

        // Function to play timer sound
        function playTimerSound() {
            try {
                if (fischioAudio) {
                    fischioAudio.currentTime = 0;
                    fischioAudio.play().catch(err => {
                        console.error('Audio playback failed, trying fallback:', err);
                        const fallback = new Audio('./fischio.mp3');
                        fallback.play().catch(err2 => {
                            console.error('Audio playback failed:', err2);
                        });
                    });
                } else {
                    const fallback = new Audio('./fischio.mp3');
                    fallback.play().catch(err => {
                        console.error('Audio playback failed:', err);
                    });
                }
            } catch (e) {
                console.error('Unable to play fischio.mp3', e);
            }
        }

        // Player modal functions
        function showPlayerModal(quarter) {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            
            // Use lineup if available, otherwise use all players
            const availablePlayers = matchLineup.length > 0 ? matchLineup : players;
            
            availablePlayers.forEach(player => {
                const playerButton = document.createElement('button');
                playerButton.textContent = player;
                playerButton.classList.add('player-btn');
                playerButton.addEventListener('click', () => {
                    addGoalTeam1(player, quarter);
                    hidePlayerModal();
                });
                playerList.appendChild(playerButton);
            });
            document.getElementById('player-modal').classList.add('is-active');
            vibrate([50]); // Modal open feedback
        }

	// --- NUOVA FUNZIONE DA AGGIUNGERE ---
		function showShotPlayerModal(quarter) {
    		const playerList = document.getElementById('player-list');
    		playerList.innerHTML = '';
    
    // Cambiamo temporaneamente il titolo del modale
    const modalHeader = document.querySelector('#player-modal .modal-header');
    if(modalHeader) modalHeader.textContent = "Chi ha tirato?"; 

    // Usa la formazione se disponibile, altrimenti tutti i giocatori
    const availablePlayers = matchLineup.length > 0 ? matchLineup : players;
    
    availablePlayers.forEach(player => {
        const playerButton = document.createElement('button');
        playerButton.textContent = player;
        playerButton.classList.add('player-btn');
        playerButton.addEventListener('click', () => {
            addShotTeam1(player, quarter);
            hidePlayerModal();
            // Ripristina il titolo originale per la prossima volta (opzionale)
            if(modalHeader) modalHeader.textContent = "Chi ha segnato?";
        });
        playerList.appendChild(playerButton);
    });
    document.getElementById('player-modal').classList.add('is-active');
    vibrate([50]); 
}

// --- NUOVA FUNZIONE DA AGGIUNGERE ---
function addShotTeam1(player, quarter) {
    // Incrementa contatore totale (codice vecchio)
    eventsByPeriod.team1.shots[currentPeriod.toString()]++;
    
    // NUOVO: Aggiorna il conteggio specifico del giocatore
    if (!team1Shooters[player]) {
        team1Shooters[player] = 0;
    }
    team1Shooters[player]++;

    // Aggiorna l'interfaccia
    updateShootersList();
    updateStats();
    showActionConfirmation('+');
    saveCurrentGameState();
}

        function hidePlayerModal() {
            document.getElementById('player-modal').classList.remove('is-active');
            vibrate([30]); // Modal close feedback
        }

        // Lineup modal functions
        function showLineupModal() {
            const lineupPlayerList = document.getElementById('lineup-player-list');
            lineupPlayerList.innerHTML = '';
            
            // Use currentPlayers if available, otherwise use players
            const availablePlayers = currentPlayers.length > 0 ? currentPlayers : players;
            
            availablePlayers.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center p-2 bg-gray-700 rounded mb-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `lineup-player-${index}`;
                checkbox.value = player;
                checkbox.className = 'mr-3';
                
                // Check if player is already in lineup
                if (matchLineup.includes(player)) {
                    checkbox.checked = true;
                }
                
                const label = document.createElement('label');
                label.htmlFor = `lineup-player-${index}`;
                label.textContent = player;
                label.className = 'text-white cursor-pointer flex-1';
                
                playerDiv.appendChild(checkbox);
                playerDiv.appendChild(label);
                lineupPlayerList.appendChild(playerDiv);
            });
            
            document.getElementById('lineup-modal').classList.add('is-active');
            vibrate([50]); // Modal open feedback
        }
        
        function hideLineupModal() {
            document.getElementById('lineup-modal').classList.remove('is-active');
            vibrate([30]); // Modal close feedback
        }
        
        function confirmLineup() {
            // Get all checked players
            matchLineup = [];
            const checkboxes = document.querySelectorAll('#lineup-player-list input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                matchLineup.push(checkbox.value);
            });
            
            // Update status display
            const lineupStatus = document.getElementById('lineup-status');
            const lineupCount = document.getElementById('lineup-count');
            
            if (matchLineup.length > 0) {
                lineupCount.textContent = matchLineup.length;
                lineupStatus.classList.remove('hidden');
            } else {
                lineupStatus.classList.add('hidden');
            }
            
            hideLineupModal();
            vibrate([100, 50, 100]); // Success feedback
        }

        // Card player modal functions
        function showCardPlayerModal(cardType, quarter) {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            
            // Use lineup if available, otherwise use all players
            const availablePlayers = matchLineup.length > 0 ? matchLineup : players;
            
            availablePlayers.forEach(player => {
                const playerButton = document.createElement('button');
                playerButton.textContent = player;
                playerButton.classList.add('player-btn');
                playerButton.addEventListener('click', () => {
                    addCardTeam1(player, cardType, quarter);
                    hidePlayerModal();
                });
                playerList.appendChild(playerButton);
            });
            document.getElementById('player-modal').classList.add('is-active');
            vibrate([50]); // Modal open feedback
        }

        // Goal functions
        function addGoalTeam1(player, quarter) {
            scoreTeam1++;
            
            // Calcola tempo di gioco accurato e timestamp per il marcatore
            const gameTime = getCurrentGameTimeForScoring();
            const minute = Math.max(1, gameTime.minutes + 1); // Minuto di gioco (min 1)
            
            // Crea oggetto marcatore con timestamp completo
            const scorerData = {
                player: player,
                quarter: quarter,
                minute: minute,
                timestamp: Date.now(), // Timestamp di inserimento del gol
                gameTimeSeconds: gameTime.totalSeconds, // Secondi di gioco al momento del gol
                gameTimeFormatted: gameTime.formattedTime // Tempo formattato per debug
            };
            
            const newScorer = document.createElement('div');
            newScorer.classList.add('scorer-list-item');
            newScorer.textContent = `${player} - ${minute}' (${quarter})`;
            document.getElementById('scorers-list-1').appendChild(newScorer);
            team1Scorers.push(scorerData);

            document.getElementById('score-team1').classList.add('is-pulsing');
            setTimeout(() => {
                document.getElementById('score-team1').classList.remove('is-pulsing');
            }, 1000);
            createConfetti();
            updateScores();
            
            // Special vibration pattern for goals
            vibrate([150, 100, 150, 100, 150]);
            
            // Salva automaticamente lo stato dopo ogni goal
            saveCurrentGameState();
        }

        function addGoalTeam2(quarter) {
            scoreTeam2++;
            
            // Calcola tempo di gioco accurato e timestamp per il marcatore
            const gameTime = getCurrentGameTimeForScoring();
            const minute = Math.max(1, gameTime.minutes + 1); // Minuto di gioco (min 1)
            
            // Crea oggetto marcatore con timestamp completo
            const scorerData = {
                player: 'Sconosciuto',
                quarter: quarter,
                minute: minute,
                timestamp: Date.now(), // Timestamp di inserimento del gol
                gameTimeSeconds: gameTime.totalSeconds, // Secondi di gioco al momento del gol
                gameTimeFormatted: gameTime.formattedTime // Tempo formattato per debug
            };
            
            const newScorer = document.createElement('div');
            newScorer.classList.add('scorer-list-item');
            newScorer.textContent = `Goal - ${minute}' (${quarter})`;
            document.getElementById('scorers-list-2').appendChild(newScorer);
            team2Scorers.push(scorerData);
            updateScores();
            
            // Special vibration pattern for goals
            vibrate([150, 100, 150, 100, 150]);
            
            // Salva automaticamente lo stato dopo ogni goal
            saveCurrentGameState();
        }

        // Card functions
        function addCardTeam1(player, cardType, quarter) {
            // Calcola tempo di gioco accurato e timestamp per il cartellino
            const gameTime = getCurrentGameTimeForScoring();
            const minute = Math.max(1, gameTime.minutes + 1); // Minuto di gioco (min 1)
            
            // Crea oggetto cartellino con timestamp completo
            const cardData = {
                player: player,
                cardType: cardType, // 'yellow' or 'red'
                quarter: quarter,
                minute: minute,
                timestamp: gameTime.timestamp,
                seconds: gameTime.seconds
            };
            
            team1Cards.push(cardData);
            
            // Aggiorna le statistiche per periodo
            if (cardType === 'yellow') {
                eventsByPeriod.team1.yellowCards[currentPeriod.toString()]++;
            } else if (cardType === 'red') {
                eventsByPeriod.team1.redCards[currentPeriod.toString()]++;
            }
            
            updateStats();
            updateCardsList();
            saveCurrentGameState();
            vibrate([100]);
        }

        function addCardTeam2(cardType, quarter) {
            // Team 2 non ha selezione giocatori, usa il nome della squadra
            const gameTime = getCurrentGameTimeForScoring();
            const minute = Math.max(1, gameTime.minutes + 1);
            const team2Name = document.getElementById('team2-name').textContent;
            
            const cardData = {
                player: team2Name,
                cardType: cardType,
                quarter: quarter,
                minute: minute,
                timestamp: gameTime.timestamp,
                seconds: gameTime.seconds
            };
            
            team2Cards.push(cardData);
            
            // Aggiorna le statistiche per periodo
            if (cardType === 'yellow') {
                eventsByPeriod.team2.yellowCards[currentPeriod.toString()]++;
            } else if (cardType === 'red') {
                eventsByPeriod.team2.redCards[currentPeriod.toString()]++;
            }
            
            updateStats();
            updateCardsList();
            saveCurrentGameState();
            vibrate([100]);
        }

        // Update cards display function
        function updateCardsList() {
            // Update team 1 cards
            const cardsList1 = document.getElementById('cards-list-1');
            if (cardsList1) {
                cardsList1.innerHTML = '<h4>Cartellini:</h4>';
                team1Cards.forEach(card => {
                    const cardDiv = document.createElement('div');
                    cardDiv.classList.add('cards-list-item');
                    
                    const iconSrc = card.cardType === 'yellow' ? 
                        'icons8-cartellino-giallo-calcio-96.png' : 
                        'icons8-cartellino-rosso-calcio-96 (1).png';
                    
                    cardDiv.innerHTML = `
                        <img src="${iconSrc}" alt="${card.cardType} card">
                        ${card.player} - ${card.minute}' (${card.quarter})
                    `;
                    cardsList1.appendChild(cardDiv);
                });
            }
            
            // Update team 2 cards
            const cardsList2 = document.getElementById('cards-list-2');
            if (cardsList2) {
                cardsList2.innerHTML = '<h4>Cartellini:</h4>';
                team2Cards.forEach(card => {
                    const cardDiv = document.createElement('div');
                    cardDiv.classList.add('cards-list-item');
                    
                    const iconSrc = card.cardType === 'yellow' ? 
                        'icons8-cartellino-giallo-calcio-96.png' : 
                        'icons8-cartellino-rosso-calcio-96 (1).png';
                    
                    cardDiv.innerHTML = `
                        <img src="${iconSrc}" alt="${card.cardType} card">
                        ${card.player} - ${card.minute}' (${card.quarter})
                    `;
                    cardsList2.appendChild(cardDiv);
                });
            }
        }

        // Confetti function
        function createConfetti() {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -20}vh`;
                confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                document.body.appendChild(confetti);

                setTimeout(() => {
                    confetti.remove();
                }, parseFloat(confetti.style.animationDuration) * 1000);
            }
        }

        // Remove confirmation modal functions
        function showRemoveModal(type, team) {
            let text = '';
            if (type === 'goal') {
                text = 'un goal';
            } else if (type === 'corner') {
                text = 'un corner';
            } else if (type === 'shot') {
                text = 'un tiro';
            } else if (type === 'foul') {
                text = 'un fallo';
            } else if (type === 'yellow-card') {
                text = 'un cartellino giallo';
            } else if (type === 'red-card') {
                text = 'un cartellino rosso';
            }
            document.getElementById('remove-modal-header').textContent = `Sei sicuro di voler rimuovere ${text}?`;
            document.getElementById('remove-modal-message').textContent = `Verrà rimosso l'ultimo ${text} segnato dalla squadra ${team}.`;
            pendingRemovalAction = { type, team };
            document.getElementById('remove-modal').classList.add('is-active');
            vibrate([50]); // Modal open feedback
        }

        function hideRemoveModal() {
            document.getElementById('remove-modal').classList.remove('is-active');
            vibrate([30]); // Modal close feedback
        }

        function confirmRemoval() {
            const { type, team } = pendingRemovalAction;
            if (team === '1') {
                if (type === 'goal' && scoreTeam1 > 0) {
                    scoreTeam1--;
                    team1Scorers.pop();
                    renderScorers(1);
                } else if (type === 'corner') {
                    removeLatestEvent('team1', 'corners');
                } else if (type === 'shot') {
                    removeLatestEvent('team1', 'shots');
                } else if (type === 'foul') {
                    removeLatestEvent('team1', 'fouls');
                } else if (type === 'yellow-card') {
                    removeLatestEvent('team1', 'yellowCards');
                    // Rimuovi l'ultimo cartellino giallo dalla lista
                    for (let i = team1Cards.length - 1; i >= 0; i--) {
                        if (team1Cards[i].cardType === 'yellow') {
                            team1Cards.splice(i, 1);
                            break;
                        }
                    }
                    updateCardsList();
                } else if (type === 'red-card') {
                    removeLatestEvent('team1', 'redCards');
                    // Rimuovi l'ultimo cartellino rosso dalla lista
                    for (let i = team1Cards.length - 1; i >= 0; i--) {
                        if (team1Cards[i].cardType === 'red') {
                            team1Cards.splice(i, 1);
                            break;
                        }
                    }
                    updateCardsList();
                }
            } else if (team === '2') {
                if (type === 'goal' && scoreTeam2 > 0) {
                    scoreTeam2--;
                    team2Scorers.pop();
                    renderScorers(2);
                } else if (type === 'corner') {
                    removeLatestEvent('team2', 'corners');
                } else if (type === 'shot') {
                    removeLatestEvent('team2', 'shots');
                } else if (type === 'foul') {
                    removeLatestEvent('team2', 'fouls');
                } else if (type === 'yellow-card') {
                    removeLatestEvent('team2', 'yellowCards');
                    // Rimuovi l'ultimo cartellino giallo dalla lista
                    for (let i = team2Cards.length - 1; i >= 0; i--) {
                        if (team2Cards[i].cardType === 'yellow') {
                            team2Cards.splice(i, 1);
                            break;
                        }
                    }
                    updateCardsList();
                } else if (type === 'red-card') {
                    removeLatestEvent('team2', 'redCards');
                    // Rimuovi l'ultimo cartellino rosso dalla lista
                    for (let i = team2Cards.length - 1; i >= 0; i--) {
                        if (team2Cards[i].cardType === 'red') {
                            team2Cards.splice(i, 1);
                            break;
                        }
                    }
                    updateCardsList();
                }
            }
            updateScores();
            updateStats();
            hideRemoveModal();
            // Salva lo stato dopo la rimozione
            saveCurrentGameState();
            vibrate([100]); // Removal confirmation feedback
        }

        // Remove the latest event from the most recent period that has events
        function removeLatestEvent(team, eventType) {
            const events = eventsByPeriod[team][eventType];
            // Check periods in reverse order (3, 2, 1) to remove from most recent
            for (let period = 3; period >= 1; period--) {
                if (events[period.toString()] > 0) {
                    events[period.toString()]--;
                    return;
                }
            }
        }

        function renderScorers(team) {
            if (team === 1) {
                const list = document.getElementById('scorers-list-1');
                list.innerHTML = '<h4>Marcatori:</h4>';
                team1Scorers.forEach(s => {
                    const newScorer = document.createElement('div');
                    newScorer.classList.add('scorer-list-item');
                    newScorer.textContent = `${s.player} - ${s.minute || 0}' (${s.quarter})`;
                    list.appendChild(newScorer);
                });
            } else if (team === 2) {
                const list = document.getElementById('scorers-list-2');
                list.innerHTML = '<h4>Marcatori:</h4>';
                team2Scorers.forEach(s => {
                    const newScorer = document.createElement('div');
                    newScorer.classList.add('scorer-list-item');
                    newScorer.textContent = `Goal - ${s.minute || 0}' (${s.quarter})`;
                    list.appendChild(newScorer);
                });
            }
        }

        // Reset game function
        function resetGame() {
            scoreTeam1 = 0;
            scoreTeam2 = 0;
            shotsTeam1 = 0;
            cornersTeam1 = 0;
            foulsTeam1 = 0;
            shotsTeam2 = 0;
            cornersTeam2 = 0;
            foulsTeam2 = 0;
            team1Scorers = [];
            team2Scorers = [];
            team1Cards = [];
            team2Cards = [];
            matchLineup = [];
            matchNotes = '';

            // Reset period-based statistics
            eventsByPeriod = {
                team1: {
                    shots: { '1': 0, '2': 0, '3': 0 },
                    corners: { '1': 0, '2': 0, '3': 0 },
                    fouls: { '1': 0, '2': 0, '3': 0 },
                    yellowCards: { '1': 0, '2': 0, '3': 0 },
                    redCards: { '1': 0, '2': 0, '3': 0 }
                },
                team2: {
                    shots: { '1': 0, '2': 0, '3': 0 },
                    corners: { '1': 0, '2': 0, '3': 0 },
                    fouls: { '1': 0, '2': 0, '3': 0 },
                    yellowCards: { '1': 0, '2': 0, '3': 0 },
                    redCards: { '1': 0, '2': 0, '3': 0 }
                }
            };

            updateScores();
            updateStats();

            document.getElementById('scorers-list-1').innerHTML = '<h4>Marcatori:</h4>';
            document.getElementById('scorers-list-2').innerHTML = '<h4>Marcatori:</h4>';
            document.getElementById('cards-list-1').innerHTML = '<h4>Cartellini:</h4>';
            document.getElementById('cards-list-2').innerHTML = '<h4>Cartellini:</h4>';
            team1Shooters = {}; // Resetta variabile
if(document.getElementById('shooters-list-1')) {
    document.getElementById('shooters-list-1').innerHTML = '<h4>Tiri:</h4>'; // Pulisci HTML
}

            // Reset notes field
            const notesElement = document.getElementById('match-notes');
            if (notesElement) {
                notesElement.value = '';
            }

            resetTimer();
            hideResetModal();

            // Cancella lo stato salvato della partita quando si resetta
            clearCurrentGameState();

            // Release wake lock when returning to welcome screen
            releaseWakeLock();
            
            // Stop history listener
            if (historyListener && typeof historyListener === 'function') {
                historyListener();
                historyListener = null;
            }

            // Return to welcome screen
            mainApp.style.display = 'none';
            welcomeScreen.style.display = 'flex';
            welcomeOpponentName.value = '';
            
            // Hide lineup status
            const lineupStatus = document.getElementById('lineup-status');
            if (lineupStatus) {
                lineupStatus.classList.add('hidden');
            }
            
            vibrate([100, 50, 100]); // Reset feedback
        }

        function showResetModal() {
            document.getElementById('reset-modal').classList.add('is-active');
            vibrate([50]); // Modal open feedback
        }

        function hideResetModal() {
            document.getElementById('reset-modal').classList.remove('is-active');
            vibrate([30]); // Modal close feedback
        }

        // History functions with Firebase integration
        function setupFirebaseHistoryListener() {
            if (typeof window.setupHistoryListener === 'function') {
                historyListener = window.setupHistoryListener((historyList) => {
                    // Store in global variable for modal display
                    matchHistory = historyList;
                }, currentClub?.id);
            }
        }

        // Save cooldown functions
        function startSaveCooldown() {
            saveButtonCooldownActive = true;
            saveCooldownSeconds = 60;
            
            const saveButton = document.getElementById('save-button');
            const cooldownMessage = document.getElementById('save-cooldown-message');
            const cooldownTimer = document.getElementById('cooldown-timer');
            
            // Disable save button
            saveButton.disabled = true;
            
            // Show cooldown message
            cooldownMessage.style.display = 'block';
            
            // Update countdown timer
            saveCooldownTimer = setInterval(() => {
                saveCooldownSeconds--;
                cooldownTimer.textContent = saveCooldownSeconds;
                
                if (saveCooldownSeconds <= 0) {
                    endSaveCooldown();
                }
            }, 1000);
        }
        
        function endSaveCooldown() {
            saveButtonCooldownActive = false;
            
            const saveButton = document.getElementById('save-button');
            const cooldownMessage = document.getElementById('save-cooldown-message');
            
            // Re-enable save button
            saveButton.disabled = false;
            
            // Hide cooldown message
            cooldownMessage.style.display = 'none';
            
            // Clear timer
            if (saveCooldownTimer) {
                clearInterval(saveCooldownTimer);
                saveCooldownTimer = null;
            }
        }

        async function saveMatch() {
            const team1Name = currentClub ? currentClub.nome : 'POLIS';
            const team2Name = document.getElementById('team2-name').textContent;
            const notesElement = document.getElementById('match-notes');
            matchNotes = notesElement ? notesElement.value.trim() : '';

            // Determina se è una partita in trasferta
            const isAwayMatch = window.currentMatchType === 'away';
            
            // Se è trasferta, inverti i team nello storico
            // (squadra avversaria a sinistra, squadra locale a destra)
            const match = {
                team1: isAwayMatch ? team2Name : team1Name,
                team2: isAwayMatch ? team1Name : team2Name,
                score1: isAwayMatch ? scoreTeam2 : scoreTeam1,
                score2: isAwayMatch ? scoreTeam1 : scoreTeam2,
                shots1: isAwayMatch ? shotsTeam2 : shotsTeam1,
		shooters1: isAwayMatch ? {} : team1Shooters, // Salva l'oggetto dei tiratori
                corners1: isAwayMatch ? cornersTeam2 : cornersTeam1,
                fouls1: isAwayMatch ? foulsTeam2 : foulsTeam1,
                yellowCards1: isAwayMatch ? yellowCardsTeam2 : yellowCardsTeam1,
                redCards1: isAwayMatch ? redCardsTeam2 : redCardsTeam1,
                shots2: isAwayMatch ? shotsTeam1 : shotsTeam2,
                corners2: isAwayMatch ? cornersTeam1 : cornersTeam2,
                fouls2: isAwayMatch ? foulsTeam1 : foulsTeam2,
                yellowCards2: isAwayMatch ? yellowCardsTeam1 : yellowCardsTeam2,
                redCards2: isAwayMatch ? redCardsTeam1 : redCardsTeam2,
                date: new Date().toISOString(),
                scorers1: isAwayMatch ? team2Scorers : team1Scorers,
                scorers2: isAwayMatch ? team1Scorers : team2Scorers,
                cards1: isAwayMatch ? team2Cards : team1Cards,
                cards2: isAwayMatch ? team1Cards : team2Cards,
                societaId: currentClub?.id,
                notes: matchNotes,
                matchType: window.currentMatchType || 'home',
                // Add match lineup
                lineup: matchLineup,
                // Add period-based statistics (swapped if away)
                eventsByPeriod: isAwayMatch ? {
                    team1: eventsByPeriod.team2,
                    team2: eventsByPeriod.team1
                } : eventsByPeriod
            };

            try {
                // Save to Firebase
                if (typeof window.saveGameToFirebase === 'function') {
                    await window.saveGameToFirebase(match);
                    alert('Partita salvata su Firebase!');
                } else {
                    // Fallback to localStorage
                    const history = loadMatchHistoryLocal();
                    history.push(match);
                    localStorage.setItem('polis_match_history', JSON.stringify(history));
                    alert('Partita salvata nello storico locale!');
                }
                
                // Add vibration feedback
                vibrate([100, 50, 100]);
                
                // Cancella lo stato della partita corrente dopo averla salvata con successo
                clearCurrentGameState();
                
                // Start save cooldown
                startSaveCooldown();
            } catch (error) {
                console.error('Error saving match:', error);
                // Fallback to localStorage
                const history = loadMatchHistoryLocal();
                history.push(match);
                localStorage.setItem('polis_match_history', JSON.stringify(history));
                alert('Errore Firebase - Partita salvata nello storico locale!');
                
                // Cancella lo stato della partita corrente anche per il salvataggio di fallback
                clearCurrentGameState();
                
                // Start save cooldown even for fallback save
                startSaveCooldown();
            }
        }

        function loadMatchHistoryLocal() {
            const historyString = localStorage.getItem('polis_match_history');
            return historyString ? JSON.parse(historyString) : [];
        }

        async function loadMatchHistory() {
            try {
                if (typeof window.loadHistoryFromFirebase === 'function') {
                    return await window.loadHistoryFromFirebase();
                } else {
                    return loadMatchHistoryLocal();
                }
            } catch (error) {
                console.error('Error loading history from Firebase:', error);
                return loadMatchHistoryLocal();
            }
        }

        function showHistoryModal() {
            navigateToScreen('history', true);
            vibrate([50]); // Add haptic feedback
        }

        function hideHistoryModal() {
            // Use browser back to close history modal
            window.history.back();
            vibrate([30]); // Add haptic feedback
        }

        function showDeleteMatchModal(matchId) {
            pendingDeleteMatchId = matchId;
            document.getElementById('delete-match-modal').classList.add('is-active');
            vibrate([50]); // Add haptic feedback
        }

        function hideDeleteMatchModal() {
            pendingDeleteMatchId = null;
            document.getElementById('delete-match-modal').classList.remove('is-active');
            vibrate([30]); // Add haptic feedback
        }

        async function confirmDeleteMatch() {
            if (!pendingDeleteMatchId) return;

            try {
                // Try to delete from Firebase first
                if (typeof window.deleteGameFromFirebase === 'function') {
                    await window.deleteGameFromFirebase(pendingDeleteMatchId);
                    vibrate([100, 50, 100]); // Success vibration
                } else {
                    // Fallback to localStorage deletion
                    const history = loadMatchHistoryLocal();
                    const indexToDelete = parseInt(pendingDeleteMatchId);
                    if (indexToDelete >= 0 && indexToDelete < history.length) {
                        history.splice(indexToDelete, 1);
                        localStorage.setItem('polis_match_history', JSON.stringify(history));
                        vibrate([100, 50, 100]); // Success vibration
                    }
                }
                
                // Reset pendingDeleteMatchId after successful deletion
                pendingDeleteMatchId = null;
                
                // Close any open modals
                hideDeleteMatchModal();
                
                // Refresh the history display
                await renderHistory();
                
            } catch (error) {
                console.error('Error deleting match:', error);
                alert('Errore durante l\'eliminazione della partita.');
                vibrate([200, 100, 200]); // Error vibration
                throw error; // Re-throw to allow proper error handling in calling function
            }
        }

        // Show password modal for deletion
        function showPasswordDeleteModal() {
            // Hide the first confirmation modal WITHOUT resetting pendingDeleteMatchId
            document.getElementById('delete-match-modal').classList.remove('is-active');
            vibrate([30]); // Add haptic feedback
            
            document.getElementById('password-delete-modal').classList.add('is-active');
            document.getElementById('delete-password-input').value = ''; // Clear previous input
            document.getElementById('password-error').classList.add('hidden'); // Hide error message
            vibrate([50]); // Add haptic feedback
            
            // Focus on the password input field
            setTimeout(() => {
                document.getElementById('delete-password-input').focus();
            }, 100);
        }

        function hidePasswordDeleteModal() {
            document.getElementById('password-delete-modal').classList.remove('is-active');
            document.getElementById('delete-password-input').value = ''; // Clear input
            document.getElementById('password-error').classList.add('hidden'); // Hide error message
            vibrate([30]); // Add haptic feedback
        }

        function cancelPasswordDelete() {
            // Reset pendingDeleteMatchId when user cancels
            pendingDeleteMatchId = null;
            hidePasswordDeleteModal();
        }

        async function confirmPasswordDelete() {
            if (!pendingDeleteMatchId || !currentClub) {
                hidePasswordDeleteModal();
                return;
            }

            const password = document.getElementById('delete-password-input').value;
            const errorDiv = document.getElementById('password-error');
            
            if (!password) {
                errorDiv.textContent = 'Inserisci la password';
                errorDiv.classList.remove('hidden');
                vibrate([100, 50, 100]); // Error vibration
                return;
            }

            try {
                // Verify password with the society's codici array[1]
                const result = await window.verificaPasswordSocieta(currentClub.id, password);
                
                if (result.success) {
                    // Password correct, proceed with deletion
                    try {
                        await confirmDeleteMatch();
                        // Only hide modal and provide feedback if deletion was successful
                        hidePasswordDeleteModal();
                        vibrate([100]); // Success vibration
                    } catch (deleteError) {
                        // If deletion fails, show error but keep modal open
                        console.error('Deletion failed:', deleteError);
                        errorDiv.textContent = 'Errore durante l\'eliminazione della partita';
                        errorDiv.classList.remove('hidden');
                        vibrate([200, 100, 200]); // Error vibration
                    }
                } else {
                    // Show error message
                    errorDiv.textContent = result.message || 'Password non corretta';
                    errorDiv.classList.remove('hidden');
                    document.getElementById('delete-password-input').value = ''; // Clear input on error
                    vibrate([100, 50, 100, 50, 100]); // Error vibration
                    
                    // Focus back on input field
                    setTimeout(() => {
                        document.getElementById('delete-password-input').focus();
                    }, 100);
                }
            } catch (error) {
                console.error('Error verifying password:', error);
                errorDiv.textContent = 'Errore di connessione';
                errorDiv.classList.remove('hidden');
                vibrate([200, 100, 200]); // Error vibration
            }
        }

        // Helper function to generate period statistics table for individual match history
        function generateMatchPeriodStatsTable(match) {
            // Check if match has period data
            if (!match.eventsByPeriod) {
                return ''; // Return empty string for legacy matches without period data
            }

            const team1Events = match.eventsByPeriod.team1 || { shots: {}, corners: {}, fouls: {} };
            const team2Events = match.eventsByPeriod.team2 || { shots: {}, corners: {}, fouls: {} };
            
            // Determine if 3rd period was used
            const hasThirdPeriod = (team1Events.shots['3'] > 0) || (team1Events.corners['3'] > 0) || (team1Events.fouls['3'] > 0) ||
                                   (team2Events.shots['3'] > 0) || (team2Events.corners['3'] > 0) || (team2Events.fouls['3'] > 0);

            return `
                <div class="match-period-stats mt-3">
                    <h6 style="color: #4a90e2; margin-bottom: 0.5rem; font-size: 0.85rem; font-weight: 600;">Statistiche per tempo:</h6>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <h7 style="color: #68D391; font-size: 0.8rem; font-weight: 600;">${match.team1}</h7>
                            <table class="period-stats-table-history">
                                <thead>
                                    <tr>
                                        <th>Tempo</th>
                                        <th>Tiri</th>
                                        <th>Corner</th>
                                        <th>Falli</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1° tempo</td>
                                        <td>${team1Events.shots['1'] || 0}</td>
                                        <td>${team1Events.corners['1'] || 0}</td>
                                        <td>${team1Events.fouls['1'] || 0}</td>
                                    </tr>
                                    <tr>
                                        <td>2° tempo</td>
                                        <td>${team1Events.shots['2'] || 0}</td>
                                        <td>${team1Events.corners['2'] || 0}</td>
                                        <td>${team1Events.fouls['2'] || 0}</td>
                                    </tr>
                                    ${hasThirdPeriod ? `
                                    <tr>
                                        <td>3° tempo</td>
                                        <td>${team1Events.shots['3'] || 0}</td>
                                        <td>${team1Events.corners['3'] || 0}</td>
                                        <td>${team1Events.fouls['3'] || 0}</td>
                                    </tr>
                                    ` : ''}
                                    <tr class="totals-row">
                                        <td><strong>Totale</strong></td>
                                        <td><strong>${match.shots1 || 0}</strong></td>
                                        <td><strong>${match.corners1 || 0}</strong></td>
                                        <td><strong>${match.fouls1 || 0}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="flex-1">
                            <h7 style="color: #FC8181; font-size: 0.8rem; font-weight: 600;">${match.team2}</h7>
                            <table class="period-stats-table-history">
                                <thead>
                                    <tr>
                                        <th>Tempo</th>
                                        <th>Tiri</th>
                                        <th>Corner</th>
                                        <th>Falli</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1° tempo</td>
                                        <td>${team2Events.shots['1'] || 0}</td>
                                        <td>${team2Events.corners['1'] || 0}</td>
                                        <td>${team2Events.fouls['1'] || 0}</td>
                                    </tr>
                                    <tr>
                                        <td>2° tempo</td>
                                        <td>${team2Events.shots['2'] || 0}</td>
                                        <td>${team2Events.corners['2'] || 0}</td>
                                        <td>${team2Events.fouls['2'] || 0}</td>
                                    </tr>
                                    ${hasThirdPeriod ? `
                                    <tr>
                                        <td>3° tempo</td>
                                        <td>${team2Events.shots['3'] || 0}</td>
                                        <td>${team2Events.corners['3'] || 0}</td>
                                        <td>${team2Events.fouls['3'] || 0}</td>
                                    </tr>
                                    ` : ''}
                                    <tr class="totals-row">
                                        <td><strong>Totale</strong></td>
                                        <td><strong>${match.shots2 || 0}</strong></td>
                                        <td><strong>${match.corners2 || 0}</strong></td>
                                        <td><strong>${match.fouls2 || 0}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to populate month filter dropdown
        function populateMonthFilter(history, preserveSelection = true) {
            const monthFilter = document.getElementById('month-filter');
            if (!monthFilter) return;
            
            // Save the currently selected value before repopulating
            const currentSelection = preserveSelection ? monthFilter.value : null;
            
            // Get unique months from history
            const months = new Set();
            history.forEach(match => {
                const matchDate = new Date(match.date);
                const monthYear = `${matchDate.getFullYear()}-${String(matchDate.getMonth() + 1).padStart(2, '0')}`;
                months.add(monthYear);
            });
            
            // Sort months in descending order (most recent first)
            const sortedMonths = Array.from(months).sort((a, b) => b.localeCompare(a));
            
            // Clear existing options except "all"
            monthFilter.innerHTML = '<option value="all">Tutti i mesi</option>';
            
            // Add month options
            sortedMonths.forEach(monthYear => {
                const [year, month] = monthYear.split('-');
                const date = new Date(year, parseInt(month) - 1);
                const monthName = date.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = monthYear;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                monthFilter.appendChild(option);
            });
            
            // Restore the previously selected value or default to the latest month
            if (currentSelection && currentSelection !== 'all') {
                // Try to restore the previous selection
                const optionExists = Array.from(monthFilter.options).some(opt => opt.value === currentSelection);
                if (optionExists) {
                    monthFilter.value = currentSelection;
                } else if (sortedMonths.length > 0) {
                    // If previous selection no longer exists, select the latest month
                    monthFilter.value = sortedMonths[0];
                }
            } else if (sortedMonths.length > 0 && (!preserveSelection || currentSelection === 'all')) {
                // Default to the latest month if no selection or "all" was selected
                monthFilter.value = sortedMonths[0];
            }
        }

        async function renderHistory(preserveSelection = true) {
            let history = [];
            
            // Try to use Firebase history first, then fallback to localStorage
            if (matchHistory.length > 0) {
                history = matchHistory;
            } else {
                history = await loadMatchHistory();
            }
            
            history = history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Update total matches played
            const totalMatchesElement = document.getElementById('total-matches-played');
            if (totalMatchesElement) {
                totalMatchesElement.textContent = history.length;
            }
            
            // Calcola risultati partite (vinte, perse, pareggiate)
            let matchesWon = 0, matchesLost = 0, matchesDrawn = 0;
            history.forEach(match => {
                // Determina quale team rappresenta la squadra corrente
                const currentTeamName = currentClub ? currentClub.nome : 'POLIS';
                const isTeam1 = match.team1 === currentTeamName;
                
                let ourScore, theirScore;
                if (isTeam1) {
                    ourScore = match.score1 || 0;
                    theirScore = match.score2 || 0;
                } else {
                    ourScore = match.score2 || 0;
                    theirScore = match.score1 || 0;
                }
                
                if (ourScore > theirScore) {
                    matchesWon++;
                } else if (ourScore < theirScore) {
                    matchesLost++;
                } else {
                    matchesDrawn++;
                }
            });
            
            // Aggiorna i totali dei risultati
            document.getElementById('total-matches-won').textContent = matchesWon;
            document.getElementById('total-matches-lost').textContent = matchesLost;
            document.getElementById('total-matches-drawn').textContent = matchesDrawn;
            
            // Calcola le statistiche generali e la classifica marcatori
            const allScorers = {};
            history.forEach(match => {
                // Determina quale team rappresenta la squadra corrente
                const currentTeamName = currentClub ? currentClub.nome : 'POLIS';
                const isTeam1 = match.team1 === currentTeamName;
                
                // Usa i marcatori del team corretto
                const ourScorers = isTeam1 ? match.scorers1 : match.scorers2;
                
                if (ourScorers && Array.isArray(ourScorers)) {
                    ourScorers.forEach(scorer => {
                        if (scorer.player) {
                            if (!allScorers[scorer.player]) {
                                allScorers[scorer.player] = 0;
                            }
                            allScorers[scorer.player]++;
                        }
                    });
                }
            });
            
            // Ordina i marcatori per numero di gol
            const sortedScorers = Object.entries(allScorers).sort(([, a], [, b]) => b - a);

            // Calcola le statistiche totali per il riepilogo
            let totalGoalsMade = 0, totalGoalsConceded = 0;
            let totalShotsMade = 0, totalShotsConceded = 0;
            let totalCornersMade = 0, totalCornersConceded = 0;
            let totalFoulsMade = 0, totalFoulsConceded = 0;

            history.forEach(match => {
                // Determina quale team rappresenta la squadra corrente
                const currentTeamName = currentClub ? currentClub.nome : 'POLIS';
                const isTeam1 = match.team1 === currentTeamName;
                
                if (isTeam1) {
                    // La squadra corrente è team1
                    totalGoalsMade += match.score1 || 0;
                    totalGoalsConceded += match.score2 || 0;
                    totalShotsMade += match.shots1 || 0;
                    totalShotsConceded += match.shots2 || 0;
                    totalCornersMade += match.corners1 || 0;
                    totalCornersConceded += match.corners2 || 0;
                    totalFoulsMade += match.fouls1 || 0;
                    totalFoulsConceded += match.fouls2 || 0;
                } else {
                    // La squadra corrente è team2
                    totalGoalsMade += match.score2 || 0;
                    totalGoalsConceded += match.score1 || 0;
                    totalShotsMade += match.shots2 || 0;
                    totalShotsConceded += match.shots1 || 0;
                    totalCornersMade += match.corners2 || 0;
                    totalCornersConceded += match.corners1 || 0;
                    totalFoulsMade += match.fouls2 || 0;
                    totalFoulsConceded += match.fouls1 || 0;
                }
            });

            // Aggiorna le statistiche del riepilogo
            document.getElementById('total-goals-made').textContent = totalGoalsMade;
            document.getElementById('total-goals-conceded').textContent = totalGoalsConceded;
            document.getElementById('total-shots-made').textContent = totalShotsMade;
            document.getElementById('total-shots-conceded').textContent = totalShotsConceded;
            document.getElementById('total-corners-made').textContent = totalCornersMade;
            document.getElementById('total-corners-conceded').textContent = totalCornersConceded;
            document.getElementById('total-fouls-made').textContent = totalFoulsMade;
            document.getElementById('total-fouls-conceded').textContent = totalFoulsConceded;

            // Renderizza la classifica marcatori
            const scorersTableBody = document.getElementById('scorers-table-body');
            scorersTableBody.innerHTML = '';
            if (sortedScorers.length > 0) {
                sortedScorers.forEach(([player, goals], index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player}</td>
                        <td>${goals}</td>
                    `;
                    scorersTableBody.appendChild(row);
                });
            } else {
                scorersTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">Nessun marcatore.</td></tr>';
            }

            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            // Populate month filter
            populateMonthFilter(history, preserveSelection);
            
            // Get selected month filter
            const selectedMonth = document.getElementById('month-filter').value;
            
            // Filter history by selected month
            let filteredHistory = history;
            if (selectedMonth !== 'all') {
                filteredHistory = history.filter(match => {
                    const matchDate = new Date(match.date);
                    const monthYear = `${matchDate.getFullYear()}-${String(matchDate.getMonth() + 1).padStart(2, '0')}`;
                    return monthYear === selectedMonth;
                });
            }
            
            if (filteredHistory.length === 0) {
                historyList.innerHTML = '<div class="text-center text-gray-400">Nessuna partita salvata.</div>';
            } else {
                filteredHistory.forEach((match) => {
                    // Find the original index in the complete history array
                    const originalIndex = history.findIndex(m => m.date === match.date && m.team1 === match.team1 && m.team2 === match.team2);
                    
                    const historyItem = document.createElement('div');
                    historyItem.classList.add('history-item');
                    const formattedDate = new Date(match.date).toLocaleDateString('it-IT', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    // Determina quale team è la squadra corrente (POLIS)
                    const currentTeamName = currentClub ? currentClub.nome : 'POLIS';
                    const isTeam1 = match.team1 === currentTeamName;
                    
                    // Assegna i marcatori in base alla posizione effettiva della squadra
                    const ourScorers = isTeam1 ? match.scorers1 : match.scorers2;
                    const theirScorers = isTeam1 ? match.scorers2 : match.scorers1;
                    const opponentName = isTeam1 ? match.team2 : match.team1;
                    
                    const team1ScorersText = ourScorers && ourScorers.length > 0 ? 
                        `<br><span>Marcatori ${currentTeamName}: ${ourScorers.map(s => `${s.player} - ${s.minute || 0}' (${s.quarter})`).join(', ')}</span>` : '';
                    const team2ScorersText = theirScorers && theirScorers.length > 0 ? 
                        `<br><span>Marcatori ${opponentName}: ${theirScorers.map(s => `Goal - ${s.minute || 0}' (${s.quarter})`).join(', ')}</span>` : '';
// --- NUOVO CODICE DA INSERIRE ---
// Formatta l'oggetto shooters1 (es: "Rossi: 2, Bianchi: 1")
let team1ShootersText = '';
const shootersData = isTeam1 ? match.shooters1 : match.shooters2; // Prende i dati giusti

if (shootersData && Object.keys(shootersData).length > 0) {
    // Converte l'oggetto in una stringa leggibile
    const shootersList = Object.entries(shootersData)
        .map(([name, count]) => `${name} (${count})`)
        .join(', ');
    
    team1ShootersText = `<br><span class="text-gray-400" style="font-size: 0.9em;">👟 Tiri ${currentTeamName}: ${shootersList}</span>`;
}
// --------------------------------
                    const lineupText = match.lineup && match.lineup.length > 0 ?
                        `<br><span class="font-semibold text-blue-300">Formazione: ${match.lineup.join(', ')}</span>` : '';
                    const notesText = match.notes && match.notes.trim() ? 
                        `<br><span class="font-semibold text-yellow-300">Note: ${match.notes}</span>` : '';

                    // Generate period statistics table for this match
                    const periodStatsTable = generateMatchPeriodStatsTable(match);

                    historyItem.innerHTML = `
                        <div class="history-item-header" data-match-index="${originalIndex}">
                            <div class="history-item-summary">
                                <div class="history-date">${formattedDate}</div>
                                <div class="font-bold text-xl history-match-title">${match.team1} ${match.score1} - ${match.score2} ${match.team2}</div>
                            </div>
                            <span class="history-caret">▶</span>
                        </div>
                        <div class="history-item-details">
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-share px-3 py-2 text-sm share-match-btn" data-match-index="${originalIndex}">
                                    Condividi
                                </button>
                                <button class="btn btn-reset px-3 py-2 text-sm delete-match-btn" data-match-id="${match.id || originalIndex}">
                                    🗑️
                                </button>
                            </div>
                            <div class="mt-2 text-sm text-gray-300">
                                <div>Tiri: ${match.shots1 || 0} - ${match.shots2 || 0}</div>
                                <div>Corner: ${match.corners1 || 0} - ${match.corners2 || 0}</div>
                                <div>Falli: ${match.fouls1 || 0} - ${match.fouls2 || 0}</div>
                                <div>Cartellini gialli: ${match.yellowCards1 || 0} - ${match.yellowCards2 || 0}</div>
                                <div>Cartellini rossi: ${match.redCards1 || 0} - ${match.redCards2 || 0}</div>
                                ${team1ScorersText}
				${team1ShootersText}  ${team2ScorersText}
                                ${team2ScorersText}
                                ${lineupText}
                                ${notesText}
                            </div>
                            ${periodStatsTable}
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                });
                
                // Add event listeners to expand/collapse match details
                document.querySelectorAll('.history-item-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const details = header.nextElementSibling;
                        const caret = header.querySelector('.history-caret');
                        
                        if (details.classList.contains('expanded')) {
                            details.classList.remove('expanded');
                            caret.classList.remove('expanded');
                        } else {
                            details.classList.add('expanded');
                            caret.classList.add('expanded');
                        }
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-match-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const matchId = e.target.dataset.matchId;
                        showDeleteMatchModal(matchId);
                    });
                });
                
                // Add event listeners to share buttons
                document.querySelectorAll('.share-match-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const matchIndex = parseInt(e.target.dataset.matchIndex);
                        const matchData = history[matchIndex];
                        await shareSingleMatch(matchData);
                    });
                });
            }
        }

        // Reusable function to generate and share match image
        async function shareSingleMatch(matchData = null) {
            vibrate([50]); // Button feedback
            
            let team1Name, team2Name, score1, score2, shots1, shots2, corners1, corners2, fouls1, fouls2, yellowCards1, yellowCards2, redCards1, redCards2, scorers1, scorers2, cards1, cards2, notes, lineup;
            
            if (matchData) {
                // Use provided match data (for history sharing)
                team1Name = matchData.team1;
                team2Name = matchData.team2;
                score1 = matchData.score1;
                score2 = matchData.score2;
                shots1 = matchData.shots1 || 0;
                shots2 = matchData.shots2 || 0;
                corners1 = matchData.corners1 || 0;
                corners2 = matchData.corners2 || 0;
                fouls1 = matchData.fouls1 || 0;
                fouls2 = matchData.fouls2 || 0;
                yellowCards1 = matchData.yellowCards1 || 0;
                yellowCards2 = matchData.yellowCards2 || 0;
                redCards1 = matchData.redCards1 || 0;
                redCards2 = matchData.redCards2 || 0;
                scorers1 = matchData.scorers1 || [];
                scorers2 = matchData.scorers2 || [];
                cards1 = matchData.cards1 || [];
                cards2 = matchData.cards2 || [];
                notes = matchData.notes || '';
                lineup = matchData.lineup || [];
            } else {
                // Use current game data (for main share button)
                team1Name = currentClub ? currentClub.nome : 'POLIS';
                team2Name = document.getElementById('team2-name').textContent;
                score1 = scoreTeam1;
                score2 = scoreTeam2;
                shots1 = shotsTeam1;
                shots2 = shotsTeam2;
                corners1 = cornersTeam1;
                corners2 = cornersTeam2;
                fouls1 = foulsTeam1;
                fouls2 = foulsTeam2;
                yellowCards1 = yellowCardsTeam1;
                yellowCards2 = yellowCardsTeam2;
                redCards1 = redCardsTeam1;
                redCards2 = redCardsTeam2;
                scorers1 = team1Scorers;
                scorers2 = team2Scorers;
                cards1 = team1Cards;
                cards2 = team2Cards;
                const notesElement = document.getElementById('match-notes');
                notes = notesElement ? notesElement.value.trim() : '';
                lineup = matchLineup || [];
            }
            
            try {
                // Create a canvas element to generate a summary image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate dynamic height based on number of scorers, cards and notes
                const baseHeight = 460; // Base height up to "Falli" line
                const scorersMargin = 40; // Space between sections
                const lineHeight = 25; // Height per scorer line
                const headerHeight = 30; // Height for scorer headers
                const notesMargin = 30; // Space for notes section
                const notesLineHeight = 25; // Height per notes line
                
                let totalScorers = 0;
                let scorerSections = 0;
                let totalCards = 0;
                let cardSections = 0;
                
                if (scorers1.length > 0) {
                    totalScorers += scorers1.length;
                    scorerSections++;
                }
                if (scorers2.length > 0) {
                    totalScorers += scorers2.length;
                    scorerSections++;
                }
                
                if (cards1.length > 0) {
                    totalCards += cards1.length;
                    cardSections++;
                }
                if (cards2.length > 0) {
                    totalCards += cards2.length;
                    cardSections++;
                }
                
                // Calculate height for lineup (assuming max 50 characters per line)
                let lineupLines = 0;
                if (lineup && lineup.length > 0) {
                    const lineupText = lineup.join(', ');
                    // Count actual data lines (not including header)
                    lineupLines = Math.ceil(lineupText.length / 45); // Conservative estimate (45 chars/line due to word wrapping)
                }
                
                // Calculate height for notes (assuming max 50 characters per line)
                let notesLines = 0;
                if (notes && notes.trim()) {
                    notesLines = Math.ceil(notes.length / 50) + 1; // +1 for "Note:" header
                }
                
                const dynamicHeight = baseHeight + 
                    (scorerSections * headerHeight) + 
                    (totalScorers * lineHeight) + 
                    (scorerSections * scorersMargin) + 
                    (cardSections * headerHeight) + 
                    (totalCards * lineHeight) + 
                    (cardSections * scorersMargin) + 
                    (lineupLines > 0 ? headerHeight : 0) + // Header "Formazione:"
                    (lineupLines * lineHeight) + // Data lines
                    (lineupLines > 0 ? scorersMargin : 0) +
                    (notesLines * notesLineHeight) +
                    (notesLines > 0 ? notesMargin : 0) +
                    60; // Bottom padding
                
                // Set canvas size with dynamic height
                canvas.width = 800;
                canvas.height = Math.max(600, dynamicHeight); // Minimum 600px
                
                // Set background
                ctx.fillStyle = '#1A202C';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Set text styles
                ctx.fillStyle = '#f1f5f9';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                
                // Title
                ctx.fillText('StaKick', canvas.width / 2, 80);
                
                // Date
                ctx.font = '20px Arial';
                let currentDate;
                if (matchData && matchData.date) {
                    currentDate = new Date(matchData.date).toLocaleDateString('it-IT', { 
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                    });
                } else {
                    currentDate = new Date().toLocaleDateString('it-IT', { 
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                    });
                }
                ctx.fillText(currentDate, canvas.width / 2, 120);
                
                // Team names
                ctx.font = 'bold 36px Arial';
                ctx.fillText(team1Name, 200, 200);
                ctx.fillText(team2Name, 600, 200);
                
                // Score
                ctx.font = 'bold 80px Arial';
                ctx.fillText(`${score1} - ${score2}`, canvas.width / 2, 280);
                
                // Statistics
                ctx.font = '24px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('Statistiche:', 50, 350);
                ctx.fillText(`Tiri: ${shots1} - ${shots2}`, 50, 380);
                ctx.fillText(`Corner: ${corners1} - ${corners2}`, 50, 410);
                ctx.fillText(`Falli: ${fouls1} - ${fouls2}`, 50, 440);
                ctx.fillText(`Cartellini gialli: ${yellowCards1} - ${yellowCards2}`, 50, 470);
                ctx.fillText(`Cartellini rossi: ${redCards1} - ${redCards2}`, 50, 500);
                
                // Markers
                if (scorers1.length > 0) {
                    ctx.fillText(`Marcatori ${team1Name}:`, 50, 540);
                    scorers1.forEach((scorer, index) => {
                        const text = typeof scorer === 'string' ? scorer : `${scorer.player} - ${scorer.minute || 0}' (${scorer.quarter})`;
                        ctx.fillText(text, 70, 570 + (index * 25));
                    });
                }
                
                if (scorers2.length > 0) {
                    const startY = scorers1.length > 0 ? 570 + (scorers1.length * 25) + 30 : 540;
                    ctx.fillText(`Marcatori ${team2Name}:`, 50, startY);
                    scorers2.forEach((scorer, index) => {
                        const text = typeof scorer === 'string' ? scorer : `Goal - ${scorer.minute || 0}' (${scorer.quarter})`;
                        ctx.fillText(text, 70, startY + 30 + (index * 25));
                    });
                }
                
                // Cards section
                let cardsStartY;
                if (scorers2.length > 0) {
                    cardsStartY = 570 + (scorers1.length * 25) + 30 + 30 + (scorers2.length * 25) + 30;
                } else if (scorers1.length > 0) {
                    cardsStartY = 570 + (scorers1.length * 25) + 30;
                } else {
                    cardsStartY = 540;
                }
                
                if (cards1.length > 0) {
                    ctx.fillText(`Cartellini ${team1Name}:`, 50, cardsStartY);
                    cards1.forEach((card, index) => {
                        const cardIcon = card.cardType === 'yellow' ? '🟨' : '🟥';
                        const text = `${cardIcon} ${card.player} - ${card.minute}' (${card.quarter})`;
                        ctx.fillText(text, 70, cardsStartY + 30 + (index * 25));
                    });
                }
                
                if (cards2.length > 0) {
                    const cards2StartY = cards1.length > 0 ? cardsStartY + 30 + (cards1.length * 25) + 30 : cardsStartY;
                    ctx.fillText(`Cartellini ${team2Name}:`, 50, cards2StartY);
                    cards2.forEach((card, index) => {
                        const cardIcon = card.cardType === 'yellow' ? '🟨' : '🟥';
                        const text = `${cardIcon} ${card.player} - ${card.minute}' (${card.quarter})`;
                        ctx.fillText(text, 70, cards2StartY + 30 + (index * 25));
                    });
                }
                
                // Lineup
                let lineupStartY;
                if (lineup && lineup.length > 0) {
                    if (cards2.length > 0) {
                        lineupStartY = cardsStartY + 30 + (cards1.length * 25) + 30 + 30 + (cards2.length * 25) + 30;
                    } else if (cards1.length > 0) {
                        lineupStartY = cardsStartY + 30 + (cards1.length * 25) + 30;
                    } else if (scorers2.length > 0) {
                        lineupStartY = 570 + (scorers1.length * 25) + 30 + 30 + (scorers2.length * 25) + 30;
                    } else if (scorers1.length > 0) {
                        lineupStartY = 570 + (scorers1.length * 25) + 30;
                    } else {
                        lineupStartY = 540;
                    }
                    
                    ctx.fillText('Formazione:', 50, lineupStartY);
                    
                    // Break lineup into lines (max 50 characters per line)
                    const lineupText = lineup.join(', ');
                    const words = lineupText.split(' ');
                    let currentLine = '';
                    let lineIndex = 0;
                    
                    for (const word of words) {
                        const testLine = currentLine + word + ' ';
                        if (testLine.length <= 50) {
                            currentLine = testLine;
                        } else {
                            if (currentLine) {
                                ctx.fillText(currentLine.trim(), 70, lineupStartY + 30 + (lineIndex * 25));
                                lineIndex++;
                            }
                            currentLine = word + ' ';
                        }
                    }
                    
                    // Draw the last line
                    if (currentLine) {
                        ctx.fillText(currentLine.trim(), 70, lineupStartY + 30 + (lineIndex * 25));
                    }
                }
                
                // Notes
                if (notes && notes.trim()) {
                    let notesStartY;
                    if (lineup && lineup.length > 0) {
                        // Calculate based on lineup position
                        const lineupLines = Math.ceil(lineup.join(', ').length / 50);
                        notesStartY = lineupStartY + 30 + (lineupLines * 25) + 30;
                    } else if (cards2.length > 0) {
                        notesStartY = cardsStartY + 30 + (cards1.length * 25) + 30 + 30 + (cards2.length * 25) + 30;
                    } else if (cards1.length > 0) {
                        notesStartY = cardsStartY + 30 + (cards1.length * 25) + 30;
                    } else if (scorers2.length > 0) {
                        notesStartY = 570 + (scorers1.length * 25) + 30 + 30 + (scorers2.length * 25) + 30;
                    } else if (scorers1.length > 0) {
                        notesStartY = 570 + (scorers1.length * 25) + 30;
                    } else {
                        notesStartY = 540;
                    }
                    
                    ctx.fillText('Note:', 50, notesStartY);
                    
                    // Break notes into lines (max 50 characters per line)
                    const words = notes.split(' ');
                    let currentLine = '';
                    let lineIndex = 0;
                    
                    for (const word of words) {
                        const testLine = currentLine + word + ' ';
                        if (testLine.length <= 50) {
                            currentLine = testLine;
                        } else {
                            if (currentLine) {
                                ctx.fillText(currentLine.trim(), 70, notesStartY + 30 + (lineIndex * 25));
                                lineIndex++;
                            }
                            currentLine = word + ' ';
                        }
                    }
                    
                    // Draw the last line
                    if (currentLine) {
                        ctx.fillText(currentLine.trim(), 70, notesStartY + 30 + (lineIndex * 25));
                    }
                }
                
                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    try {
                        // Try to use native share API if available
                        if (navigator.share && navigator.canShare) {
                            const file = new File([blob], 'polis-partita.png', { type: 'image/png' });
                            const shareData = {
                                title: 'Risultato Partita - StaKick',
                                files: [file]
                            };
                            
                            if (navigator.canShare(shareData)) {
                                await navigator.share(shareData);
                                return;
                            }
                        }
                        
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'polis-partita.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('Immagine della partita scaricata!');
                    } catch (error) {
                        console.log('Share failed:', error);
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'polis-partita.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('Immagine della partita scaricata!');
                    }
                }, 'image/png');
            } catch (error) {
                console.error('Error creating image:', error);
                alert('Errore nella creazione dell\'immagine.');
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize navigation history management
            initializeNavigationHistory();
            
            // Initialize wake lock support detection
            initializeWakeLock();
            
            // Check and restore login state from localStorage if available
            const savedLoginState = localStorage.getItem('polis_login_state');
            let isLoggedIn = false;
            
            if (savedLoginState) {
                try {
                    const loginState = JSON.parse(savedLoginState);
                    const timeDiff = Date.now() - loginState.timestamp;
                    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 giorni in millisecondi
                    
                    // Check if login state is still valid
                    if (timeDiff <= maxAge && loginState.club) {
                        // Restore login state
                        currentClub = loginState.club;
                        currentPlayers = loginState.players || [...defaultPlayers];
                        players = [...currentPlayers];
                        teamNumPeriods = loginState.numPeriods || 2;
                        
                        // Update team names in UI
                        const menuTeamNameElement = document.getElementById('menu-team-name');
                        if (menuTeamNameElement) menuTeamNameElement.textContent = `Benvenuto, ${currentClub.nome}!`;
                        
                        const playersTeamNameElement = document.getElementById('players-team-name');
                        if (playersTeamNameElement) playersTeamNameElement.textContent = currentClub.nome;
                        
                        // Setup Firebase history listener for this team
                        setupFirebaseHistoryListener();
                        
                        // Navigate to menu screen instead of showing login
                        navigateToScreen('menu', false);
                        isLoggedIn = true;
                        
                        console.log('✅ Stato login ripristinato da localStorage:', currentClub.nome);
                    } else {
                        // Login state expired or invalid
                        localStorage.removeItem('polis_login_state');
                        console.log('⏰ Stato login scaduto o non valido, rimosso da localStorage');
                    }
                } catch (error) {
                    console.error('❌ Errore nel ripristino dello stato login:', error);
                    localStorage.removeItem('polis_login_state');
                }
            }
            
            // Controlla se c'è una partita salvata disponibile prima di mostrare il login
            // Questo permetterà di mostrare la notifica cliccabile nella schermata di login
            const savedState = localStorage.getItem('polis_current_game_state');
            let hasSavedGame = false;
            let savedGameInfo = null;
            
            if (savedState) {
                try {
                    const gameState = JSON.parse(savedState);
                    const timeDiff = Date.now() - gameState.savedAt;
                    const maxAge = 24 * 60 * 60 * 1000; // 24 ore in millisecondi
                    
                    if (timeDiff <= maxAge) {
                        hasSavedGame = true;
                        // Crea le informazioni per la notifica senza ripristinare ancora il gioco
                        savedGameInfo = {
                            hasTimer: gameState.timer && (gameState.timer.timerState !== 'stopped'),
                            hasScorers: ((gameState.team1Scorers && gameState.team1Scorers.length > 0) || 
                                       (gameState.team2Scorers && gameState.team2Scorers.length > 0)),
                            timerState: gameState.timer ? gameState.timer.timerState : 'unknown',
                            scorersCount: (gameState.team1Scorers ? gameState.team1Scorers.length : 0) + 
                                        (gameState.team2Scorers ? gameState.team2Scorers.length : 0)
                        };
                    } else {
                        // Stato troppo vecchio, rimuovilo
                        localStorage.removeItem('polis_current_game_state');
                    }
                } catch (error) {
                    console.error('Errore nel controllo dello stato salvato:', error);
                    localStorage.removeItem('polis_current_game_state');
                }
            }
            
            // Se non c'è una partita salvata, tenta di ripristinare lo stato della partita se presente
            // (questo succede quando si ricarica la pagina durante una partita)
            if (!hasSavedGame && isLoggedIn) {
                const restorationInfo = restoreGameState();
                if (restorationInfo) {
                    // Aggiorna la UI con lo stato ripristinato
                    setTimeout(() => {
                        updateAllDisplays();
                        showGameStateRestoredMessage(restorationInfo);
                    }, 1000);
                }
            }
            
            // Login and navigation
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('login-code-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            // Pre-fill login code from localStorage if it was saved
            const rememberedCode = localStorage.getItem('polis_remembered_code');
            if (rememberedCode) {
                const loginInput = document.getElementById('login-code-input');
                const rememberCheckbox = document.getElementById('remember-code-checkbox');
                if (loginInput) {
                    loginInput.value = rememberedCode;
                    console.log('✅ Codice precompilato da localStorage');
                }
                if (rememberCheckbox) {
                    rememberCheckbox.checked = true;
                }
            }
            
            // Se c'è una partita salvata, aggiungi un listener per mostrare la notifica quando appare il login
            if (hasSavedGame && savedGameInfo) {
                // Observer per rilevare quando la schermata di login diventa visibile
                const loginObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            const loginScreen = document.getElementById('login-screen');
                            if (loginScreen.style.display === 'flex' || 
                                (loginScreen.style.display === '' && window.getComputedStyle(loginScreen).display !== 'none')) {
                                // La schermata di login è diventata visibile, mostra la notifica
                                setTimeout(() => {
                                    showGameStateRestoredMessage(savedGameInfo);
                                }, 500);
                                // Disconnetti l'observer dopo aver mostrato la notifica
                                loginObserver.disconnect();
                            }
                        }
                    });
                });
                
                // Avvia l'osservazione della schermata di login
                const loginScreen = document.getElementById('login-screen');
                loginObserver.observe(loginScreen, { 
                    attributes: true, 
                    attributeFilter: ['style'] 
                });
                
                // Controlla anche immediatamente se il login è già visibile
                setTimeout(() => {
                    if (loginScreen.style.display === 'flex' || 
                        (loginScreen.style.display === '' && window.getComputedStyle(loginScreen).display !== 'none')) {
                        showGameStateRestoredMessage(savedGameInfo);
                        loginObserver.disconnect();
                    }
                }, 1500);
            }
            
            // Menu buttons
            document.getElementById('start-match-btn').addEventListener('click', showMatchSetup);
            document.getElementById('manage-players-btn').addEventListener('click', showPlayersManagement);
            document.getElementById('view-history-btn').addEventListener('click', showHistoryModal);
            document.getElementById('back-to-login-btn').addEventListener('click', backToLogin);
            
            // Players management
            document.getElementById('add-player-btn').addEventListener('click', addPlayer);
            document.getElementById('new-player-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addPlayer();
                }
            });
            document.getElementById('save-players-btn').addEventListener('click', savePlayersChanges);
            document.getElementById('back-to-menu-from-players-btn').addEventListener('click', backToMenuFromPlayers);
            document.getElementById('back-to-menu-btn').addEventListener('click', backToMenu);
            
            // Lineup button
            document.getElementById('insert-lineup-btn').addEventListener('click', showLineupModal);
            document.getElementById('confirm-lineup-button').addEventListener('click', confirmLineup);
            document.getElementById('cancel-lineup-button').addEventListener('click', hideLineupModal);
            
            // Start game button
            startGameBtn.addEventListener('click', startGame);

            // Timer controls
            document.getElementById('start-timer-button').addEventListener('click', startTimer);
            document.getElementById('pause-timer-button').addEventListener('click', pauseTimer);
            document.getElementById('reset-timer-button').addEventListener('click', resetTimer);

            // Period selection modal event listeners
            document.getElementById('select-period-1').addEventListener('click', () => selectPeriodAndStartTimer(1));
            document.getElementById('select-period-2').addEventListener('click', () => selectPeriodAndStartTimer(2));
            document.getElementById('select-period-3').addEventListener('click', () => selectPeriodAndStartTimer(3));
            document.getElementById('cancel-period-selection').addEventListener('click', hidePeriodSelectionModal);

            // Timer setup modal
            document.getElementById('timer-display').addEventListener('click', () => {
                pauseTimer();
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                document.getElementById('timer-minutes-input').value = minutes;
                document.getElementById('timer-seconds-input').value = seconds;
                document.getElementById('timer-setup-modal').classList.add('is-active');
                vibrate([50]); // Timer modal open feedback
            });

            // Edit timer button
            document.getElementById('edit-timer-button').addEventListener('click', () => {
                pauseTimer();
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                document.getElementById('timer-minutes-input').value = minutes;
                document.getElementById('timer-seconds-input').value = seconds;
                document.getElementById('timer-setup-modal').classList.add('is-active');
                vibrate([50]); // Timer modal open feedback
            });

            document.getElementById('set-timer-button').addEventListener('click', () => {
                const minutes = parseInt(document.getElementById('timer-minutes-input').value);
                const seconds = parseInt(document.getElementById('timer-seconds-input').value);
                if (!isNaN(minutes) && !isNaN(seconds)) {
                    // Reset timer to new duration
                    pauseTimer(); // Stop current timer if running
                    totalSeconds = (minutes * 60) + seconds;
                    lastSetSeconds = totalSeconds;
                    
                    // Reset all timer state variables
                    timerStartTime = null;
                    pausedDuration = 0;
                    pauseStartTime = null;
                    currentPeriod = null;
                    
                    // Hide period display
                    const periodDisplay = document.getElementById('current-period-display');
                    periodDisplay.style.display = 'none';
                    
                    updateTimerDisplay();
                    document.getElementById('timer-setup-modal').classList.remove('is-active');
                    vibrate([100]); // Timer set confirmation
                }
            });

            // Action buttons (goals, corners, shots)
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const team = button.dataset.team;
                    const type = button.dataset.type;
                    const action = button.dataset.action;
                    const quarter = button.dataset.quarter;

                    // Add vibration feedback for all button clicks
                    if (type === 'goal') {
                        vibrate([80]); // Goal button feedback
                    } else {
                        vibrate([50]); // Standard button feedback
                    }

                    if (action === 'add') {
                        if (type === 'goal') {
                            if (!currentPeriod) {
                                alert('Seleziona prima il tempo per registrare gli eventi!');
                                return;
                            }
                            const quarter = `${currentPeriod}°T`;
                            if (team === '1') {
                                showPlayerModal(quarter);
                            } else if (team === '2') {
                                addGoalTeam2(quarter);
                            }
                        } else if (type === 'corner') {
                            if (!currentPeriod) {
                                alert('Seleziona prima il tempo per registrare gli eventi!');
                                return;
                            }
                            if (team === '1') {
                                eventsByPeriod.team1.corners[currentPeriod.toString()]++;
                            } else if (team === '2') {
                                eventsByPeriod.team2.corners[currentPeriod.toString()]++;
                            }
                            updateStats();
                            // Show visual confirmation
                            showActionConfirmation('+');
                            // Salva automaticamente lo stato dopo ogni statistica
                            saveCurrentGameState();
                      } else if (type === 'shot') {
   			 if (!currentPeriod) {
        			alert('Seleziona prima il tempo per registrare gli eventi!');
        			return;
    }
    
    // --- MODIFICA QUI ---
    			if (team === '1') {
        // Invece di incrementare direttamente, apriamo il modale
        const quarter = `${currentPeriod}°T`;
        showShotPlayerModal(quarter);
    } else if (team === '2') {
        // Per la squadra 2 (avversaria) incrementiamo direttamente come prima
        eventsByPeriod.team2.shots[currentPeriod.toString()]++;
        updateStats();
        showActionConfirmation('+');
        saveCurrentGameState();
    }
    // --- FINE MODIFICA ---

                        } else if (type === 'foul') {
                            if (!currentPeriod) {
                                alert('Seleziona prima il tempo per registrare gli eventi!');
                                return;
                            }
                            if (team === '1') {
                                eventsByPeriod.team1.fouls[currentPeriod.toString()]++;
                            } else if (team === '2') {
                                eventsByPeriod.team2.fouls[currentPeriod.toString()]++;
                            }
                            updateStats();
                            // Show visual confirmation
                            showActionConfirmation('+');
                            // Salva automaticamente lo stato dopo ogni statistica
                            saveCurrentGameState();
                        } else if (type === 'yellow-card') {
                            if (!currentPeriod) {
                                alert('Seleziona prima il tempo per registrare gli eventi!');
                                return;
                            }
                            const quarter = `${currentPeriod}°T`;
                            if (team === '1') {
                                showCardPlayerModal('yellow', quarter);
                            } else if (team === '2') {
                                addCardTeam2('yellow', quarter);
                            }
                        } else if (type === 'red-card') {
                            if (!currentPeriod) {
                                alert('Seleziona prima il tempo per registrare gli eventi!');
                                return;
                            }
                            const quarter = `${currentPeriod}°T`;
                            if (team === '1') {
                                showCardPlayerModal('red', quarter);
                            } else if (team === '2') {
                                addCardTeam2('red', quarter);
                            }
                        }
                    } else if (action === 'remove') {
                        showRemoveModal(type, team);
                    }
                });
            });

            // Modal event listeners
            document.getElementById('cancel-player-selection-button').addEventListener('click', hidePlayerModal);
            document.getElementById('confirm-remove-button').addEventListener('click', confirmRemoval);
            document.getElementById('cancel-remove-button').addEventListener('click', hideRemoveModal);
            document.getElementById('reset-button').addEventListener('click', showResetModal);
            document.getElementById('confirm-reset-button').addEventListener('click', resetGame);
            document.getElementById('cancel-reset-button').addEventListener('click', hideResetModal);

            // History event listeners
            document.getElementById('show-history-button').addEventListener('click', showHistoryModal);
            document.getElementById('close-history-button').addEventListener('click', hideHistoryModal);
            
            // Month filter event listener
            document.getElementById('month-filter').addEventListener('change', async () => {
                await renderHistory();
            });

            // Delete match event listeners
            document.getElementById('confirm-delete-match-button').addEventListener('click', showPasswordDeleteModal);
            document.getElementById('cancel-delete-match-button').addEventListener('click', hideDeleteMatchModal);
            
            // Password delete match event listeners
            document.getElementById('confirm-password-delete-button').addEventListener('click', confirmPasswordDelete);
            document.getElementById('cancel-password-delete-button').addEventListener('click', cancelPasswordDelete);
            
            // Allow Enter key to submit password
            document.getElementById('delete-password-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmPasswordDelete();
                }
            });

            // Save and share functionality - separate buttons
            document.getElementById('save-button').addEventListener('click', async () => {
                if (saveButtonCooldownActive) {
                    // Show alert if user tries to save during cooldown
                    alert(`Puoi salvare una nuova partita tra ${saveCooldownSeconds} secondi. Aspetta per evitare duplicati.`);
                    vibrate([100, 50, 100]); // Warning feedback
                    return;
                }
                
                vibrate([50]); // Button feedback
                await saveMatch();
                alert('Partita salvata!');
            });

            document.getElementById('share-button').addEventListener('click', async () => {
                await saveMatch();
                await shareSingleMatch(); // Use the new reusable function
            });
        });

        // Preload audio on first user interaction
        document.addEventListener('click', () => {
            if (!fischioAudio) {
                fischioAudio = new Audio('./fischio.mp3');
            }
        });
        document.addEventListener('touchstart', () => {
            if (!fischioAudio) {
                fischioAudio = new Audio('./fischio.mp3');
            }
        });

        // Initialize Firebase connection check
        setTimeout(() => {
            // Simulate Firebase connection (will be replaced by actual Firebase logic)
            if (typeof window.onFirebaseReady === 'function') {
                window.onFirebaseReady();
            }
        }, 2000);
        
        // Handle page visibility changes to maintain wake lock and update timer
        // This ensures both wake lock reactivation and timer accuracy when returning from background
        document.addEventListener('visibilitychange', handleVisibilityChange);
        
        // Add event listener for notes field to auto-save
        document.addEventListener('input', (event) => {
            if (event.target.id === 'match-notes') {
                // Auto-save game state when notes change
                saveCurrentGameState();
            }
        });
        
        // Also handle window focus events as an additional safeguard for wake lock and timer
        window.addEventListener('focus', () => {
            console.log('🎯 Window gained focus - ensuring wake lock is active');
            
            // Re-request wake lock if supported
            if (wakeLockSupported || isWakeLockSupported()) {
                requestWakeLock();
            }
            
            // Update timer if running (existing functionality)
            if (typeof isRunning !== 'undefined' && isRunning) {
                updateTimerDisplay();
            }
        });
        
        // Handle page being unloaded/closed to clean up wake lock
        window.addEventListener('beforeunload', () => {
            console.log('🚪 Page unloading - releasing wake lock');
            releaseWakeLock();
        });
    </script>

    <!-- Service Worker Registration -->
    <!-- Best practice: use relative paths (without leading slash) for GitHub Pages compatibility -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.error('❌ Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
